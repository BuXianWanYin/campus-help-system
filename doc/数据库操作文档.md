# 校园帮助系统数据库操作文档

## 一、数据库连接规范

#### 1.2.1 连接数据库
在进行任何数据库操作之前，必须先调用 `mcp_mysql-campus_help_connect_db` 建立连接。 mcp名字叫mysql-campus_help   数据库名称是campus_help

**连接参数：**
- `host`: 数据库主机地址（默认：`localhost`）
- `user`: 数据库用户名（默认：`root`）
- `password`: 数据库密码
- `database`: 数据库名称（`campus_help`）

**连接示例：**
```javascript
mcp_mysql-campus_help_connect_db({
  host: "localhost",
  user: "root",
  password: "root",  // 或 "123456"，根据实际配置
  database: "campus_help"
})
```

**注意事项：**
- 每次会话开始时必须先建立连接
- 连接成功后，后续所有操作都通过MCP工具进行
- 如果连接失败，检查数据库服务是否启动、用户名密码是否正确

### 1.3 数据库操作工具

所有数据库操作通过以下MCP工具完成：

- **连接数据库**：`mcp_mysql-campus_help_connect_db`
- **查询数据**：`mcp_mysql-campus_help_query`（SELECT操作）
- **执行操作**：`mcp_mysql-campus_help_execute`（INSERT、UPDATE、DELETE操作）
- **列出表**：`mcp_mysql-campus_help_list_tables`
- **查看表结构**：`mcp_mysql-campus_help_describe_table`

## 二、建表规范

### 2.1 表命名规范
- 表名使用小写字母和下划线，如：`user_info`、`lost_found`、`order_info`
- 表名必须具有业务含义，清晰表达表的用途
- 表名使用单数形式，如：`user`而非`users`
- 关联表使用两个表名组合，如：`user_role`、`order_item`

### 2.2 字段命名规范
- 字段名使用小写字母和下划线，如：`user_id`、`create_time`、`delete_flag`
- 主键统一命名为`id`，类型为`BIGINT(20)`
- 外键命名为`关联表名_id`，如：`user_id`、`order_id`
- 布尔类型字段使用`is_`或`can_`前缀，如：`is_verified`、`can_accept_task`
- 时间字段统一使用`_time`后缀，如：`create_time`、`update_time`
- 逻辑删除字段统一命名为`delete_flag`，类型为`TINYINT(1)`

### 2.3 字段类型规范
- **主键**：`BIGINT(20) NOT NULL AUTO_INCREMENT`
- **字符串**：根据长度选择`VARCHAR(长度)`，如：`VARCHAR(50)`、`VARCHAR(200)`、`VARCHAR(255)`
- **文本**：长文本使用`TEXT`类型
- **数值**：整数使用`INT(11)`或`BIGINT(20)`，小数使用`DECIMAL(10,2)`
- **布尔**：使用`TINYINT(1)`，0表示false，1表示true
- **时间**：使用`DATETIME`类型
- **JSON**：存储JSON数据使用`TEXT`类型，在应用层解析

### 2.4 表注释规范
- **表必须有中文注释**：使用`COMMENT='表的中文说明'`
- **每个字段必须有中文注释**：使用`COMMENT='字段的中文说明'`
- 注释要清晰表达字段的业务含义和用途
- 枚举值字段要在注释中说明所有可能的值

**示例：**
```sql
CREATE TABLE `user_info` (
  `id` BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `username` VARCHAR(50) NOT NULL COMMENT '用户名（唯一）',
  `password` VARCHAR(255) NOT NULL COMMENT '密码（BCrypt加密）',
  `email` VARCHAR(100) NOT NULL COMMENT '邮箱（唯一）',
  `status` TINYINT(1) DEFAULT 1 COMMENT '状态：0-禁用，1-启用',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `delete_flag` TINYINT(1) DEFAULT 0 COMMENT '逻辑删除标志：0-未删除，1-已删除',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_username` (`username`),
  UNIQUE KEY `uk_email` (`email`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户信息表';
```

### 2.5 索引规范
- **主键索引**：每个表必须有主键，使用`PRIMARY KEY`
- **唯一索引**：唯一字段必须添加唯一索引，使用`UNIQUE KEY`
- **普通索引**：经常用于查询条件的字段添加普通索引，使用`KEY`或`INDEX`
- **外键索引**：外键字段自动创建索引
- **索引命名**：
  - 主键：`PRIMARY KEY`
  - 唯一索引：`uk_字段名`，如：`uk_username`
  - 普通索引：`idx_字段名`，如：`idx_user_id`、`idx_create_time`
  - 复合索引：`idx_字段1_字段2`，如：`idx_user_status`

### 2.6 外键规范
- 外键命名：`fk_当前表名_关联表名`，如：`fk_order_user`
- 外键字段：`关联表名_id`，如：`user_id`
- 外键约束：使用`FOREIGN KEY`和`REFERENCES`
- 删除策略：根据业务需求选择`ON DELETE CASCADE`或`ON DELETE RESTRICT`

### 2.7 默认值规范
- 时间字段：`create_time`使用`DEFAULT CURRENT_TIMESTAMP`，`update_time`使用`DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP`
- 逻辑删除：`delete_flag`默认值为`0`（未删除）
- 状态字段：根据业务设置合理的默认值
- 数值字段：根据业务设置合理的默认值，如：`credit_score`默认`100`

### 2.8 表结构规范
- **存储引擎**：统一使用`InnoDB`
- **字符集**：统一使用`utf8mb4`
- **排序规则**：统一使用`utf8mb4_general_ci`
- **必须字段**：每个表必须包含以下字段：
  - `id`：主键
  - `create_time`：创建时间
  - `update_time`：更新时间
  - `delete_flag`：逻辑删除标志

## 三、建表操作规范

### 3.1 使用MCP创建表

#### 3.1.1 创建表步骤
1. **连接数据库**：先调用`mcp_mysql-campus_help_connect_db`建立连接
2. **执行建表SQL**：使用`mcp_mysql-campus_help_execute`执行`CREATE TABLE`语句
3. **验证表结构**：使用`mcp_mysql-campus_help_describe_table`查看表结构

#### 3.1.2 建表示例
```sql
-- 创建用户信息表
CREATE TABLE `user_info` (
  `id` BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `username` VARCHAR(50) NOT NULL COMMENT '用户名（唯一，用于登录）',
  `password` VARCHAR(255) NOT NULL COMMENT '密码（BCrypt加密存储）',
  `nickname` VARCHAR(50) DEFAULT NULL COMMENT '昵称',
  `avatar` VARCHAR(255) DEFAULT NULL COMMENT '头像URL',
  `email` VARCHAR(100) NOT NULL COMMENT '邮箱（唯一，用于登录和找回密码）',
  `phone` VARCHAR(20) DEFAULT NULL COMMENT '手机号',
  `gender` TINYINT(1) DEFAULT 0 COMMENT '性别：0-未知，1-男，2-女',
  `grade` VARCHAR(20) DEFAULT NULL COMMENT '年级（如：2021级）',
  `major` VARCHAR(100) DEFAULT NULL COMMENT '专业',
  `real_name` VARCHAR(50) DEFAULT NULL COMMENT '真实姓名',
  `id_card` VARCHAR(18) DEFAULT NULL COMMENT '身份证号（用于实名认证）',
  `student_id` VARCHAR(50) DEFAULT NULL COMMENT '学号',
  `is_verified` TINYINT(1) DEFAULT 0 COMMENT '是否实名认证：0-未认证，1-已认证',
  `can_accept_task` TINYINT(1) DEFAULT 0 COMMENT '是否可以接单跑腿：0-不可接单，1-可接单（实名认证后自动设置为可接单）',
  `credit_score` INT(11) DEFAULT 100 COMMENT '信用积分（初始100分）',
  `credit_level` VARCHAR(20) DEFAULT '一般' COMMENT '信用等级：优秀、良好、一般、较差、差',
  `runner_level` VARCHAR(20) DEFAULT NULL COMMENT '跑腿员等级：新手、普通、优秀、金牌（仅可接单用户有）',
  `role` VARCHAR(20) DEFAULT 'USER' COMMENT '角色：USER-普通用户，ADMIN-管理员',
  `status` TINYINT(1) DEFAULT 1 COMMENT '账户状态：0-禁用，1-启用',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `delete_flag` TINYINT(1) DEFAULT 0 COMMENT '逻辑删除标志：0-未删除，1-已删除',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_username` (`username`),
  UNIQUE KEY `uk_email` (`email`),
  KEY `idx_phone` (`phone`),
  KEY `idx_student_id` (`student_id`),
  KEY `idx_create_time` (`create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户信息表';
```

**执行步骤：**
1. 连接数据库：`mcp_mysql-campus_help_connect_db`
2. 执行建表SQL：`mcp_mysql-campus_help_execute`

### 3.2 修改表结构

#### 3.2.1 添加字段
```sql
ALTER TABLE `user_info` 
ADD COLUMN `last_login_time` DATETIME DEFAULT NULL COMMENT '最后登录时间' AFTER `update_time`;
```


#### 3.2.2 修改字段
```sql
ALTER TABLE `user_info` 
MODIFY COLUMN `nickname` VARCHAR(100) DEFAULT NULL COMMENT '昵称（支持更长的昵称）';
```

#### 3.2.3 删除字段
```sql
ALTER TABLE `user_info` 
DROP COLUMN `old_field`;
```

#### 3.2.4 添加索引
```sql
ALTER TABLE `user_info` 
ADD INDEX `idx_nickname` (`nickname`);
```

#### 3.2.5 删除索引
```sql
ALTER TABLE `user_info` 
DROP INDEX `idx_nickname`;
```

### 3.3 删除表
```sql
DROP TABLE IF EXISTS `user_info`;
```


## 四、数据操作规范

### 4.1 查询操作（SELECT）

#### 4.1.1 查询数据
查询操作使用`mcp_mysql-campus_help_query`。

**基本查询：**
```javascript
// 查询所有用户
mcp_mysql-campus_help_query({
  sql: "SELECT * FROM user_info WHERE delete_flag = 0"
})

// 查询单个用户
mcp_mysql-campus_help_query({
  sql: "SELECT * FROM user_info WHERE id = ?",
  params: [1]
})

// 分页查询
mcp_mysql-campus_help_query({
  sql: "SELECT * FROM user_info WHERE delete_flag = 0 ORDER BY create_time DESC LIMIT ? OFFSET ?",
  params: [10, 0]
})
```

**查询规范：**
- 所有查询必须过滤`delete_flag = 0`（逻辑删除的数据不查询）
- 使用参数化查询防止SQL注入
- 查询结果按业务需求排序（通常按`create_time DESC`）
- 分页查询使用`LIMIT`和`OFFSET`

#### 4.1.2 常用查询示例
```javascript
// 1. 根据ID查询
mcp_mysql-campus_help_query({
  sql: "SELECT * FROM user_info WHERE id = ? AND delete_flag = 0",
  params: [userId]
})

// 2. 根据用户名查询
mcp_mysql-campus_help_query({
  sql: "SELECT * FROM user_info WHERE username = ? AND delete_flag = 0",
  params: [username]
})

// 3. 条件查询
mcp_mysql-campus_help_query({
  sql: "SELECT * FROM user_info WHERE status = ? AND is_verified = ? AND delete_flag = 0",
  params: [1, 1]
})

// 4. 模糊查询
mcp_mysql-campus_help_query({
  sql: "SELECT * FROM user_info WHERE nickname LIKE ? AND delete_flag = 0",
  params: [`%${keyword}%`]
})

// 5. 统计查询
mcp_mysql-campus_help_query({
  sql: "SELECT COUNT(*) as total FROM user_info WHERE delete_flag = 0"
})
```

### 4.2 新增操作（INSERT）

#### 4.2.1 新增数据
新增操作使用`mcp_mysql-campus_help_execute`。

**单条插入：**
```javascript
mcp_mysql-campus_help_execute({
  sql: "INSERT INTO user_info (username, password, email, nickname, create_time, update_time, delete_flag) VALUES (?, ?, ?, ?, NOW(), NOW(), 0)",
  params: ["testuser", "encrypted_password", "test@example.com", "测试用户"]
})
```

**批量插入：**
```javascript
// 批量插入需要使用事务或循环执行
// 方式1：使用事务（推荐）
mcp_mysql-campus_help_execute({
  sql: "START TRANSACTION"
})

// 执行多条INSERT
mcp_mysql-campus_help_execute({
  sql: "INSERT INTO user_info (username, password, email, create_time, update_time, delete_flag) VALUES (?, ?, ?, NOW(), NOW(), 0)",
  params: ["user1", "pwd1", "user1@example.com"]
})

mcp_mysql-campus_help_execute({
  sql: "INSERT INTO user_info (username, password, email, create_time, update_time, delete_flag) VALUES (?, ?, ?, NOW(), NOW(), 0)",
  params: ["user2", "pwd2", "user2@example.com"]
})

mcp_mysql-campus_help_execute({
  sql: "COMMIT"
})
```

#### 4.2.2 新增数据规范
- 必须设置`create_time`和`update_time`（可以使用`NOW()`或`CURRENT_TIMESTAMP`）
- `delete_flag`默认设置为`0`（未删除）
- 使用参数化查询防止SQL注入
- 插入前检查唯一约束（如：用户名、邮箱）

### 4.3 更新操作（UPDATE）

#### 4.3.1 更新数据
更新操作使用`mcp_mysql-campus_help_execute`。

**基本更新：**
```javascript
mcp_mysql-campus_help_execute({
  sql: "UPDATE user_info SET nickname = ?, update_time = NOW() WHERE id = ? AND delete_flag = 0",
  params: ["新昵称", userId]
})
```

**更新规范：**
- 所有更新必须更新`update_time`字段
- 必须添加`delete_flag = 0`条件（不更新已删除的数据）
- 必须添加`WHERE`条件，避免全表更新
- 使用参数化查询防止SQL注入

#### 4.3.2 常用更新示例
```javascript
// 1. 更新单个字段
mcp_mysql-campus_help_execute({
  sql: "UPDATE user_info SET nickname = ?, update_time = NOW() WHERE id = ? AND delete_flag = 0",
  params: ["新昵称", userId]
})

// 2. 更新多个字段
mcp_mysql-campus_help_execute({
  sql: "UPDATE user_info SET nickname = ?, email = ?, update_time = NOW() WHERE id = ? AND delete_flag = 0",
  params: ["新昵称", "newemail@example.com", userId]
})

// 3. 更新状态
mcp_mysql-campus_help_execute({
  sql: "UPDATE user_info SET status = ?, update_time = NOW() WHERE id = ? AND delete_flag = 0",
  params: [0, userId]
})

// 4. 条件更新
mcp_mysql-campus_help_execute({
  sql: "UPDATE user_info SET credit_score = credit_score + ? WHERE id = ? AND delete_flag = 0",
  params: [10, userId]
})
```

### 4.4 删除操作（DELETE）

#### 4.4.1 逻辑删除（推荐）
**本项目统一使用逻辑删除，不进行物理删除。**

```javascript
mcp_mysql-campus_help_execute({
  sql: "UPDATE user_info SET delete_flag = 1, update_time = NOW() WHERE id = ? AND delete_flag = 0",
  params: [userId]
})
```

#### 4.4.2 物理删除（不推荐）
**仅在特殊场景下使用物理删除，如：数据清理、测试数据清理等。**

```javascript
mcp_mysql-campus_help_execute({
  sql: "DELETE FROM user_info WHERE id = ?",
  params: [userId]
})
```

**删除规范：**
- 优先使用逻辑删除（设置`delete_flag = 1`）
- 物理删除前必须确认数据不再需要
- 删除操作必须添加`WHERE`条件，避免全表删除
- 使用参数化查询防止SQL注入

### 4.5 事务操作

#### 4.5.1 使用事务
对于需要保证数据一致性的操作，必须使用事务。

```javascript
// 开启事务
mcp_mysql-campus_help_execute({
  sql: "START TRANSACTION"
})

try {
  // 执行操作1
  mcp_mysql-campus_help_execute({
    sql: "INSERT INTO order_info (user_id, total_amount, create_time, update_time, delete_flag) VALUES (?, ?, NOW(), NOW(), 0)",
    params: [userId, amount]
  })
  
  // 执行操作2
  mcp_mysql-campus_help_execute({
    sql: "UPDATE user_info SET credit_score = credit_score + ? WHERE id = ? AND delete_flag = 0",
    params: [10, userId]
  })
  
  // 提交事务
  mcp_mysql-campus_help_execute({
    sql: "COMMIT"
  })
} catch (error) {
  // 回滚事务
  mcp_mysql-campus_help_execute({
    sql: "ROLLBACK"
  })
}
```

## 五、常用操作示例

### 5.1 查看表结构
```javascript
mcp_mysql-campus_help_describe_table({
  table: "user_info"
})
```

### 5.2 列出所有表
```javascript
mcp_mysql-campus_help_list_tables()
```

### 5.3 查看表数据
```javascript
mcp_mysql-campus_help_query({
  sql: "SELECT * FROM user_info WHERE delete_flag = 0 LIMIT 10"
})
```

### 5.4 统计表数据量
```javascript
mcp_mysql-campus_help_query({
  sql: "SELECT COUNT(*) as total FROM user_info WHERE delete_flag = 0"
})
```

### 5.5 清空表数据（测试环境）
```javascript
// 逻辑删除所有数据
mcp_mysql-campus_help_execute({
  sql: "UPDATE user_info SET delete_flag = 1, update_time = NOW()"
})

// 或物理删除（谨慎使用）
mcp_mysql-campus_help_execute({
  sql: "TRUNCATE TABLE user_info"
})
```

## 六、数据备份与恢复

### 6.1 数据备份
使用MySQL命令行工具进行备份：

```bash
# 备份整个数据库
mysqldump -u root -p campus_help > campus_help_backup.sql

# 备份指定表
mysqldump -u root -p campus_help user_info > user_info_backup.sql
```

### 6.2 数据恢复
```bash
# 恢复整个数据库
mysql -u root -p campus_help < campus_help_backup.sql

# 恢复指定表
mysql -u root -p campus_help < user_info_backup.sql
```

## 七、注意事项

### 7.1 安全规范
- **禁止直接拼接SQL**：所有SQL必须使用参数化查询
- **权限控制**：生产环境使用专用数据库用户，限制权限
- **密码安全**：数据库密码不能硬编码，使用配置文件或环境变量
- **SQL注入防护**：使用参数化查询，不信任用户输入

### 7.2 性能规范
- **索引优化**：经常查询的字段添加索引
- **查询优化**：避免`SELECT *`，只查询需要的字段
- **分页查询**：大数据量查询必须使用分页
- **批量操作**：批量操作使用事务，提高性能

### 7.3 数据一致性
- **外键约束**：使用外键保证数据完整性
- **事务处理**：相关操作使用事务保证一致性
- **乐观锁**：并发更新使用版本号（`version`字段）
- **逻辑删除**：统一使用逻辑删除，保证数据可追溯

### 7.4 开发规范
- **连接管理**：操作前先连接，操作后及时关闭（MCP自动管理）
- **错误处理**：所有操作必须处理异常情况
- **日志记录**：重要操作记录日志
- **数据验证**：插入和更新前验证数据合法性

## 八、数据库操作工具列表

- `mcp_mysql-campus_help_connect_db`：连接数据库
- `mcp_mysql-campus_help_query`：执行SELECT查询
- `mcp_mysql-campus_help_execute`：执行INSERT、UPDATE、DELETE、CREATE、ALTER等操作
- `mcp_mysql-campus_help_list_tables`：列出所有表
- `mcp_mysql-campus_help_describe_table`：查看表结构

## 九、总结

本文档涵盖了校园帮助系统数据库操作的核心规范，包括：
- 数据库连接方法（使用MCP工具）
- 建表规范（包含中文注释）
- 数据操作规范（增删改查）
- 事务处理规范
- 安全与性能规范

**重要提醒：**
1. 所有数据库操作必须先调用`mcp_mysql-campus_help_connect_db`建立连接
2. 所有表必须有中文注释，所有字段必须有中文注释
3. 统一使用逻辑删除（`delete_flag`），不进行物理删除
4. 所有SQL必须使用参数化查询，防止SQL注入
5. 相关操作使用事务保证数据一致性

开发团队应严格遵守本规范，确保数据库操作的安全性和一致性。

