# v2.0 数据库和后端更新说明

**更新日期：** 2024-01-02  
**更新版本：** v2.0  
**更新内容：** 移除信用分系统，完善用户表结构，创建管理员后台

---

## ✅ 已完成的更新

### 1. 数据库更新

#### 1.1 删除信用分相关字段

**删除的字段：**
- `credit_score` (INT) - 信用积分
- `credit_level` (VARCHAR) - 信用等级
- `runner_level` (VARCHAR) - 跑腿员等级

**执行SQL：**
```sql
ALTER TABLE `user` 
DROP COLUMN `credit_score`,
DROP COLUMN `credit_level`,
DROP COLUMN `runner_level`;
```

#### 1.2 添加v2.0版本要求的字段

**新增字段：**

**实名认证相关：**
- `phone` VARCHAR(20) - 手机号
- `user_type` VARCHAR(20) DEFAULT '学生' - 用户类型：学生、教师
- `verification_status` VARCHAR(20) DEFAULT 'NOT_VERIFIED' - 认证状态
- `verification_proof` TEXT - 认证证明文件（JSON数组）
- `verification_submit_time` DATETIME - 认证提交时间
- `verification_audit_time` DATETIME - 认证审核时间
- `verification_audit_reason` VARCHAR(500) - 认证拒绝原因
- `verification_audit_admin_id` BIGINT(20) - 审核管理员ID

**账号封禁相关：**
- `ban_type` VARCHAR(20) - 封禁类型：TEMPORARY-临时，PERMANENT-永久
- `ban_reason` VARCHAR(500) - 封禁原因
- `ban_days` INT(11) - 封禁天数
- `ban_time` DATETIME - 封禁时间
- `unban_time` DATETIME - 解封时间
- `ban_admin_id` BIGINT(20) - 封禁操作管理员ID

**字段状态更新：**
- `status` 注释更新为：1-正常，2-已封禁

**执行SQL：**
```sql
-- 添加实名认证相关字段
ALTER TABLE `user` 
ADD COLUMN `phone` VARCHAR(20) DEFAULT NULL COMMENT '手机号' AFTER `major`,
ADD COLUMN `user_type` VARCHAR(20) DEFAULT '学生' COMMENT '用户类型：学生、教师' AFTER `student_id`,
ADD COLUMN `verification_status` VARCHAR(20) DEFAULT 'NOT_VERIFIED' COMMENT '认证状态：NOT_VERIFIED、PENDING、VERIFIED、REJECTED' AFTER `is_verified`,
ADD COLUMN `verification_proof` TEXT DEFAULT NULL COMMENT '认证证明文件（JSON数组）' AFTER `verification_status`,
ADD COLUMN `verification_submit_time` DATETIME DEFAULT NULL COMMENT '认证提交时间' AFTER `verification_proof`,
ADD COLUMN `verification_audit_time` DATETIME DEFAULT NULL COMMENT '认证审核时间' AFTER `verification_submit_time`,
ADD COLUMN `verification_audit_reason` VARCHAR(500) DEFAULT NULL COMMENT '认证拒绝原因' AFTER `verification_audit_time`,
ADD COLUMN `verification_audit_admin_id` BIGINT(20) DEFAULT NULL COMMENT '审核管理员ID' AFTER `verification_audit_reason`;

-- 添加账号封禁相关字段
ALTER TABLE `user` 
MODIFY COLUMN `status` TINYINT(1) DEFAULT 1 COMMENT '账号状态：1-正常，2-已封禁',
ADD COLUMN `ban_type` VARCHAR(20) DEFAULT NULL COMMENT '封禁类型：TEMPORARY-临时，PERMANENT-永久' AFTER `status`,
ADD COLUMN `ban_reason` VARCHAR(500) DEFAULT NULL COMMENT '封禁原因' AFTER `ban_type`,
ADD COLUMN `ban_days` INT(11) DEFAULT NULL COMMENT '封禁天数' AFTER `ban_reason`,
ADD COLUMN `ban_time` DATETIME DEFAULT NULL COMMENT '封禁时间' AFTER `ban_days`,
ADD COLUMN `unban_time` DATETIME DEFAULT NULL COMMENT '解封时间' AFTER `ban_time`,
ADD COLUMN `ban_admin_id` BIGINT(20) DEFAULT NULL COMMENT '封禁操作管理员ID' AFTER `unban_time`;

-- 添加索引
ALTER TABLE `user` 
ADD INDEX `idx_is_verified` (`is_verified`),
ADD INDEX `idx_role` (`role`),
ADD INDEX `idx_status` (`status`);
```

---

### 2. 后端代码更新

#### 2.1 User实体类更新

**删除的字段：**
- `creditScore` (Integer)
- `creditLevel` (String)
- `runnerLevel` (String)

**新增的字段：**
- `phone` (String) - 手机号
- `userType` (String) - 用户类型
- `verificationStatus` (String) - 认证状态
- `verificationProof` (String) - 认证证明文件
- `verificationSubmitTime` (LocalDateTime) - 认证提交时间
- `verificationAuditTime` (LocalDateTime) - 认证审核时间
- `verificationAuditReason` (String) - 认证拒绝原因
- `verificationAuditAdminId` (Long) - 审核管理员ID
- `banType` (String) - 封禁类型
- `banReason` (String) - 封禁原因
- `banDays` (Integer) - 封禁天数
- `banTime` (LocalDateTime) - 封禁时间
- `unbanTime` (LocalDateTime) - 解封时间
- `banAdminId` (Long) - 封禁操作管理员ID

**更新的字段：**
- `status` 注释更新为：账号状态：1-正常，2-已封禁

#### 2.2 UserServiceImpl更新

**删除的逻辑：**
- `register()` 方法中删除 `creditScore` 和 `creditLevel` 的默认值设置
- 删除 `updateCreditLevel()` 方法
- `auditVerification()` 方法中删除信用分增加逻辑

**新增的逻辑：**
- `register()` 方法中添加 `verificationStatus` 和 `userType` 的默认值设置
- `submitVerification()` 方法中添加 `verificationStatus` 和 `verificationSubmitTime` 的设置
- `auditVerification()` 方法中：
  - 添加 `verificationStatus` 的设置（VERIFIED/REJECTED）
  - 添加 `verificationAuditTime` 和 `verificationAuditAdminId` 的设置
  - 审核拒绝时设置 `verificationAuditReason`
- 新增 `getCurrentAdminId()` 方法，用于获取当前管理员ID

**更新的逻辑：**
- `login()` 方法中更新状态检查逻辑（1-正常，2-已封禁）

#### 2.3 创建AdminController

**新增文件：**
- `campus-help-server/src/main/java/com/server/campushelpserver/controller/admin/AdminController.java`

**实现的功能：**

1. **获取待审核的实名认证列表**
   - 接口：`GET /api/admin/verification/pending`
   - 功能：分页查询待审核的实名认证申请（verification_status = 'PENDING'）
   - 权限：需要管理员权限

2. **封禁用户**
   - 接口：`POST /api/admin/user/ban`
   - 功能：管理员封禁违规用户
   - 参数：
     - `userId` (Long) - 用户ID
     - `banType` (String) - 封禁类型：TEMPORARY-临时，PERMANENT-永久
     - `reason` (String) - 封禁原因
     - `banDays` (Integer) - 封禁天数（临时封禁时必填）
   - 权限：需要管理员权限
   - 限制：不能封禁管理员

3. **解封用户**
   - 接口：`POST /api/admin/user/unban/{userId}`
   - 功能：管理员解封被封禁的用户
   - 权限：需要管理员权限

**权限控制：**
- 所有接口使用 `@PreAuthorize("hasAuthority('ADMIN')")` 进行权限控制
- 类级别也添加了 `@PreAuthorize("hasAuthority('ADMIN')")` 注解

---

## 📋 第二阶段功能实现状态

### ✅ 已完成的功能

1. **用户注册登录** ✅
   - 邮箱验证码注册
   - 邮箱密码登录
   - JWT Token认证

2. **用户信息管理** ✅
   - 获取当前用户信息
   - 更新用户信息
   - 分页查询用户列表（管理员）

3. **实名认证功能** ✅
   - 用户提交实名认证（`POST /api/user/verification/submit`）
   - 管理员审核实名认证（`POST /api/user/verification/audit`）
   - 认证状态管理（NOT_VERIFIED、PENDING、VERIFIED、REJECTED）

4. **权限验证** ✅
   - Spring Security + JWT
   - 管理员权限控制（`@PreAuthorize("hasAuthority('ADMIN')")`）

5. **管理员后台（部分）** ✅
   - 实名认证审核列表（`GET /api/admin/verification/pending`）
   - 用户封禁功能（`POST /api/admin/user/ban`）
   - 用户解封功能（`POST /api/admin/user/unban/{userId}`）

### ⏳ 待实现的功能

1. **管理员后台（完整）**
   - 数据概览页面
   - 信息审核（失物招领、闲置交易、跑腿服务）
   - 内容管理（下架功能）
   - 数据统计
   - 系统配置
   - 系统公告

2. **内容审核功能**
   - 失物招领审核
   - 闲置交易审核
   - 跑腿服务审核
   - 智能审核机制（敏感词过滤）

3. **内容管理功能**
   - 失物招领下架
   - 闲置交易下架
   - 跑腿服务下架

---

## 🔍 验证结果

### 数据库验证

**执行验证：**
```sql
DESCRIBE `user`;
```

**验证结果：** ✅
- 信用分相关字段已删除
- v2.0版本要求的字段已全部添加
- 索引已正确创建

### 后端代码验证

**验证项：**
- ✅ User实体类已更新，删除信用分字段，添加v2.0字段
- ✅ UserServiceImpl已更新，删除信用分逻辑
- ✅ AdminController已创建，实现管理员后台基础功能
- ✅ 代码编译无错误

---

## 📝 后续工作建议

### 优先级1：完善管理员后台

1. **实现内容审核功能**
   - 失物招领审核列表和审核接口
   - 闲置交易审核列表和审核接口
   - 跑腿服务审核列表和审核接口

2. **实现内容管理功能**
   - 失物招领下架接口
   - 闲置交易下架接口
   - 跑腿服务下架接口

3. **实现智能审核机制**
   - 敏感词过滤（AC自动机/DFA算法）
   - 自动审核逻辑
   - 人工审核触发条件

### 优先级2：开发核心业务模块

1. **失物招领模块**（第三阶段）
   - 失物发布
   - 失物浏览搜索
   - 认领功能

2. **闲置交易模块**（第四阶段）
   - 商品发布
   - 商品浏览搜索
   - 订单管理

3. **跑腿服务模块**（第五阶段）
   - 任务发布
   - 任务浏览搜索
   - 接单功能

---

## 🎯 总结

### 已完成

✅ **数据库更新**
- 删除信用分相关字段（3个）
- 添加v2.0版本要求的字段（13个）
- 更新字段注释和索引

✅ **后端代码更新**
- 更新User实体类
- 更新UserServiceImpl业务逻辑
- 创建AdminController管理员后台

✅ **功能实现**
- 第二阶段核心功能已实现
- 管理员后台基础功能已实现

### 待完成

⏳ **管理员后台完整功能**
- 内容审核功能
- 内容管理功能
- 数据统计功能

⏳ **核心业务模块**
- 失物招领模块
- 闲置交易模块
- 跑腿服务模块

---

**更新完成时间：** 2024-01-02  
**文档版本：** v1.0  
**维护人员：** 开发团队

