# æ ¡å›­äº’åŠ©ç³»ç»Ÿ - åŠŸèƒ½å¼€å‘éœ€æ±‚æ–‡æ¡£

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v2.1  
**åˆ›å»ºæ—¥æœŸï¼š** 2024-01-01  
**æœ€è¿‘æ›´æ–°ï¼š** 2024-01-02  
**æ–‡æ¡£ç»´æŠ¤ï¼š** å¼€å‘å›¢é˜Ÿ

---

## ğŸ“‹ ç‰ˆæœ¬è¯´æ˜

### v2.1 (2024-01-02) - æ•°æ®åº“å®Œå–„ç‰ˆ
- âœ… è¡¥å……å®Œæ•´çš„æ•°æ®åº“è¡¨è®¾è®¡ï¼ˆ14å¼ æ ¸å¿ƒè¡¨ï¼‰
- âœ… æ–°å¢ç»Ÿè®¡å­—æ®µï¼šview_countã€favorite_countã€comment_count
- âœ… å®Œå–„ç´¢å¼•è®¾è®¡ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½
- âœ… éªŒè¯ MainLayout.vue æ•°æ®æ”¯æŒå®Œæ•´æ€§
- âœ… æ‰€æœ‰åŠŸèƒ½æ¨¡å—æ•°æ®åº“å­—æ®µå®Œå…¨è¦†ç›–

### v2.0 (2024-01-02) - ç®€åŒ–ç‰ˆ
- âœ… ç®€åŒ–åŠŸèƒ½ï¼Œèšç„¦æ ¸å¿ƒéœ€æ±‚
- âœ… ç§»é™¤ä¿¡ç”¨åˆ†ç³»ç»Ÿï¼ˆç®€åŒ–è¯„ä»·ä½“ç³»ï¼‰
- âœ… ä¿ç•™æ™ºèƒ½å®¡æ ¸æœºåˆ¶ï¼ˆè‡ªåŠ¨å®¡æ ¸ + äººå·¥å®¡æ ¸ï¼‰
- âœ… ä¿ç•™ç®¡ç†å‘˜å†…å®¹ç®¡ç†å’Œè´¦å·ç®¡ç†åŠŸèƒ½
- âœ… æ˜ç¡®å®åè®¤è¯æƒé™æ§åˆ¶
- âœ… è¡¥å……è¯¦ç»†çš„åŠŸèƒ½å®ç°è¯´æ˜
- âœ… æ•´åˆæ‰€æœ‰æ–‡æ¡£å†…å®¹åˆ°ä¸€ä¸ªæ–‡ä»¶

**ç®€åŒ–åŸåˆ™ï¼š**
- èšç„¦å¤±ç‰©æ‹›é¢†ã€é—²ç½®äº¤æ˜“ã€è·‘è…¿æœåŠ¡ä¸‰å¤§æ ¸å¿ƒåŠŸèƒ½
- ä¿ç•™å¿…è¦çš„å®¡æ ¸å’Œç®¡ç†åŠŸèƒ½
- ç®€åŒ–ç”¨æˆ·æƒé™å’Œè¯„ä»·ä½“ç³»
- ç¡®ä¿ç³»ç»Ÿç®€æ´æ˜“ç”¨ï¼Œä¾¿äºå¼€å‘å’Œç»´æŠ¤

---

## ä¸€ã€é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®èƒŒæ™¯

**å›½å¤–ç ”ç©¶ç°çŠ¶ï¼š**

åœ¨å›½å¤–ï¼Œæ ¡å›­äº’åŠ©ç±»æ•°å­—åŒ–æœåŠ¡å‘å±•è¾ƒæ—©ï¼Œå‘ˆç°å¤šå…ƒåŒ–ç‰¹ç‚¹ã€‚ä¾‹å¦‚ï¼š
- **Facebook Campus**ï¼šå­¦ç”Ÿå¯ç»„å»ºå­¦ä¹ å°ç»„ã€å‘å¸ƒäºŒæ‰‹ç‰©å“äº¤æ˜“ã€å¯»æ‰¾å¤±ç‰©æ‹›é¢†çº¿ç´¢ï¼Œä¾æ‰˜ç¤¾äº¤å¹³å°å¿«é€Ÿä¼ æ’­ï¼Œä½†åŠŸèƒ½è¾ƒä¸ºåˆ†æ•£ï¼Œç¼ºä¹ä¸“é—¨çš„æ•´åˆæ€§äº’åŠ©ç³»ç»Ÿè®¾è®¡
- **Nextdoor**ï¼šè™½ä»¥ç¤¾åŒºä¸ºæœåŠ¡èŒƒå›´ï¼Œä½†å…¶ä¸­é’ˆå¯¹æ ¡å›­åŒºåŸŸçš„å­æ¿å—ï¼Œå…è®¸å­¦ç”Ÿå‘å¸ƒäº’åŠ©éœ€æ±‚ï¼ˆå¦‚å­¦ä¹ è¾…å¯¼ã€ç‰©å“å€Ÿç”¨ï¼‰ï¼Œå…¶åŸºäºåœ°ç†ä½ç½®çš„ä¿¡æ¯æ¨é€æ¨¡å¼ï¼Œä¸ºæ ¡å›­äº’åŠ©ç³»ç»Ÿåœ¨ç²¾å‡†è§¦è¾¾ç”¨æˆ·æ–¹é¢æä¾›äº†å‚è€ƒ

**å›½å†…ç ”ç©¶ç°çŠ¶ï¼š**

åœ¨å›½å†…ï¼Œæ ¡å›­äº’åŠ©ç±»ç³»ç»Ÿçš„ç ”ç©¶ä¸åº”ç”¨å¤„äºå¿«é€Ÿå‘å±•é˜¶æ®µï¼š
- **æ ¡å›­äºŒæ‰‹äº¤æ˜“å¹³å°**ï¼šéƒ¨åˆ†é«˜æ ¡è‡ªä¸»å¼€å‘äº†æ ¡å›­äºŒæ‰‹äº¤æ˜“å¹³å°ï¼Œä¸“æ³¨äºé—²ç½®ç‰©å“çš„æµè½¬ï¼ŒåŠŸèƒ½æ¶µç›–ç‰©å“å‘å¸ƒã€åœ¨çº¿è®®ä»·ç­‰ï¼Œè§£å†³äº†æ ¡å›­å†…é—²ç½®èµ„æºæµªè´¹çš„é—®é¢˜ï¼Œä½†ä»…èšç„¦å•ä¸€åœºæ™¯ï¼Œæœªæ•´åˆå¤±ç‰©æ‹›é¢†ç­‰éœ€æ±‚
- **æ ¡å›­å¤±ç‰©æ‹›é¢†å°ç¨‹åº**ï¼ˆå¦‚"æ ¡å›­æ‹¾ç‰©"ç±»å·¥å…·ï¼‰ï¼šåœ¨å¤šä¸ªé«˜æ ¡æ¨å¹¿ï¼Œç”¨æˆ·å¯å¿«é€Ÿå‘å¸ƒå’ŒæŸ¥è¯¢å¤±ç‰©ä¿¡æ¯ï¼Œéƒ¨åˆ†å°ç¨‹åºè¿˜æ”¯æŒç‰©å“ç‰¹å¾æ‹ç…§è¯†åˆ«ï¼Œä½†ä¸å…¶ä»–æ ¡å›­æœåŠ¡çš„è”åŠ¨æ€§ä¸è¶³
- **è¯¾ç¨‹ç­”ç–‘ç³»ç»Ÿ**ï¼šä¸€äº›é«˜æ ¡å¹³å°ä¸ºå­¦ç”Ÿæä¾›äº†è¯¾ç¨‹èµ„æºå…±äº«ã€å­¦ä¹ ç»„é˜ŸåŠŸèƒ½ï¼ŒåŠ©åŠ›å­¦ä¹ åä½œï¼Œä½†è¦†ç›–çš„æ ¡å›­äº’åŠ©åœºæ™¯æœ‰é™ï¼Œå°šæœªå½¢æˆç»¼åˆåŒ–çš„æ ¡å›­äº’åŠ©ç”Ÿæ€

**å­˜åœ¨é—®é¢˜ï¼š**
- ä¿¡æ¯åˆ†æ•£ï¼Œç¼ºä¹ç»Ÿä¸€å¹³å°
- åŠŸèƒ½å•ä¸€ï¼Œæœªæ•´åˆå¤šç§äº’åŠ©åœºæ™¯
- ç”¨æˆ·ä½“éªŒæœ‰å¾…æå‡

### 1.2 é¡¹ç›®ç›®æ ‡

æœ¬é¡¹ç›®æ—¨åœ¨è®¾è®¡å¹¶å®ç°ä¸€ä¸ªåŸºäº **Spring Boot + Vue** çš„æ ¡å›­å¸®ç³»ç»Ÿï¼Œé€šè¿‡è¯¥ç³»ç»Ÿå®ç°å¯¹**å¤±ç‰©æ‹›é¢†ã€é—²ç½®äº¤æ˜“ã€è·‘è…¿æœåŠ¡**ç­‰æ ¡å›­äº’åŠ©åœºæ™¯çš„ç»Ÿä¸€ç®¡ç†ã€‚ç³»ç»Ÿå°†æœåŠ¡äºé«˜æ ¡å¸ˆç”Ÿï¼Œæä¾›ä¸€ä¸ªå…¨é¢ã€ä¾¿æ·ã€å®‰å…¨çš„æ ¡å›­äº’åŠ©å¹³å°ï¼Œè§£å†³ä¼ ç»Ÿäº’åŠ©æ¸ é“ä¿¡æ¯åˆ†æ•£ã€æ•ˆç‡ä½çš„é—®é¢˜ã€‚

**æ ¸å¿ƒç›®æ ‡ï¼š**
1. æ•´åˆæ ¡å›­å†…å„ç±»äº’åŠ©æœåŠ¡ï¼Œæä¾›ç»Ÿä¸€çš„ä¿¡æ¯å‘å¸ƒå’Œç®¡ç†å¹³å°
2. æé«˜æ ¡å›­äº’åŠ©æœåŠ¡çš„æ•ˆç‡å’Œç”¨æˆ·ä½“éªŒ
3. å®ç°æ™ºèƒ½å®¡æ ¸æœºåˆ¶ï¼Œä¿éšœä¿¡æ¯å®‰å…¨
4. å®ç°å®æ—¶æ¶ˆæ¯é€šçŸ¥ï¼Œæå‡ç”¨æˆ·å‚ä¸åº¦
5. æä¾›ç®€æ´çš„ç®¡ç†åå°ï¼Œæ”¯æŒå†…å®¹å’Œç”¨æˆ·ç®¡ç†

### 1.3 æŠ€æœ¯æ¶æ„

**åç«¯æŠ€æœ¯ï¼š**
- **Spring Boot 2.7.18**ï¼šé‡‡ç”¨ Spring Boot æ­å»ºé¡¹ç›®åŸºç¡€æ¡†æ¶ï¼Œåˆ©ç”¨å…¶è‡ªåŠ¨åŒ–é…ç½®ã€ä¸€é”®å¯åŠ¨ç‰¹æ€§ï¼Œç®€åŒ–å¼€å‘æµç¨‹ï¼Œç¼©çŸ­é¡¹ç›®å‘¨æœŸ
- **MyBatis-Plus 3.5.3**ï¼šæ•°æ®åº“æ“ä½œæ¡†æ¶ï¼Œç®€åŒ– CRUD æ“ä½œ
- **Spring Security + JWT**ï¼šç”¨æˆ·è®¤è¯å’Œæˆæƒ
- **Redis**ï¼šç¼“å­˜å’Œä¼šè¯ç®¡ç†ï¼Œæå‡ç³»ç»Ÿæ€§èƒ½
- **MySQL 8.0**ï¼šé€‰ç”¨ MySQL ä½œä¸ºæ•°æ®åº“ï¼Œä¾æ‰˜å…¶æˆç†Ÿç¨³å®šçš„ç‰¹æ€§ï¼Œä¿éšœç”¨æˆ·ä¿¡æ¯ã€éœ€æ±‚æ•°æ®çš„å®‰å…¨å­˜å‚¨ï¼ŒåŒæ—¶é€šè¿‡ç´¢å¼•ä¼˜åŒ–æå‡æ•°æ®æŸ¥è¯¢æ€§èƒ½
- **WebSocket**ï¼šå®æ—¶æ¶ˆæ¯æ¨é€
- **Spring Mail**ï¼šé‚®ä»¶é€šçŸ¥åŠŸèƒ½

**å‰ç«¯æŠ€æœ¯ï¼š**
- **Vue 3.x**ï¼šVueèƒ½å¤Ÿæ„å»ºä¸€ä¸ªå“åº”å¼çš„ç”¨æˆ·ç•Œé¢ï¼Œå…¶æ¸è¿›å¼ç‰¹æ€§å…è®¸æŒ‰éœ€é€‰æ‹©æ‰€éœ€åŠŸèƒ½ã€‚è½»é‡çº§ä¸é«˜æ•ˆï¼Œæ˜“äºç»´æŠ¤
- **Vite**ï¼šå¿«é€Ÿçš„å‰ç«¯æ„å»ºå·¥å…·
- **Element Plus**ï¼šUI ç»„ä»¶åº“ï¼Œæä¾›ä¸°å¯Œçš„ç»„ä»¶
- **Pinia**ï¼šçŠ¶æ€ç®¡ç†åº“
- **Vue Router**ï¼šè·¯ç”±ç®¡ç†ï¼Œå®ç°å•é¡µåº”ç”¨
- **Axios**ï¼šHTTP è¯·æ±‚åº“
- **WebSocket å®¢æˆ·ç«¯**ï¼šå®æ—¶æ¶ˆæ¯æ¥æ”¶

**æŠ€æœ¯å¯è¡Œæ€§åˆ†æï¼š**

æœ¬ç³»ç»Ÿé‡‡ç”¨ Spring Boot ä½œä¸ºåç«¯å¼€å‘æ¡†æ¶ï¼Œæ­é… Vue æ„å»ºå‰ç«¯ç•Œé¢ï¼Œä»¥ MySQL ä½œä¸ºæ•°æ®å­˜å‚¨æ–¹æ¡ˆã€‚ä¸‰è€…å‡ä¸ºæˆç†Ÿä¸”å¹¿æ³›åº”ç”¨çš„æŠ€æœ¯ï¼Œå­¦ä¹ èµ„æ–™ä¸°å¯Œï¼Œé€‚é…å¤§å­¦ç”Ÿçš„æŠ€æœ¯æŒæ¡èŒƒå›´ã€‚

- **åç«¯**ï¼šé€šè¿‡ Spring Boot å¯å¿«é€Ÿæ­å»ºé¡¹ç›®æ¡†æ¶ï¼Œç®€åŒ–é…ç½®æµç¨‹ï¼Œé«˜æ•ˆå¤„ç†ç”¨æˆ·ç®¡ç†ã€éœ€æ±‚å‘å¸ƒç­‰æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
- **å‰ç«¯**ï¼šå€ŸåŠ© Vue çš„è½»é‡ç‰¹æ€§ï¼Œèƒ½é«˜æ•ˆæ„å»ºç¬¦åˆæ ¡å›­åœºæ™¯çš„ç®€æ´ç•Œé¢ï¼Œé€‚é… PC ç«¯æ“ä½œéœ€æ±‚
- **æ•°æ®åº“**ï¼šMySQL çš„ç¨³å®šæ€§å¯æ»¡è¶³ç³»ç»Ÿæ•°æ®å­˜å‚¨éœ€æ±‚ï¼Œæ”¯æŒæ•°æ®çš„å®‰å…¨å­˜å‚¨ä¸é«˜æ•ˆæŸ¥è¯¢

æ•´ä½“æŠ€æœ¯æ ˆæ— éœ€å¤æ‚çš„æŠ€æœ¯çªç ´ï¼Œå¼€å‘éš¾åº¦å¯æ§ï¼Œé€‚åˆç‹¬ç«‹æˆ–å°å›¢é˜Ÿå®Œæˆã€‚

---

## äºŒã€åŠŸèƒ½æ¨¡å—è¯¦ç»†è¯´æ˜

### 2.1 ç”¨æˆ·ç®¡ç†æ¨¡å—

#### 2.1.1 ç”¨æˆ·æ³¨å†Œä¸ç™»å½•

**æ³¨å†ŒåŠŸèƒ½è¯¦ç»†å®ç°ï¼š**

1. **æ³¨å†Œé¡µé¢å¸ƒå±€**
   - é‚®ç®±è¾“å…¥æ¡†ï¼ˆå¿…å¡«ï¼‰
   - é‚®ç®±éªŒè¯ç è¾“å…¥æ¡†ï¼ˆå¿…å¡«ï¼‰
   - è·å–éªŒè¯ç æŒ‰é’®ï¼ˆ60ç§’å€’è®¡æ—¶ï¼‰
   - å¯†ç è¾“å…¥æ¡†ï¼ˆå¿…å¡«ï¼Œå¯†ç å¼ºåº¦æç¤ºï¼‰
   - ç¡®è®¤å¯†ç è¾“å…¥æ¡†ï¼ˆå¿…å¡«ï¼‰
   - ç”¨æˆ·åè®®å¤é€‰æ¡†ï¼ˆå¿…å¡«ï¼‰
   - æ³¨å†ŒæŒ‰é’®

2. **æ³¨å†Œæµç¨‹**
   ```
   ç”¨æˆ·è¾“å…¥é‚®ç®±
       â†“
   ç‚¹å‡»"è·å–éªŒè¯ç "
       â†“
   ç³»ç»ŸéªŒè¯é‚®ç®±æ ¼å¼
       â†“
   ç³»ç»Ÿæ£€æŸ¥é‚®ç®±æ˜¯å¦å·²æ³¨å†Œ
       â†“
   ç”Ÿæˆ6ä½æ•°å­—éªŒè¯ç 
       â†“
   å‘é€é‚®ä»¶ï¼ˆä½¿ç”¨ Spring Mailï¼‰
       â†“
   Redis å­˜å‚¨éªŒè¯ç ï¼ˆæœ‰æ•ˆæœŸ5åˆ†é’Ÿï¼‰
       â†“
   ç”¨æˆ·è¾“å…¥éªŒè¯ç å’Œå¯†ç 
       â†“
   å‰ç«¯éªŒè¯ï¼š
       - éªŒè¯ç ä¸èƒ½ä¸ºç©º
       - å¯†ç é•¿åº¦è‡³å°‘8ä½
       - å¯†ç å¿…é¡»åŒ…å«å­—æ¯å’Œæ•°å­—
       - ä¸¤æ¬¡å¯†ç è¾“å…¥å¿…é¡»ä¸€è‡´
       - å¿…é¡»åŒæ„ç”¨æˆ·åè®®
       â†“
   æäº¤æ³¨å†Œè¯·æ±‚
       â†“
   åç«¯éªŒè¯ï¼š
       - éªŒè¯ç æ˜¯å¦æ­£ç¡®ï¼ˆä» Redis è·å–ï¼‰
       - éªŒè¯ç æ˜¯å¦è¿‡æœŸ
       - é‚®ç®±æ˜¯å¦å·²è¢«æ³¨å†Œ
       - å¯†ç å¼ºåº¦æ˜¯å¦ç¬¦åˆè¦æ±‚
       â†“
   å¯†ç åŠ å¯†ï¼ˆBCryptï¼‰
       â†“
   ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°æ•°æ®åº“
       â†“
   è¿”å›æ³¨å†ŒæˆåŠŸ
       â†“
   è‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µé¢
   ```

3. **åç«¯å®ç°ç¤ºä¾‹**
   ```java
   @Service
   public class UserService {
       
       @Autowired
       private RedisTemplate<String, String> redisTemplate;
       
       @Autowired
       private JavaMailSender mailSender;
       
       @Autowired
       private UserMapper userMapper;
       
       /**
        * å‘é€é‚®ç®±éªŒè¯ç 
        */
       public void sendEmailCode(String email) {
           // 1. éªŒè¯é‚®ç®±æ ¼å¼
           if (!email.matches("^[A-Za-z0-9+_.-]+@(.+)$")) {
               throw new BusinessException("é‚®ç®±æ ¼å¼ä¸æ­£ç¡®");
           }
           
           // 2. æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²æ³¨å†Œ
           User existUser = userMapper.selectByEmail(email);
           if (existUser != null) {
               throw new BusinessException("è¯¥é‚®ç®±å·²è¢«æ³¨å†Œ");
           }
           
           // 3. ç”Ÿæˆ6ä½æ•°å­—éªŒè¯ç 
           String code = String.format("%06d", new Random().nextInt(999999));
           
           // 4. å­˜å‚¨åˆ° Redisï¼ˆæœ‰æ•ˆæœŸ5åˆ†é’Ÿï¼‰
           String key = "email:code:" + email;
           redisTemplate.opsForValue().set(key, code, 5, TimeUnit.MINUTES);
           
           // 5. å‘é€é‚®ä»¶
           SimpleMailMessage message = new SimpleMailMessage();
           message.setTo(email);
           message.setSubject("æ ¡å›­äº’åŠ©ç³»ç»Ÿ - æ³¨å†ŒéªŒè¯ç ");
           message.setText("æ‚¨çš„éªŒè¯ç æ˜¯ï¼š" + code + "ï¼Œæœ‰æ•ˆæœŸ5åˆ†é’Ÿï¼Œè¯·å‹¿æ³„éœ²ç»™ä»–äººã€‚");
           mailSender.send(message);
       }
       
       /**
        * ç”¨æˆ·æ³¨å†Œ
        */
       @Transactional
       public void register(RegisterDTO dto) {
           // 1. éªŒè¯éªŒè¯ç 
           String key = "email:code:" + dto.getEmail();
           String cachedCode = redisTemplate.opsForValue().get(key);
           if (cachedCode == null) {
               throw new BusinessException("éªŒè¯ç å·²è¿‡æœŸï¼Œè¯·é‡æ–°è·å–");
           }
           if (!cachedCode.equals(dto.getCode())) {
               throw new BusinessException("éªŒè¯ç é”™è¯¯");
           }
           
           // 2. æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²æ³¨å†Œ
           User existUser = userMapper.selectByEmail(dto.getEmail());
           if (existUser != null) {
               throw new BusinessException("è¯¥é‚®ç®±å·²è¢«æ³¨å†Œ");
           }
           
           // 3. éªŒè¯å¯†ç å¼ºåº¦
           if (!dto.getPassword().matches("^(?=.*[A-Za-z])(?=.*\\d)[A-Za-z\\d]{8,}$")) {
               throw new BusinessException("å¯†ç å¿…é¡»è‡³å°‘8ä½ï¼ŒåŒ…å«å­—æ¯å’Œæ•°å­—");
           }
           
           // 4. åˆ›å»ºç”¨æˆ·
           User user = new User();
           user.setEmail(dto.getEmail());
           user.setPassword(BCrypt.hashpw(dto.getPassword(), BCrypt.gensalt()));
           user.setNickname("ç”¨æˆ·" + System.currentTimeMillis());
           user.setRole("USER");
           user.setStatus(1);
           user.setCreateTime(new Date());
           
           // 5. ä¿å­˜åˆ°æ•°æ®åº“
           userMapper.insert(user);
           
           // 6. åˆ é™¤éªŒè¯ç 
           redisTemplate.delete(key);
       }
   }
   ```

**ç™»å½•åŠŸèƒ½è¯¦ç»†å®ç°ï¼š**

1. **ç™»å½•é¡µé¢å¸ƒå±€**
   - Tab åˆ‡æ¢ï¼šå¯†ç ç™»å½• / éªŒè¯ç ç™»å½•
   - é‚®ç®±è¾“å…¥æ¡†
   - å¯†ç è¾“å…¥æ¡† / éªŒè¯ç è¾“å…¥æ¡†
   - è®°ä½æˆ‘å¤é€‰æ¡†
   - ç™»å½•æŒ‰é’®
   - å¿˜è®°å¯†ç é“¾æ¥
   - æ³¨å†Œé“¾æ¥

2. **ç™»å½•æµç¨‹ï¼ˆå¯†ç ç™»å½•ï¼‰**
   ```
   ç”¨æˆ·è¾“å…¥é‚®ç®±å’Œå¯†ç 
       â†“
   å‰ç«¯éªŒè¯ï¼š
       - é‚®ç®±ä¸èƒ½ä¸ºç©º
       - å¯†ç ä¸èƒ½ä¸ºç©º
       â†“
   æäº¤ç™»å½•è¯·æ±‚
       â†“
   åç«¯éªŒè¯ï¼š
       - æŸ¥è¯¢ç”¨æˆ·æ˜¯å¦å­˜åœ¨
       - éªŒè¯å¯†ç æ˜¯å¦æ­£ç¡®
       - æ£€æŸ¥è´¦å·çŠ¶æ€ï¼ˆæ˜¯å¦è¢«å°ç¦ï¼‰
       â†“
   ç”Ÿæˆ JWT Token
       â†“
   Token å­˜å‚¨åˆ° Redisï¼ˆæœ‰æ•ˆæœŸ7å¤©ï¼‰
       â†“
   è¿”å› Token å’Œç”¨æˆ·ä¿¡æ¯
       â†“
   å‰ç«¯ä¿å­˜ Token åˆ° localStorage
       â†“
   è·³è½¬åˆ°é¦–é¡µ
   ```

3. **åç«¯å®ç°ç¤ºä¾‹**
   ```java
   @Service
   public class AuthService {
       
       @Autowired
       private UserMapper userMapper;
       
       @Autowired
       private RedisTemplate<String, String> redisTemplate;
       
       @Autowired
       private JwtUtil jwtUtil;
       
       /**
        * å¯†ç ç™»å½•
        */
       public LoginVO login(LoginDTO dto) {
           // 1. æŸ¥è¯¢ç”¨æˆ·
           User user = userMapper.selectByEmail(dto.getEmail());
           if (user == null) {
               throw new BusinessException("ç”¨æˆ·ä¸å­˜åœ¨");
           }
           
           // 2. éªŒè¯å¯†ç 
           if (!BCrypt.checkpw(dto.getPassword(), user.getPassword())) {
               throw new BusinessException("å¯†ç é”™è¯¯");
           }
           
           // 3. æ£€æŸ¥è´¦å·çŠ¶æ€
           if (user.getStatus() == 2) {
               throw new BusinessException("è´¦å·å·²è¢«å°ç¦");
           }
           
           // 4. ç”Ÿæˆ JWT Token
           String token = jwtUtil.generateToken(user.getId(), user.getEmail(), user.getRole());
           
           // 5. å­˜å‚¨ Token åˆ° Redisï¼ˆ7å¤©ï¼‰
           String key = "token:" + user.getId();
           redisTemplate.opsForValue().set(key, token, 7, TimeUnit.DAYS);
           
           // 6. è¿”å›ç™»å½•ä¿¡æ¯
           LoginVO vo = new LoginVO();
           vo.setToken(token);
           vo.setUserId(user.getId());
           vo.setEmail(user.getEmail());
           vo.setNickname(user.getNickname());
           vo.setAvatar(user.getAvatar());
           vo.setIsVerified(user.getIsVerified());
           vo.setRole(user.getRole());
           
           return vo;
       }
   }
   ```

#### 2.1.2 ç”¨æˆ·ä¿¡æ¯ç®¡ç†

**åŸºæœ¬ä¿¡æ¯ç¼–è¾‘ï¼š**
- æ˜µç§°ã€å¤´åƒã€æ€§åˆ«ã€å¹´çº§ã€ä¸“ä¸šã€æ‰‹æœºå·
- å®æ—¶ä¿å­˜ï¼Œæ— éœ€ç‚¹å‡»ä¿å­˜æŒ‰é’®
- å¤´åƒä¸Šä¼ æ”¯æŒè£å‰ªåŠŸèƒ½

#### 2.1.3 å®åè®¤è¯ï¼ˆå¯é€‰ï¼Œä½†è·‘è…¿å’Œäº¤æ˜“å¿…é¡»è®¤è¯ï¼‰

**å®åè®¤è¯çš„é‡è¦æ€§ï¼š**
- âš ï¸ **æœªè®¤è¯ç”¨æˆ·åªèƒ½ä½¿ç”¨å¤±ç‰©æ‹›é¢†åŠŸèƒ½**
- âœ… **å®åè®¤è¯åæ‰èƒ½å‘å¸ƒå’Œå‚ä¸é—²ç½®äº¤æ˜“**
- âœ… **å®åè®¤è¯åæ‰èƒ½å‘å¸ƒå’Œæ¥å•è·‘è…¿ä»»åŠ¡**

**è®¤è¯é¡µé¢è®¾è®¡ï¼š**

1. **æœªè®¤è¯çŠ¶æ€ï¼ˆæ˜¾ç¤ºè®¤è¯è¡¨å•ï¼‰**
   
   **é¡µé¢æç¤ºï¼š**
   ```
   ğŸ“Œ å®åè®¤è¯è¯´æ˜
   - å®åè®¤è¯åå¯ä»¥å‘å¸ƒé—²ç½®å•†å“å’Œè·‘è…¿ä»»åŠ¡
   - å®åè®¤è¯åå¯ä»¥å‚ä¸å•†å“äº¤æ˜“å’Œæ¥å•è·‘è…¿
   - æœªè®¤è¯ç”¨æˆ·åªèƒ½ä½¿ç”¨å¤±ç‰©æ‹›é¢†åŠŸèƒ½
   - è®¤è¯ä¿¡æ¯ä»…ç”¨äºå¹³å°å®‰å…¨ç®¡ç†ï¼Œä¸ä¼šæ³„éœ²ç»™å…¶ä»–ç”¨æˆ·
   - æäº¤åï¼Œç®¡ç†å‘˜å°†åœ¨1-3ä¸ªå·¥ä½œæ—¥å†…å®Œæˆå®¡æ ¸
   ```
   
   **è®¤è¯è¡¨å•ï¼š**
   - çœŸå®å§“åï¼ˆå¿…å¡«ï¼Œ2-10ä¸ªä¸­æ–‡å­—ç¬¦ï¼‰
   - èº«ä»½è¯å·ï¼ˆå¿…å¡«ï¼Œ18ä½ï¼‰
   - å­¦å·/å·¥å·ï¼ˆå¿…å¡«ï¼Œ6-20ä¸ªå­—ç¬¦ï¼‰
   - ç”¨æˆ·ç±»å‹ï¼ˆå¿…å¡«ï¼Œå•é€‰ï¼šå­¦ç”Ÿ/æ•™å¸ˆï¼‰
   - è¯æ˜æ–‡ä»¶ä¸Šä¼ ï¼ˆå¿…å¡«ï¼‰ï¼š
     - å­¦ç”Ÿï¼šå­¦ç”Ÿè¯ç…§ç‰‡ã€æ ¡å›­å¡ç…§ç‰‡ã€æ•™åŠ¡ç³»ç»Ÿæˆªå›¾
     - æ•™å¸ˆï¼šæ•™å¸ˆè¯ç…§ç‰‡ã€å·¥ä½œè¯ç…§ç‰‡ã€æ ¡å›­ç³»ç»Ÿæˆªå›¾
     - è¦æ±‚ï¼šè‡³å°‘1å¼ ï¼Œæœ€å¤š3å¼ ï¼Œjpg/jpeg/pngï¼Œå•å¼ ä¸è¶…è¿‡5MB

2. **è®¤è¯ä¸­çŠ¶æ€ï¼ˆæ˜¾ç¤ºå®¡æ ¸è¿›åº¦ï¼‰**
   ```
   â³ æ‚¨çš„å®åè®¤è¯æ­£åœ¨å®¡æ ¸ä¸­
   - æäº¤æ—¶é—´ï¼š2024-01-02 14:30:25
   - é¢„è®¡å®¡æ ¸æ—¶é—´ï¼š1-3ä¸ªå·¥ä½œæ—¥
   - è¯·è€å¿ƒç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸
   - å®¡æ ¸ç»“æœå°†é€šè¿‡ç«™å†…æ¶ˆæ¯å’Œé‚®ä»¶é€šçŸ¥æ‚¨
   ```

3. **å·²è®¤è¯çŠ¶æ€ï¼ˆæ˜¾ç¤ºè®¤è¯ä¿¡æ¯ï¼‰**
   ```
   âœ… æ­å–œæ‚¨ï¼Œå®åè®¤è¯å·²é€šè¿‡ï¼
   - è®¤è¯æ—¶é—´ï¼š2024-01-02 16:30:25
   - æ‚¨ç°åœ¨å¯ä»¥å‘å¸ƒé—²ç½®å•†å“å’Œè·‘è…¿ä»»åŠ¡
   - æ‚¨ç°åœ¨å¯ä»¥å‚ä¸å•†å“äº¤æ˜“å’Œæ¥å•è·‘è…¿
   ```

4. **å·²æ‹’ç»çŠ¶æ€ï¼ˆæ˜¾ç¤ºæ‹’ç»åŸå› ï¼‰**
   ```
   âŒ æ‚¨çš„å®åè®¤è¯æœªé€šè¿‡å®¡æ ¸
   - å®¡æ ¸æ—¶é—´ï¼š2024-01-02 16:30:25
   - æ‹’ç»åŸå› ï¼šä¸Šä¼ çš„è¯æ˜æ–‡ä»¶ä¸æ¸…æ™°ï¼Œè¯·é‡æ–°ä¸Šä¼ é«˜æ¸…ç…§ç‰‡
   - æ‚¨å¯ä»¥ä¿®æ”¹ä¿¡æ¯åé‡æ–°æäº¤è®¤è¯
   ```

**è®¤è¯å®ç°ç¤ºä¾‹ï¼š**
```java
@Service
public class VerificationService {
    
    @Autowired
    private UserMapper userMapper;
    
    /**
     * æäº¤å®åè®¤è¯
     */
    @Transactional
    public void submitVerification(VerificationDTO dto, Long userId) {
        // 1. æŸ¥è¯¢ç”¨æˆ·
        User user = userMapper.selectById(userId);
        if (user == null) {
            throw new BusinessException("ç”¨æˆ·ä¸å­˜åœ¨");
        }
        
        // 2. æ£€æŸ¥æ˜¯å¦å·²è®¤è¯
        if (user.getIsVerified() == 1) {
            throw new BusinessException("æ‚¨å·²å®Œæˆå®åè®¤è¯");
        }
        
        // 3. æ£€æŸ¥æ˜¯å¦æœ‰å¾…å®¡æ ¸çš„è®¤è¯
        if ("PENDING".equals(user.getVerificationStatus())) {
            throw new BusinessException("æ‚¨çš„è®¤è¯æ­£åœ¨å®¡æ ¸ä¸­ï¼Œè¯·å‹¿é‡å¤æäº¤");
        }
        
        // 4. æ›´æ–°ç”¨æˆ·ä¿¡æ¯
        user.setRealName(dto.getRealName());
        user.setIdCard(dto.getIdCard());
        user.setStudentId(dto.getStudentId());
        user.setUserType(dto.getUserType());
        user.setVerificationProof(JSON.toJSONString(dto.getProofImages()));
        user.setVerificationStatus("PENDING");
        user.setVerificationSubmitTime(new Date());
        
        // 5. ä¿å­˜åˆ°æ•°æ®åº“
        userMapper.updateById(user);
        
        // 6. å‘é€é€šçŸ¥ç»™ç®¡ç†å‘˜ï¼ˆWebSocketï¼‰
        // ...
    }
    
    /**
     * ç®¡ç†å‘˜å®¡æ ¸å®åè®¤è¯
     */
    @Transactional
    public void auditVerification(Long userId, Boolean approved, String reason, Long adminId) {
        // 1. æŸ¥è¯¢ç”¨æˆ·
        User user = userMapper.selectById(userId);
        if (user == null) {
            throw new BusinessException("ç”¨æˆ·ä¸å­˜åœ¨");
        }
        
        // 2. æ£€æŸ¥è®¤è¯çŠ¶æ€
        if (!"PENDING".equals(user.getVerificationStatus())) {
            throw new BusinessException("è¯¥è®¤è¯ä¸æ˜¯å¾…å®¡æ ¸çŠ¶æ€");
        }
        
        if (approved) {
            // å®¡æ ¸é€šè¿‡
            user.setIsVerified(1);
            user.setVerificationStatus("VERIFIED");
            user.setVerificationAuditTime(new Date());
            user.setVerificationAuditAdminId(adminId);
            
            // å‘é€é€šçŸ¥ç»™ç”¨æˆ·
            sendNotification(userId, "å®åè®¤è¯å·²é€šè¿‡", "æ­å–œæ‚¨ï¼Œå®åè®¤è¯å·²é€šè¿‡ï¼æ‚¨ç°åœ¨å¯ä»¥å‘å¸ƒé—²ç½®å•†å“å’Œè·‘è…¿ä»»åŠ¡äº†ã€‚");
        } else {
            // å®¡æ ¸æ‹’ç»
            user.setVerificationStatus("REJECTED");
            user.setVerificationAuditTime(new Date());
            user.setVerificationAuditReason(reason);
            user.setVerificationAuditAdminId(adminId);
            
            // å‘é€é€šçŸ¥ç»™ç”¨æˆ·
            sendNotification(userId, "å®åè®¤è¯æœªé€šè¿‡", "å¾ˆæŠ±æ­‰ï¼Œæ‚¨çš„å®åè®¤è¯æœªé€šè¿‡å®¡æ ¸ã€‚æ‹’ç»åŸå› ï¼š" + reason);
        }
        
        // 3. ä¿å­˜åˆ°æ•°æ®åº“
        userMapper.updateById(user);
    }
}
```

#### 2.1.4 ç”¨æˆ·æƒé™è¯´æ˜

**æƒé™çŸ©é˜µï¼š**

| åŠŸèƒ½ | æœªè®¤è¯ç”¨æˆ· | å·²è®¤è¯ç”¨æˆ· | ç®¡ç†å‘˜ |
|------|-----------|-----------|--------|
| æ³¨å†Œç™»å½• | âœ… | âœ… | âœ… |
| **å¤±ç‰©æ‹›é¢†** |  |  |  |
| - æµè§ˆå¤±ç‰©ä¿¡æ¯ | âœ… | âœ… | âœ… |
| - å‘å¸ƒå¤±ç‰©ä¿¡æ¯ | âœ… | âœ… | âœ… |
| - è®¤é¢†å¤±ç‰© | âœ… | âœ… | âœ… |
| **é—²ç½®äº¤æ˜“** |  |  |  |
| - æµè§ˆå•†å“ | âœ… | âœ… | âœ… |
| - å‘å¸ƒå•†å“ | âŒ **éœ€è¦å®åè®¤è¯** | âœ… | âœ… |
| - è´­ä¹°å•†å“ | âŒ **éœ€è¦å®åè®¤è¯** | âœ… | âœ… |
| **è·‘è…¿æœåŠ¡** |  |  |  |
| - æµè§ˆä»»åŠ¡ | âœ… | âœ… | âœ… |
| - å‘å¸ƒä»»åŠ¡ | âŒ **éœ€è¦å®åè®¤è¯** | âœ… | âœ… |
| - æ¥å•ä»»åŠ¡ | âŒ **éœ€è¦å®åè®¤è¯** | âœ… | âœ… |
| **å…¶ä»–åŠŸèƒ½** |  |  |  |
| - è¯„è®ºæ”¶è— | âœ… | âœ… | âœ… |
| - ç§ä¿¡æ²Ÿé€š | âœ… | âœ… | âœ… |
| - å†…å®¹å®¡æ ¸ | âŒ | âŒ | âœ… |
| - ç”¨æˆ·ç®¡ç† | âŒ | âŒ | âœ… |

**æƒé™éªŒè¯å®ç°ï¼š**
```java
@Aspect
@Component
public class VerificationAspect {
    
    @Autowired
    private UserMapper userMapper;
    
    /**
     * éœ€è¦å®åè®¤è¯çš„æ¥å£
     */
    @Around("@annotation(requireVerification)")
    public Object checkVerification(ProceedingJoinPoint joinPoint, RequireVerification requireVerification) throws Throwable {
        // 1. è·å–å½“å‰ç”¨æˆ·
        Long userId = SecurityUtils.getCurrentUserId();
        User user = userMapper.selectById(userId);
        
        // 2. æ£€æŸ¥æ˜¯å¦å·²è®¤è¯
        if (user.getIsVerified() != 1) {
            throw new BusinessException("è¯¥åŠŸèƒ½éœ€è¦å®åè®¤è¯ï¼Œè¯·å…ˆå®Œæˆå®åè®¤è¯");
        }
        
        // 3. æ‰§è¡ŒåŸæ–¹æ³•
        return joinPoint.proceed();
    }
}

// ä½¿ç”¨æ³¨è§£
@RestController
@RequestMapping("/api/goods")
public class GoodsController {
    
    /**
     * å‘å¸ƒå•†å“ï¼ˆéœ€è¦å®åè®¤è¯ï¼‰
     */
    @PostMapping("/publish")
    @RequireVerification
    public Result publishGoods(@RequestBody GoodsDTO dto) {
        // ...
    }
}
```

---

### 2.2 å¤±ç‰©æ‹›é¢†æ¨¡å—

#### 2.2.1 å¤±ç‰©å‘å¸ƒï¼ˆè¯¦ç»†å®ç°ï¼‰

**å‘å¸ƒé¡µé¢ï¼š** `/lost-found/publish`

**è¡¨å•è®¾è®¡ï¼š**
1. ç‰©å“åç§°ï¼ˆå¿…å¡«ï¼Œå•è¡Œè¾“å…¥æ¡†ï¼Œæœ€å¤š50å­—ï¼‰
2. ç‰©å“åˆ†ç±»ï¼ˆå¿…å¡«ï¼Œä¸‹æ‹‰é€‰æ‹©ï¼‰
   - è¯ä»¶ç±»ã€ç”µå­äº§å“ã€ç”Ÿæ´»ç”¨å“ã€ä¹¦ç±ã€å…¶ä»–
3. ç‰©å“æè¿°ï¼ˆå¿…å¡«ï¼Œå¤šè¡Œæ–‡æœ¬æ¡†ï¼Œæœ€å°‘10å­—ï¼Œæœ€å¤š500å­—ï¼‰
4. ä¸¢å¤±æ—¶é—´ï¼ˆå¿…å¡«ï¼Œæ—¥æœŸæ—¶é—´é€‰æ‹©å™¨ï¼‰
5. ä¸¢å¤±åœ°ç‚¹ï¼ˆå¿…å¡«ï¼Œå•è¡Œè¾“å…¥æ¡†ï¼Œæœ€å¤š100å­—ï¼‰
6. è”ç³»æ–¹å¼ï¼ˆå¯é€‰ï¼Œå•è¡Œè¾“å…¥æ¡†ï¼Œé»˜è®¤ä½¿ç”¨ç§ä¿¡ï¼‰
7. ç‰©å“å›¾ç‰‡ï¼ˆå¯é€‰ï¼Œå›¾ç‰‡ä¸Šä¼ ç»„ä»¶ï¼‰
   - æœ€å¤šä¸Šä¼ 9å¼ 
   - æ”¯æŒæ‹–æ‹½ä¸Šä¼ 
   - æ”¯æŒå›¾ç‰‡é¢„è§ˆå’Œåˆ é™¤
   - å›¾ç‰‡å‹ç¼©ï¼ˆå‰ç«¯ï¼‰
8. æ‚¬èµé‡‘é¢ï¼ˆå¯é€‰ï¼Œæ•°å­—è¾“å…¥æ¡†ï¼Œ0-10000å…ƒï¼‰

**å‘å¸ƒæµç¨‹ï¼š**
```
ç”¨æˆ·å¡«å†™å¤±ç‰©ä¿¡æ¯
    â†“
å‰ç«¯éªŒè¯ï¼š
    - å¿…å¡«é¡¹ä¸èƒ½ä¸ºç©º
    - ç‰©å“æè¿°è‡³å°‘10å­—
    - å›¾ç‰‡æ ¼å¼å’Œå¤§å°æ£€æŸ¥
    - æ‚¬èµé‡‘é¢ä¸èƒ½ä¸ºè´Ÿæ•°
    â†“
ä¸Šä¼ å›¾ç‰‡åˆ°æœåŠ¡å™¨
    â†“
æäº¤å‘å¸ƒè¯·æ±‚
    â†“
åç«¯éªŒè¯ï¼š
    - æ•°æ®æ ¼å¼éªŒè¯ï¼ˆ@Validatedï¼‰
    - æ•æ„Ÿè¯æ£€æµ‹
    - å‘å¸ƒé¢‘ç‡æ£€æµ‹
    - ç”¨æˆ·ä¿¡ç”¨æ£€æµ‹
    â†“
åˆ¤æ–­å®¡æ ¸ç»“æœï¼š
    â”œâ”€ è‡ªåŠ¨å®¡æ ¸é€šè¿‡ â†’ çŠ¶æ€è®¾ç½®ä¸º"å¾…è®¤é¢†"ï¼Œç«‹å³å‘å¸ƒ
    â””â”€ è½¬äººå·¥å®¡æ ¸ â†’ çŠ¶æ€è®¾ç½®ä¸º"å¾…å®¡æ ¸"ï¼Œè¿›å…¥å®¡æ ¸é˜Ÿåˆ—
    â†“
ä¿å­˜åˆ°æ•°æ®åº“
    â†“
è¿”å›å‘å¸ƒæˆåŠŸ
    â†“
è·³è½¬åˆ°è¯¦æƒ…é¡µ / æˆ‘çš„å‘å¸ƒé¡µ
```

**åç«¯å®ç°ï¼š**
```java
@Service
public class LostFoundService {
    
    @Autowired
    private LostFoundMapper lostFoundMapper;
    
    @Autowired
    private SensitiveWordService sensitiveWordService;
    
    @Autowired
    private PublishFrequencyService publishFrequencyService;
    
    /**
     * å‘å¸ƒå¤±ç‰©
     */
    @Transactional
    public Long publishLostFound(LostFoundDTO dto, Long userId) {
        // 1. æ•æ„Ÿè¯æ£€æµ‹
        SensitiveWordCheckResult checkResult = sensitiveWordService.check(dto.getTitle() + " " + dto.getDescription());
        
        // 2. å‘å¸ƒé¢‘ç‡æ£€æµ‹
        boolean frequencyOk = publishFrequencyService.checkFrequency(userId, "LOST_FOUND");
        
        // 3. ç”¨æˆ·ä¿¡ç”¨æ£€æµ‹ï¼ˆæ–°æ³¨å†Œç”¨æˆ·7å¤©å†…ï¼‰
        User user = userMapper.selectById(userId);
        boolean newUser = Duration.between(user.getCreateTime().toInstant(), Instant.now()).toDays() < 7;
        
        // 4. åˆ›å»ºå¤±ç‰©ä¿¡æ¯
        LostFound lostFound = new LostFound();
        BeanUtils.copyProperties(dto, lostFound);
        lostFound.setUserId(userId);
        lostFound.setImages(JSON.toJSONString(dto.getImages()));
        
        // 5. åˆ¤æ–­å®¡æ ¸çŠ¶æ€
        if (checkResult.isPass() && frequencyOk && !newUser) {
            // è‡ªåŠ¨å®¡æ ¸é€šè¿‡
            lostFound.setStatus("PENDING_CLAIM");
            lostFound.setAuditStatus("APPROVED");
            lostFound.setAuditTime(new Date());
        } else {
            // è½¬äººå·¥å®¡æ ¸
            lostFound.setStatus("PENDING_REVIEW");
            lostFound.setAuditStatus("PENDING");
            
            // è®°å½•è§¦å‘åŸå› 
            String reason = "";
            if (!checkResult.isPass()) reason += "åŒ…å«æ•æ„Ÿè¯ï¼›";
            if (!frequencyOk) reason += "å‘å¸ƒé¢‘ç¹ï¼›";
            if (newUser) reason += "æ–°æ³¨å†Œç”¨æˆ·ï¼›";
            // å¯ä»¥ä¿å­˜åˆ°æ—¥å¿—è¡¨
        }
        
        lostFound.setCreateTime(new Date());
        
        // 6. ä¿å­˜åˆ°æ•°æ®åº“
        lostFoundMapper.insert(lostFound);
        
        // 7. å¦‚æœéœ€è¦äººå·¥å®¡æ ¸ï¼Œå‘é€é€šçŸ¥ç»™ç®¡ç†å‘˜
        if ("PENDING_REVIEW".equals(lostFound.getStatus())) {
            // é€šçŸ¥ç®¡ç†å‘˜å®¡æ ¸
            notifyAdminForReview("LOST_FOUND", lostFound.getId());
        }
        
        return lostFound.getId();
    }
}
```

#### 2.2.2 å¤±ç‰©æµè§ˆä¸æœç´¢ï¼ˆè¯¦ç»†å®ç°ï¼‰

**åˆ—è¡¨é¡µï¼š** `/lost-found/list`

**é¡µé¢å¸ƒå±€ï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [æœç´¢æ¡†]  [æœç´¢æŒ‰é’®]                    [å‘å¸ƒå¤±ç‰©æŒ‰é’®]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  åˆ†ç±»ç­›é€‰: [å…¨éƒ¨] [è¯ä»¶ç±»] [ç”µå­äº§å“] [ç”Ÿæ´»ç”¨å“] ...    â”‚
â”‚  çŠ¶æ€ç­›é€‰: [å…¨éƒ¨] [å¾…è®¤é¢†] [è®¤é¢†ä¸­] [å·²è®¤é¢†] [å·²å…³é—­]   â”‚
â”‚  åœ°ç‚¹ç­›é€‰: [å…¨éƒ¨] [æ•™å­¦æ¥¼] [å®¿èˆ] [é£Ÿå ‚] ...           â”‚
â”‚  æ’åºæ–¹å¼: [æœ€æ–°] [æµè§ˆæœ€å¤š] [æ‚¬èµæœ€é«˜]                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  [å›¾ç‰‡]  ç‰©å“åç§°                               â”‚   â”‚
â”‚  â”‚          åˆ†ç±» | ä¸¢å¤±åœ°ç‚¹ | å‘å¸ƒæ—¶é—´             â”‚   â”‚
â”‚  â”‚          ç‰©å“æè¿°...                            â”‚   â”‚
â”‚  â”‚          æ‚¬èµ: Â¥50  æµè§ˆ: 128æ¬¡                â”‚   â”‚
â”‚  â”‚          [æŸ¥çœ‹è¯¦æƒ…]                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  ...                                                    â”‚
â”‚  [åˆ†é¡µå™¨]                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æœç´¢å®ç°ï¼š**
```java
@Service
public class LostFoundService {
    
    /**
     * æœç´¢å¤±ç‰©åˆ—è¡¨
     */
    public PageResult<LostFoundVO> searchLostFound(LostFoundSearchDTO dto) {
        // 1. æ„å»ºæŸ¥è¯¢æ¡ä»¶
        Page<LostFound> page = new Page<>(dto.getPageNum(), dto.getPageSize());
        QueryWrapper<LostFound> wrapper = new QueryWrapper<>();
        
        // å…³é”®è¯æœç´¢ï¼ˆæ ‡é¢˜æˆ–æè¿°ï¼‰
        if (StringUtils.isNotBlank(dto.getKeyword())) {
            wrapper.and(w -> w.like("title", dto.getKeyword())
                              .or()
                              .like("description", dto.getKeyword()));
        }
        
        // åˆ†ç±»ç­›é€‰
        if (StringUtils.isNotBlank(dto.getCategory())) {
            wrapper.eq("category", dto.getCategory());
        }
        
        // çŠ¶æ€ç­›é€‰
        if (StringUtils.isNotBlank(dto.getStatus())) {
            wrapper.eq("status", dto.getStatus());
        } else {
            // é»˜è®¤åªæ˜¾ç¤ºå¾…è®¤é¢†ã€è®¤é¢†ä¸­ã€å·²è®¤é¢†çš„
            wrapper.in("status", "PENDING_CLAIM", "CLAIMING", "CLAIMED");
        }
        
        // åœ°ç‚¹ç­›é€‰
        if (StringUtils.isNotBlank(dto.getLocation())) {
            wrapper.like("lost_location", dto.getLocation());
        }
        
        // æ‚¬èµç­›é€‰
        if (dto.getHasReward() != null && dto.getHasReward()) {
            wrapper.gt("reward", 0);
        }
        
        // ä¸æ˜¾ç¤ºå·²åˆ é™¤çš„
        wrapper.eq("delete_flag", 0);
        
        // æ’åº
        if ("view".equals(dto.getSortBy())) {
            wrapper.orderByDesc("view_count");
        } else if ("reward".equals(dto.getSortBy())) {
            wrapper.orderByDesc("reward");
        } else {
            wrapper.orderByDesc("create_time");
        }
        
        // 2. æŸ¥è¯¢
        Page<LostFound> result = lostFoundMapper.selectPage(page, wrapper);
        
        // 3. è½¬æ¢ä¸º VO
        List<LostFoundVO> voList = result.getRecords().stream()
            .map(this::convertToVO)
            .collect(Collectors.toList());
        
        return new PageResult<>(voList, result.getTotal(), result.getCurrent(), result.getSize());
    }
    
    /**
     * è½¬æ¢ä¸º VO
     */
    private LostFoundVO convertToVO(LostFound lostFound) {
        LostFoundVO vo = new LostFoundVO();
        BeanUtils.copyProperties(lostFound, vo);
        
        // è§£æå›¾ç‰‡
        if (StringUtils.isNotBlank(lostFound.getImages())) {
            vo.setImageList(JSON.parseArray(lostFound.getImages(), String.class));
        }
        
        // è·å–å‘å¸ƒè€…ä¿¡æ¯
        User user = userMapper.selectById(lostFound.getUserId());
        vo.setPublisherNickname(user.getNickname());
        vo.setPublisherAvatar(user.getAvatar());
        vo.setPublisherIsVerified(user.getIsVerified());
        
        // æ ¼å¼åŒ–æ—¶é—´
        vo.setCreateTimeStr(formatTime(lostFound.getCreateTime()));
        
        return vo;
    }
}
```

#### 2.2.3 è®¤é¢†åŠŸèƒ½ï¼ˆè¯¦ç»†å®ç°ï¼‰

**è®¤é¢†æµç¨‹å®Œæ•´å®ç°ï¼š**

1. **ç”¨æˆ·æŸ¥çœ‹è¯¦æƒ…ï¼Œç‚¹å‡»"ç”³è¯·è®¤é¢†"**
   - å¼¹å‡ºè®¤é¢†ç”³è¯·å¯¹è¯æ¡†

2. **å¡«å†™è®¤é¢†ä¿¡æ¯**
   ```vue
   <el-dialog title="ç”³è¯·è®¤é¢†" v-model="claimDialogVisible">
     <el-form :model="claimForm" :rules="claimRules" ref="claimFormRef">
       <el-form-item label="ç‰©å“ç‰¹å¾æè¿°" prop="description">
         <el-input
           type="textarea"
           v-model="claimForm.description"
           placeholder="è¯·è¯¦ç»†æè¿°ç‰©å“çš„ç‰¹å¾ï¼Œä»¥ä¾¿å‘å¸ƒè€…ç¡®è®¤"
           :rows="4"
           maxlength="200"
           show-word-limit
         />
       </el-form-item>
       
       <el-form-item label="ä¸¢å¤±æ—¶é—´" prop="lostTime">
         <el-date-picker
           v-model="claimForm.lostTime"
           type="datetime"
           placeholder="æ‚¨è®°å¾—çš„ä¸¢å¤±æ—¶é—´"
         />
       </el-form-item>
       
       <el-form-item label="å…¶ä»–ä¿¡æ¯" prop="otherInfo">
         <el-input
           type="textarea"
           v-model="claimForm.otherInfo"
           placeholder="å…¶ä»–èƒ½è¯æ˜ç‰©å“å½’å±çš„ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰"
           :rows="2"
         />
       </el-form-item>
       
       <el-form-item label="è¯æ˜æ–‡ä»¶" prop="proofImages">
         <el-upload
           :action="uploadUrl"
           :headers="uploadHeaders"
           :file-list="claimForm.proofImages"
           :on-success="handleUploadSuccess"
           :before-upload="beforeUpload"
           :limit="3"
           list-type="picture-card"
         >
           <el-icon><Plus /></el-icon>
         </el-upload>
         <div class="upload-tip">æœ€å¤šä¸Šä¼ 3å¼ è¯æ˜æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰</div>
       </el-form-item>
     </el-form>
     
     <template #footer>
       <el-button @click="claimDialogVisible = false">å–æ¶ˆ</el-button>
       <el-button type="primary" @click="submitClaim" :loading="submitting">
         æäº¤è®¤é¢†
       </el-button>
     </template>
   </el-dialog>
   ```

3. **åç«¯å¤„ç†è®¤é¢†ç”³è¯·**
   ```java
   @Service
   public class ClaimService {
       
       @Autowired
       private LostFoundMapper lostFoundMapper;
       
       @Autowired
       private ClaimRecordMapper claimRecordMapper;
       
       @Autowired
       private ChatSessionService chatSessionService;
       
       /**
        * ç”³è¯·è®¤é¢†
        */
       @Transactional
       public void applyClaim(ClaimDTO dto, Long userId) {
           // 1. æŸ¥è¯¢å¤±ç‰©ä¿¡æ¯
           LostFound lostFound = lostFoundMapper.selectById(dto.getLostFoundId());
           if (lostFound == null) {
               throw new BusinessException("å¤±ç‰©ä¿¡æ¯ä¸å­˜åœ¨");
           }
           
           // 2. éªŒè¯çŠ¶æ€
           if (!"PENDING_CLAIM".equals(lostFound.getStatus()) && !"CLAIMING".equals(lostFound.getStatus())) {
               throw new BusinessException("è¯¥å¤±ç‰©å½“å‰ä¸å¯è®¤é¢†");
           }
           
           // 3. ä¸èƒ½è®¤é¢†è‡ªå·±å‘å¸ƒçš„
           if (lostFound.getUserId().equals(userId)) {
               throw new BusinessException("ä¸èƒ½è®¤é¢†è‡ªå·±å‘å¸ƒçš„å¤±ç‰©");
           }
           
           // 4. æ£€æŸ¥æ˜¯å¦å·²ç»ç”³è¯·è¿‡
           QueryWrapper<ClaimRecord> wrapper = new QueryWrapper<>();
           wrapper.eq("lost_found_id", dto.getLostFoundId())
                  .eq("claimer_id", userId);
           ClaimRecord existRecord = claimRecordMapper.selectOne(wrapper);
           if (existRecord != null) {
               throw new BusinessException("æ‚¨å·²ç”³è¯·è®¤é¢†è¿‡è¯¥å¤±ç‰©");
           }
           
           // 5. ä½¿ç”¨ä¹è§‚é”æ›´æ–°å¤±ç‰©çŠ¶æ€
           int rows = lostFoundMapper.updateStatusWithVersion(
               dto.getLostFoundId(),
               "PENDING_CLAIM",
               "CLAIMING",
               lostFound.getVersion()
           );
           
           if (rows == 0) {
               throw new BusinessException("è®¤é¢†å¤±è´¥ï¼Œè¯·é‡è¯•");
           }
           
           // 6. åˆ›å»ºè®¤é¢†è®°å½•
           ClaimRecord record = new ClaimRecord();
           record.setLostFoundId(dto.getLostFoundId());
           record.setClaimerId(userId);
           record.setDescription(dto.getDescription());
           record.setLostTime(dto.getLostTime());
           record.setOtherInfo(dto.getOtherInfo());
           record.setProofImages(JSON.toJSONString(dto.getProofImages()));
           record.setStatus("PENDING"); // å¾…ç¡®è®¤
           record.setCreateTime(new Date());
           claimRecordMapper.insert(record);
           
           // 7. åˆ›å»ºç§ä¿¡ä¼šè¯
           chatSessionService.createSession(userId, lostFound.getUserId(), "LOST_FOUND", lostFound.getId());
           
           // 8. å‘é€é€šçŸ¥ç»™å‘å¸ƒè€…
           notifyPublisher(lostFound.getUserId(), "æ”¶åˆ°è®¤é¢†ç”³è¯·", 
               "æ‚¨å‘å¸ƒçš„å¤±ç‰©ã€Š" + lostFound.getTitle() + "ã€‹æ”¶åˆ°äº†è®¤é¢†ç”³è¯·ï¼Œè¯·åŠæ—¶æŸ¥çœ‹");
       }
       
       /**
        * ç¡®è®¤è®¤é¢†
        */
       @Transactional
       public void confirmClaim(Long claimRecordId, Long userId) {
           // 1. æŸ¥è¯¢è®¤é¢†è®°å½•
           ClaimRecord record = claimRecordMapper.selectById(claimRecordId);
           if (record == null) {
               throw new BusinessException("è®¤é¢†è®°å½•ä¸å­˜åœ¨");
           }
           
           // 2. æŸ¥è¯¢å¤±ç‰©ä¿¡æ¯
           LostFound lostFound = lostFoundMapper.selectById(record.getLostFoundId());
           if (lostFound == null) {
               throw new BusinessException("å¤±ç‰©ä¿¡æ¯ä¸å­˜åœ¨");
           }
           
           // 3. éªŒè¯æƒé™ï¼ˆåªæœ‰å‘å¸ƒè€…å¯ä»¥ç¡®è®¤ï¼‰
           if (!lostFound.getUserId().equals(userId)) {
               throw new BusinessException("æ— æƒæ“ä½œ");
           }
           
           // 4. éªŒè¯çŠ¶æ€
           if (!"PENDING".equals(record.getStatus())) {
               throw new BusinessException("è¯¥è®¤é¢†å·²å¤„ç†");
           }
           
           // 5. æ›´æ–°è®¤é¢†è®°å½•
           record.setStatus("CONFIRMED");
           record.setConfirmTime(new Date());
           claimRecordMapper.updateById(record);
           
           // 6. æ›´æ–°å¤±ç‰©çŠ¶æ€
           lostFound.setStatus("CLAIMED");
           lostFoundMapper.updateById(lostFound);
           
           // 7. å‘é€é€šçŸ¥ç»™è®¤é¢†è€…
           notifyUser(record.getClaimerId(), "è®¤é¢†æˆåŠŸ", 
               "æ‚¨è®¤é¢†çš„å¤±ç‰©ã€Š" + lostFound.getTitle() + "ã€‹å·²è¢«ç¡®è®¤ï¼Œè¯·è”ç³»å‘å¸ƒè€…å–å›ç‰©å“");
       }
       
       /**
        * æ‹’ç»è®¤é¢†
        */
       @Transactional
       public void rejectClaim(Long claimRecordId, String reason, Long userId) {
           // ç±»ä¼¼ç¡®è®¤è®¤é¢†çš„æµç¨‹
           // ...
           
           // æ›´æ–°è®¤é¢†è®°å½•ä¸ºæ‹’ç»
           record.setStatus("REJECTED");
           record.setRejectReason(reason);
           record.setRejectTime(new Date());
           claimRecordMapper.updateById(record);
           
           // å¤±ç‰©çŠ¶æ€æ¢å¤ä¸ºå¾…è®¤é¢†
           lostFound.setStatus("PENDING_CLAIM");
           lostFoundMapper.updateById(lostFound);
           
           // å‘é€é€šçŸ¥
           notifyUser(record.getClaimerId(), "è®¤é¢†è¢«æ‹’ç»", 
               "å¾ˆæŠ±æ­‰ï¼Œæ‚¨è®¤é¢†çš„å¤±ç‰©ã€Š" + lostFound.getTitle() + "ã€‹è¢«æ‹’ç»ã€‚åŸå› ï¼š" + reason);
       }
   }
   ```

---

### 2.3 é—²ç½®äº¤æ˜“æ¨¡å—

#### 2.3.1 å•†å“å‘å¸ƒï¼ˆéœ€è¦å®åè®¤è¯ï¼‰

**æƒé™éªŒè¯ï¼š**
```java
@RestController
@RequestMapping("/api/goods")
public class GoodsController {
    
    /**
     * å‘å¸ƒå•†å“ï¼ˆéœ€è¦å®åè®¤è¯ï¼‰
     */
    @PostMapping("/publish")
    @RequireVerification // è‡ªå®šä¹‰æ³¨è§£ï¼ŒéªŒè¯å®åè®¤è¯
    public Result publishGoods(@RequestBody @Validated GoodsDTO dto) {
        Long userId = SecurityUtils.getCurrentUserId();
        Long goodsId = goodsService.publishGoods(dto, userId);
        return Result.success(goodsId);
    }
}
```

**å‘å¸ƒæµç¨‹åŒå¤±ç‰©æ‹›é¢†ï¼Œé¢å¤–å¢åŠ ï¼š**
- åŸä»·å’Œç°ä»·éªŒè¯ï¼ˆç°ä»·ä¸èƒ½é«˜äºåŸä»·ï¼‰
- å•†å“æˆè‰²å¿…é€‰ï¼ˆå…¨æ–°ã€å‡ ä¹å…¨æ–°ã€è½»å¾®ä½¿ç”¨ç—•è¿¹ã€æ˜æ˜¾ä½¿ç”¨ç—•è¿¹ï¼‰
- è‡³å°‘ä¸Šä¼ 1å¼ å›¾ç‰‡ï¼Œæœ€å¤š9å¼ 
- **åº“å­˜æ•°é‡å¿…å¡«**ï¼ˆæœ€å°‘1ä»¶ï¼Œæ”¯æŒå¤šä»¶å•†å“ï¼‰
- **äº¤æ˜“æ–¹å¼é€‰æ‹©**ï¼ˆå•é€‰ï¼šé‚®å¯„ æˆ– è‡ªæï¼‰
  - é€‰æ‹©é‚®å¯„ï¼šéœ€å¡«å†™é‚®å¯„è´¹ç”¨ï¼ˆå¯é€‰ï¼Œé»˜è®¤0ï¼‰
  - é€‰æ‹©è‡ªæï¼šéœ€å¡«å†™è‡ªæåœ°ç‚¹ï¼ˆå¿…å¡«ï¼Œæœ€å¤š100å­—ï¼‰

**å•†å“å‘å¸ƒè¡¨å•å­—æ®µï¼š**
1. å•†å“æ ‡é¢˜ï¼ˆå¿…å¡«ï¼Œæœ€å¤š50å­—ï¼‰
2. å•†å“åˆ†ç±»ï¼ˆå¿…å¡«ï¼Œä¸‹æ‹‰é€‰æ‹©ï¼‰
3. å•†å“æè¿°ï¼ˆå¿…å¡«ï¼Œæœ€å°‘10å­—ï¼Œæœ€å¤š500å­—ï¼‰
4. åŸä»·ï¼ˆå¿…å¡«ï¼Œæ•°å­—ï¼Œå¤§äº0ï¼‰
5. ç°ä»·ï¼ˆå¿…å¡«ï¼Œæ•°å­—ï¼Œå¤§äº0ï¼Œä¸èƒ½é«˜äºåŸä»·ï¼‰
6. å•†å“æˆè‰²ï¼ˆå¿…å¡«ï¼Œå•é€‰ï¼‰
7. **åº“å­˜æ•°é‡ï¼ˆå¿…å¡«ï¼Œæ•´æ•°ï¼Œæœ€å°‘1ä»¶ï¼‰**
8. å•†å“å›¾ç‰‡ï¼ˆå¿…å¡«ï¼Œ1-9å¼ ï¼‰
9. **äº¤æ˜“æ–¹å¼ï¼ˆå¿…å¡«ï¼Œå•é€‰ï¼šé‚®å¯„ æˆ– è‡ªæï¼‰**
   - é‚®å¯„ï¼šéœ€å¡«å†™é‚®å¯„è´¹ç”¨ï¼ˆå¯é€‰ï¼Œé»˜è®¤0ï¼‰
   - è‡ªæï¼šéœ€å¡«å†™è‡ªæåœ°ç‚¹ï¼ˆå¿…å¡«ï¼Œæœ€å¤š100å­—ï¼‰

**å•†å“ç¼–è¾‘åŠŸèƒ½ï¼š**
- å–å®¶å¯ä»¥ä¿®æ”¹å•†å“çš„äº¤æ˜“æ–¹å¼ï¼ˆé‚®å¯„/è‡ªæï¼‰
- å¦‚æœå•†å“å·²æœ‰è®¢å•ï¼Œä¿®æ”¹äº¤æ˜“æ–¹å¼éœ€è¦æç¤ºå½±å“
- ä¿®æ”¹åï¼Œæ–°è®¢å•ä½¿ç”¨æ–°çš„äº¤æ˜“æ–¹å¼ï¼Œå·²å­˜åœ¨çš„è®¢å•ä¸å—å½±å“

#### 2.3.2 äº¤æ˜“æµç¨‹ï¼ˆéœ€è¦å®åè®¤è¯ï¼‰

**ä¹°å®¶è´­ä¹°æµç¨‹ï¼š**
```
ä¹°å®¶æµè§ˆå•†å“
    â†“
ç‚¹å‡»"ç«‹å³è´­ä¹°"
    â†“
éªŒè¯å®åè®¤è¯ï¼ˆæœªè®¤è¯æç¤º"è¯¥åŠŸèƒ½éœ€è¦å®åè®¤è¯"ï¼‰
    â†“
é€‰æ‹©è´­ä¹°æ•°é‡ï¼ˆä¸èƒ½è¶…è¿‡åº“å­˜ï¼‰
    â†“
é€‰æ‹©äº¤æ˜“æ–¹å¼ï¼ˆé‚®å¯„/è‡ªæï¼‰
    â†“
ã€é‚®å¯„æ–¹å¼ã€‘é€‰æ‹©æ”¶è´§åœ°å€ï¼ˆä»åœ°å€åˆ—è¡¨ä¸­é€‰æ‹©ï¼Œæˆ–æ·»åŠ æ–°åœ°å€ï¼‰
    â†“
åˆ›å»ºè®¢å•ï¼ˆç”Ÿæˆå”¯ä¸€è®¢å•å·ï¼ŒçŠ¶æ€ï¼šPENDING_PAYMENT-å¾…ä»˜æ¬¾ï¼‰
    â†“
ç³»ç»Ÿè‡ªåŠ¨åˆ›å»ºç§ä¿¡ä¼šè¯ï¼ˆèŠå¤©é¡µé¢æ˜¾ç¤ºè®¢å•ä¿¡æ¯å¡ç‰‡ï¼‰
    â†“
åŒæ–¹é€šè¿‡èŠå¤©åå•†ï¼ˆå¯é€‰ï¼‰
    â†“
ã€è®¢å•çŠ¶æ€æµè½¬ã€‘
    â”œâ”€ å–å®¶å¯ä»¥æ”¹ä»·ï¼ˆçŠ¶æ€ä»ä¸ºPENDING_PAYMENTï¼‰
    â”œâ”€ ä¹°å®¶ä»˜æ¬¾ï¼ˆçŠ¶æ€ï¼šPAID-å·²ä»˜æ¬¾ï¼‰
    â”œâ”€ ã€é‚®å¯„æ–¹å¼ã€‘å–å®¶å‘è´§ï¼ˆå¡«å†™å¿«é€’å•å·ã€ç‰©æµå…¬å¸ï¼‰
    â”‚   â””â”€ çŠ¶æ€ï¼šSHIPPEDï¼ˆå·²å‘è´§ï¼‰â†’ ä¹°å®¶ç¡®è®¤æ”¶è´§ â†’ COMPLETEDï¼ˆå·²å®Œæˆï¼‰
    â”œâ”€ ã€è‡ªææ–¹å¼ã€‘æ— éœ€å‘è´§ï¼Œä»˜æ¬¾åç›´æ¥è¿›å…¥å¾…è‡ªæçŠ¶æ€
    â”‚   â””â”€ çŠ¶æ€ï¼šPENDING_PICKUPï¼ˆå¾…è‡ªæï¼‰â†’ ä¹°å®¶ç¡®è®¤æ”¶è´§ â†’ COMPLETEDï¼ˆå·²å®Œæˆï¼‰
    â””â”€ åŒæ–¹è¯„ä»·ï¼ˆå¯é€‰ï¼‰
```

**è®¢å•çŠ¶æ€æµè½¬å›¾ï¼š**
```
PENDING_PAYMENTï¼ˆå¾…ä»˜æ¬¾ï¼‰
    â†“
    â”œâ”€ å–å®¶æ”¹ä»· â†’ ä»ä¸º PENDING_PAYMENT
    â”œâ”€ ä¹°å®¶å–æ¶ˆè®¢å• â†’ CANCELLEDï¼ˆå·²å–æ¶ˆï¼‰
    â””â”€ ä¹°å®¶ä»˜æ¬¾ â†’ PAIDï¼ˆå·²ä»˜æ¬¾ï¼‰
        â†“
        â”œâ”€ ã€é‚®å¯„æ–¹å¼ã€‘å–å®¶å‘è´§ï¼ˆå¡«å†™å¿«é€’å•å·ï¼‰ â†’ SHIPPEDï¼ˆå·²å‘è´§ï¼‰
        â”‚   â””â”€ ä¹°å®¶ç¡®è®¤æ”¶è´§ â†’ COMPLETEDï¼ˆå·²å®Œæˆï¼‰
        â””â”€ ã€è‡ªææ–¹å¼ã€‘æ— éœ€å‘è´§ï¼Œè‡ªåŠ¨è¿›å…¥ â†’ PENDING_PICKUPï¼ˆå¾…è‡ªæï¼‰
            â””â”€ ä¹°å®¶ç¡®è®¤æ”¶è´§ â†’ COMPLETEDï¼ˆå·²å®Œæˆï¼‰
```

**è‡ªææ–¹å¼è¯´æ˜ï¼ˆå‚è€ƒå’¸é±¼ï¼‰ï¼š**
- è‡ªæè®¢å•**æ— éœ€å‘è´§**æ“ä½œ
- ä¹°å®¶ä»˜æ¬¾åï¼Œè®¢å•çŠ¶æ€è‡ªåŠ¨å˜ä¸º"å¾…è‡ªæ"ï¼ˆPENDING_PICKUPï¼‰
- åŒæ–¹é€šè¿‡èŠå¤©çº¦å®šè‡ªæåœ°ç‚¹å’Œæ—¶é—´
- ä¹°å®¶è‡ªæåï¼Œç›´æ¥ç¡®è®¤æ”¶è´§å³å¯å®Œæˆè®¢å•
- å–å®¶æ— éœ€è¿›è¡Œ"å‘è´§"æˆ–"ç¡®è®¤è‡ªæ"æ“ä½œ

**è®¢å•çŠ¶æ€è¯´æ˜ï¼š**
- `PENDING_PAYMENT`ï¼šå¾…ä»˜æ¬¾ï¼ˆä¹°å®¶å·²åˆ›å»ºè®¢å•ï¼Œæœªä»˜æ¬¾ï¼‰
- `PAID`ï¼šå·²ä»˜æ¬¾ï¼ˆä¹°å®¶å·²ä»˜æ¬¾ï¼‰
  - é‚®å¯„æ–¹å¼ï¼šç­‰å¾…å–å®¶å‘è´§
  - è‡ªææ–¹å¼ï¼šè‡ªåŠ¨è¿›å…¥å¾…è‡ªæçŠ¶æ€ï¼ˆæ— éœ€å‘è´§ï¼‰
- `SHIPPED`ï¼šå·²å‘è´§ï¼ˆä»…é‚®å¯„æ–¹å¼ï¼Œå–å®¶å·²å‘è´§ï¼Œç­‰å¾…ä¹°å®¶ç¡®è®¤æ”¶è´§ï¼‰
- `PENDING_PICKUP`ï¼šå¾…è‡ªæï¼ˆä»…è‡ªææ–¹å¼ï¼Œä¹°å®¶å·²ä»˜æ¬¾ï¼Œç­‰å¾…ä¹°å®¶è‡ªæå¹¶ç¡®è®¤æ”¶è´§ï¼‰
- `COMPLETED`ï¼šå·²å®Œæˆï¼ˆä¹°å®¶å·²ç¡®è®¤æ”¶è´§ï¼‰
- `CANCELLED`ï¼šå·²å–æ¶ˆï¼ˆä¹°å®¶æˆ–å–å®¶å–æ¶ˆè®¢å•ï¼‰
- `REFUNDED`ï¼šå·²é€€æ¬¾ï¼ˆè®¢å•é€€æ¬¾ï¼‰

#### 2.3.3 æ”¶è´§åœ°å€ç®¡ç†åŠŸèƒ½

**åŠŸèƒ½è¯´æ˜ï¼š**
- ç”¨æˆ·éœ€è¦ç®¡ç†è‡ªå·±çš„æ”¶è´§åœ°å€ï¼ˆé‚®å¯„æ–¹å¼ä¸‹å•æ—¶ä½¿ç”¨ï¼‰
- æ”¯æŒæ·»åŠ ã€ç¼–è¾‘ã€åˆ é™¤ã€è®¾ç½®é»˜è®¤åœ°å€
- æœ€å¤šä¿å­˜10ä¸ªæ”¶è´§åœ°å€

**æ”¶è´§åœ°å€å­—æ®µï¼š**
1. æ”¶è´§äººå§“åï¼ˆå¿…å¡«ï¼Œæœ€å¤š20å­—ï¼‰
2. æ”¶è´§äººç”µè¯ï¼ˆå¿…å¡«ï¼Œæ‰‹æœºå·æ ¼å¼éªŒè¯ï¼‰
3. æ‰€åœ¨åœ°åŒºï¼ˆå¿…å¡«ï¼Œçœå¸‚åŒºä¸‰çº§è”åŠ¨ï¼‰
4. è¯¦ç»†åœ°å€ï¼ˆå¿…å¡«ï¼Œæœ€å¤š200å­—ï¼‰
5. é‚®æ”¿ç¼–ç ï¼ˆå¯é€‰ï¼Œ6ä½æ•°å­—ï¼‰
6. æ˜¯å¦é»˜è®¤åœ°å€ï¼ˆå•é€‰ï¼Œåªèƒ½æœ‰ä¸€ä¸ªé»˜è®¤åœ°å€ï¼‰

**APIæ¥å£ï¼š**
```java
@RestController
@RequestMapping("/api/address")
public class AddressController {
    
    /**
     * è·å–å½“å‰ç”¨æˆ·çš„æ”¶è´§åœ°å€åˆ—è¡¨
     */
    @GetMapping("/list")
    @PreAuthorize("hasAuthority('ROLE_USER') or hasAuthority('ROLE_ADMIN')")
    public Result<List<Address>> getAddressList() {
        Long userId = SecurityUtils.getCurrentUserId();
        List<Address> list = addressService.getAddressList(userId);
        return Result.success("æŸ¥è¯¢æˆåŠŸ", list);
    }
    
    /**
     * æ·»åŠ æ”¶è´§åœ°å€
     */
    @PostMapping("/add")
    @PreAuthorize("hasAuthority('ROLE_USER') or hasAuthority('ROLE_ADMIN')")
    public Result<Long> addAddress(@RequestBody @Validated AddressDTO dto) {
        Long userId = SecurityUtils.getCurrentUserId();
        Long addressId = addressService.addAddress(dto, userId);
        return Result.success("æ·»åŠ æˆåŠŸ", addressId);
    }
    
    /**
     * æ›´æ–°æ”¶è´§åœ°å€
     */
    @PutMapping("/{id}")
    @PreAuthorize("hasAuthority('ROLE_USER') or hasAuthority('ROLE_ADMIN')")
    public Result<Void> updateAddress(@PathVariable Long id, @RequestBody @Validated AddressDTO dto) {
        Long userId = SecurityUtils.getCurrentUserId();
        addressService.updateAddress(id, dto, userId);
        return Result.success("æ›´æ–°æˆåŠŸ", null);
    }
    
    /**
     * åˆ é™¤æ”¶è´§åœ°å€
     */
    @DeleteMapping("/{id}")
    @PreAuthorize("hasAuthority('ROLE_USER') or hasAuthority('ROLE_ADMIN')")
    public Result<Void> deleteAddress(@PathVariable Long id) {
        Long userId = SecurityUtils.getCurrentUserId();
        addressService.deleteAddress(id, userId);
        return Result.success("åˆ é™¤æˆåŠŸ", null);
    }
    
    /**
     * è®¾ç½®é»˜è®¤åœ°å€
     */
    @PutMapping("/{id}/default")
    @PreAuthorize("hasAuthority('ROLE_USER') or hasAuthority('ROLE_ADMIN')")
    public Result<Void> setDefaultAddress(@PathVariable Long id) {
        Long userId = SecurityUtils.getCurrentUserId();
        addressService.setDefaultAddress(id, userId);
        return Result.success("è®¾ç½®æˆåŠŸ", null);
    }
}
```

**Serviceå®ç°ï¼š**
```java
@Service
public class AddressService {
    
    /**
     * æ·»åŠ æ”¶è´§åœ°å€
     */
    @Transactional(rollbackFor = Exception.class)
    public Long addAddress(AddressDTO dto, Long userId) {
        // 1. æ£€æŸ¥åœ°å€æ•°é‡é™åˆ¶ï¼ˆæœ€å¤š10ä¸ªï¼‰
        long count = addressMapper.selectCount(
            new LambdaQueryWrapper<Address>()
                .eq(Address::getUserId, userId)
                .eq(Address::getDeleteFlag, 0)
        );
        if (count >= 10) {
            throw new BusinessException("æœ€å¤šåªèƒ½ä¿å­˜10ä¸ªæ”¶è´§åœ°å€");
        }
        
        // 2. å¦‚æœè®¾ç½®ä¸ºé»˜è®¤åœ°å€ï¼Œå–æ¶ˆå…¶ä»–é»˜è®¤åœ°å€
        if (dto.getIsDefault() != null && dto.getIsDefault() == 1) {
            addressMapper.update(null, 
                new LambdaUpdateWrapper<Address>()
                    .eq(Address::getUserId, userId)
                    .eq(Address::getIsDefault, 1)
                    .set(Address::getIsDefault, 0)
            );
        }
        
        // 3. åˆ›å»ºåœ°å€
        Address address = new Address();
        address.setUserId(userId);
        address.setReceiverName(dto.getReceiverName());
        address.setReceiverPhone(dto.getReceiverPhone());
        address.setProvince(dto.getProvince());
        address.setCity(dto.getCity());
        address.setDistrict(dto.getDistrict());
        address.setDetailAddress(dto.getDetailAddress());
        address.setPostalCode(dto.getPostalCode());
        // æ‹¼æ¥å®Œæ•´åœ°å€ï¼ˆçœ+å¸‚+åŒº+è¯¦ç»†åœ°å€ï¼‰
        address.setFullAddress(dto.getProvince() + dto.getCity() + dto.getDistrict() + dto.getDetailAddress());
        address.setIsDefault(dto.getIsDefault() != null ? dto.getIsDefault() : 0);
        address.setDeleteFlag(0);
        address.setCreateTime(new Date());
        address.setUpdateTime(new Date());
        
        addressMapper.insert(address);
        return address.getId();
    }
    
    /**
     * æ›´æ–°æ”¶è´§åœ°å€
     */
    @Transactional(rollbackFor = Exception.class)
    public void updateAddress(Long addressId, AddressDTO dto, Long userId) {
        Address address = addressMapper.selectById(addressId);
        if (address == null || !address.getUserId().equals(userId)) {
            throw new BusinessException("åœ°å€ä¸å­˜åœ¨æˆ–æ— æƒæ“ä½œ");
        }
        
        // å¦‚æœè®¾ç½®ä¸ºé»˜è®¤åœ°å€ï¼Œå–æ¶ˆå…¶ä»–é»˜è®¤åœ°å€
        if (dto.getIsDefault() != null && dto.getIsDefault() == 1) {
            addressMapper.update(null, 
                new LambdaUpdateWrapper<Address>()
                    .eq(Address::getUserId, userId)
                    .eq(Address::getIsDefault, 1)
                    .set(Address::getIsDefault, 0)
            );
        }
        
        // æ›´æ–°åœ°å€ä¿¡æ¯
        address.setReceiverName(dto.getReceiverName());
        address.setReceiverPhone(dto.getReceiverPhone());
        address.setProvince(dto.getProvince());
        address.setCity(dto.getCity());
        address.setDistrict(dto.getDistrict());
        address.setDetailAddress(dto.getDetailAddress());
        address.setPostalCode(dto.getPostalCode());
        // æ›´æ–°å®Œæ•´åœ°å€
        address.setFullAddress(dto.getProvince() + dto.getCity() + dto.getDistrict() + dto.getDetailAddress());
        address.setIsDefault(dto.getIsDefault() != null ? dto.getIsDefault() : address.getIsDefault());
        address.setUpdateTime(new Date());
        
        addressMapper.updateById(address);
    }
    
    /**
     * åˆ é™¤æ”¶è´§åœ°å€
     */
    @Transactional(rollbackFor = Exception.class)
    public void deleteAddress(Long addressId, Long userId) {
        Address address = addressMapper.selectById(addressId);
        if (address == null || !address.getUserId().equals(userId)) {
            throw new BusinessException("åœ°å€ä¸å­˜åœ¨æˆ–æ— æƒæ“ä½œ");
        }
        
        // é€»è¾‘åˆ é™¤
        address.setDeleteFlag(1);
        address.setUpdateTime(new Date());
        addressMapper.updateById(address);
    }
    
    /**
     * è®¾ç½®é»˜è®¤åœ°å€
     */
    @Transactional(rollbackFor = Exception.class)
    public void setDefaultAddress(Long addressId, Long userId) {
        Address address = addressMapper.selectById(addressId);
        if (address == null || !address.getUserId().equals(userId)) {
            throw new BusinessException("åœ°å€ä¸å­˜åœ¨æˆ–æ— æƒæ“ä½œ");
        }
        
        // å–æ¶ˆå…¶ä»–é»˜è®¤åœ°å€
        addressMapper.update(null, 
            new LambdaUpdateWrapper<Address>()
                .eq(Address::getUserId, userId)
                .eq(Address::getIsDefault, 1)
                .set(Address::getIsDefault, 0)
        );
        
        // è®¾ç½®å½“å‰åœ°å€ä¸ºé»˜è®¤
        address.setIsDefault(1);
        address.setUpdateTime(new Date());
        addressMapper.updateById(address);
    }
}
```

#### 2.3.4 ä¿®æ”¹å•†å“äº¤æ˜“æ–¹å¼åŠŸèƒ½

**åŠŸèƒ½è¯´æ˜ï¼š**
- å–å®¶å¯ä»¥ä¿®æ”¹å•†å“çš„äº¤æ˜“æ–¹å¼ï¼ˆé‚®å¯„/è‡ªæï¼‰
- å¦‚æœå•†å“å·²æœ‰è®¢å•ï¼Œä¿®æ”¹äº¤æ˜“æ–¹å¼ä¸å½±å“å·²å­˜åœ¨çš„è®¢å•
- æ–°è®¢å•ä½¿ç”¨æ–°çš„äº¤æ˜“æ–¹å¼

**APIæ¥å£ï¼š**
```java
@RestController
@RequestMapping("/api/goods")
public class GoodsController {
    
    /**
     * ä¿®æ”¹å•†å“äº¤æ˜“æ–¹å¼
     */
    @PutMapping("/{id}/trade-method")
    @RequireVerification
    public Result<Void> updateTradeMethod(
            @PathVariable Long id,
            @RequestBody @Validated TradeMethodDTO dto) {
        Long userId = SecurityUtils.getCurrentUserId();
        goodsService.updateTradeMethod(id, dto, userId);
        return Result.success("ä¿®æ”¹æˆåŠŸ", null);
    }
}
```

**Serviceå®ç°ï¼š**
```java
@Service
public class GoodsService {
    
    /**
     * ä¿®æ”¹å•†å“äº¤æ˜“æ–¹å¼
     */
    @Transactional(rollbackFor = Exception.class)
    public void updateTradeMethod(Long goodsId, TradeMethodDTO dto, Long userId) {
        Goods goods = goodsMapper.selectById(goodsId);
        if (goods == null) {
            throw new BusinessException("å•†å“ä¸å­˜åœ¨");
        }
        
        if (!goods.getUserId().equals(userId)) {
            throw new BusinessException("æ— æƒä¿®æ”¹æ­¤å•†å“");
        }
        
        // éªŒè¯äº¤æ˜“æ–¹å¼
        if (!"MAIL".equals(dto.getTradeMethod()) && !"FACE_TO_FACE".equals(dto.getTradeMethod())) {
            throw new BusinessException("äº¤æ˜“æ–¹å¼åªèƒ½æ˜¯é‚®å¯„æˆ–è‡ªæ");
        }
        
        // æ›´æ–°äº¤æ˜“æ–¹å¼
        goods.setTradeMethod(dto.getTradeMethod());
        
        // å¦‚æœæ˜¯é‚®å¯„ï¼Œæ›´æ–°é‚®å¯„è´¹ç”¨
        if ("MAIL".equals(dto.getTradeMethod())) {
            goods.setShippingFee(dto.getShippingFee() != null ? dto.getShippingFee() : BigDecimal.ZERO);
            goods.setTradeLocation(null); // æ¸…ç©ºè‡ªæåœ°ç‚¹
        }
        
        // å¦‚æœæ˜¯è‡ªæï¼Œæ›´æ–°è‡ªæåœ°ç‚¹
        if ("FACE_TO_FACE".equals(dto.getTradeMethod())) {
            if (dto.getTradeLocation() == null || dto.getTradeLocation().trim().isEmpty()) {
                throw new BusinessException("è‡ªææ–¹å¼å¿…é¡»å¡«å†™è‡ªæåœ°ç‚¹");
            }
            goods.setTradeLocation(dto.getTradeLocation().trim());
            goods.setShippingFee(BigDecimal.ZERO); // æ¸…ç©ºé‚®å¯„è´¹ç”¨
        }
        
        goods.setUpdateTime(new Date());
        goodsMapper.updateById(goods);
        
        // å‘é€ç³»ç»Ÿæ¶ˆæ¯ç»™æ‰€æœ‰å·²ä¸‹å•çš„ä¹°å®¶ï¼ˆå¯é€‰ï¼Œæç¤ºäº¤æ˜“æ–¹å¼å˜æ›´ï¼‰
        // æ³¨æ„ï¼šå·²å­˜åœ¨çš„è®¢å•ä¸å—å½±å“ï¼Œåªæ˜¯æç¤ºæ–°è®¢å•ä¼šä½¿ç”¨æ–°çš„äº¤æ˜“æ–¹å¼
    }
}
```

#### 2.3.5 æˆ‘çš„äº¤æ˜“é¡µé¢

**åŠŸèƒ½è¯´æ˜ï¼š**
- ç”¨æˆ·æŸ¥çœ‹æ‰€æœ‰äº¤æ˜“è®¢å•çš„é¡µé¢
- æ”¯æŒæŸ¥çœ‹ä½œä¸ºä¹°å®¶çš„è®¢å•å’Œä½œä¸ºå–å®¶çš„è®¢å•
- æ”¯æŒè®¢å•ç­›é€‰ã€æœç´¢ã€è¯¦æƒ…æŸ¥çœ‹å’Œæ“ä½œ

**é¡µé¢è·¯å¾„ï¼š** `/order/list` æˆ– `/user/orders`

**é¡µé¢åŠŸèƒ½ï¼š**

**1. è®¢å•åˆ—è¡¨å±•ç¤ºï¼š**
- ä½¿ç”¨æ ‡ç­¾é¡µï¼ˆTabsï¼‰åŒºåˆ†"æˆ‘ä¹°åˆ°çš„"å’Œ"æˆ‘å–å‡ºçš„"
- æ¯ä¸ªè®¢å•å¡ç‰‡æ˜¾ç¤ºï¼š
  - è®¢å•å·ï¼ˆå¯ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…ï¼‰
  - å•†å“ä¿¡æ¯ï¼ˆç¼©ç•¥å›¾ã€æ ‡é¢˜ã€ä»·æ ¼ã€æ•°é‡ï¼‰
  - äº¤æ˜“æ–¹å¼ï¼ˆé‚®å¯„/è‡ªæï¼‰
  - è®¢å•çŠ¶æ€ï¼ˆå¸¦çŠ¶æ€æ ‡ç­¾å’Œé¢œè‰²ï¼‰
  - è®¢å•æ—¶é—´ï¼ˆåˆ›å»ºæ—¶é—´ã€ä»˜æ¬¾æ—¶é—´ã€å®Œæˆæ—¶é—´ç­‰ï¼‰
  - è®¢å•é‡‘é¢ï¼ˆæ€»é‡‘é¢ã€é‚®å¯„è´¹ç”¨ï¼‰
  - å¯¹æ–¹ä¿¡æ¯ï¼ˆä¹°å®¶/å–å®¶å¤´åƒã€æ˜µç§°ï¼‰
  - å¿«æ·æ“ä½œæŒ‰é’®ï¼ˆæ ¹æ®è®¢å•çŠ¶æ€å’Œç”¨æˆ·è§’è‰²æ˜¾ç¤ºï¼‰

**2. è®¢å•ç­›é€‰ï¼š**
- çŠ¶æ€ç­›é€‰ï¼ˆå…¨éƒ¨ã€å¾…ä»˜æ¬¾ã€å·²ä»˜æ¬¾ã€å·²å‘è´§ã€å¾…è‡ªæã€å·²å®Œæˆã€å·²å–æ¶ˆï¼‰
- æ—¶é—´ç­›é€‰ï¼ˆå…¨éƒ¨ã€ä»Šå¤©ã€è¿‘7å¤©ã€è¿‘30å¤©ã€è‡ªå®šä¹‰æ—¶é—´èŒƒå›´ï¼‰
- äº¤æ˜“æ–¹å¼ç­›é€‰ï¼ˆå…¨éƒ¨ã€é‚®å¯„ã€è‡ªæï¼‰
- è§’è‰²ç­›é€‰ï¼ˆæˆ‘ä¹°åˆ°çš„ã€æˆ‘å–å‡ºçš„ï¼‰

**3. è®¢å•æœç´¢ï¼š**
- æ”¯æŒæŒ‰è®¢å•å·æœç´¢
- æ”¯æŒæŒ‰å•†å“æ ‡é¢˜æœç´¢
- æ”¯æŒæŒ‰å¯¹æ–¹æ˜µç§°æœç´¢

**4. è®¢å•è¯¦æƒ…ï¼š**
- ç‚¹å‡»è®¢å•å¡ç‰‡æˆ–è®¢å•å·è¿›å…¥è®¢å•è¯¦æƒ…é¡µ
- æ˜¾ç¤ºå®Œæ•´çš„è®¢å•ä¿¡æ¯ï¼š
  - è®¢å•åŸºæœ¬ä¿¡æ¯ï¼ˆè®¢å•å·ã€çŠ¶æ€ã€åˆ›å»ºæ—¶é—´ç­‰ï¼‰
  - å•†å“è¯¦æƒ…ï¼ˆå›¾ç‰‡ã€æ ‡é¢˜ã€æè¿°ã€ä»·æ ¼ã€æ•°é‡ï¼‰
  - äº¤æ˜“ä¿¡æ¯ï¼ˆäº¤æ˜“æ–¹å¼ã€é‚®å¯„ä¿¡æ¯/è‡ªæä¿¡æ¯ï¼‰
  - ç‰©æµä¿¡æ¯ï¼ˆé‚®å¯„æ—¶ï¼šå¿«é€’å•å·ã€ç‰©æµå…¬å¸ã€å‘è´§æ—¶é—´ï¼‰
  - è®¢å•é‡‘é¢æ˜ç»†ï¼ˆå•†å“é‡‘é¢ã€é‚®å¯„è´¹ç”¨ã€æ€»é‡‘é¢ï¼‰
  - å¯¹æ–¹ä¿¡æ¯ï¼ˆå¤´åƒã€æ˜µç§°ã€è”ç³»æ–¹å¼ï¼‰
  - è®¢å•æ“ä½œæŒ‰é’®ï¼ˆä»˜æ¬¾ã€å‘è´§ã€ç¡®è®¤æ”¶è´§ã€å–æ¶ˆç­‰ï¼‰

**5. è®¢å•æ“ä½œï¼š**
- **ä½œä¸ºä¹°å®¶ï¼š**
  - å¾…ä»˜æ¬¾ï¼šä»˜æ¬¾ã€å–æ¶ˆè®¢å•
  - å·²ä»˜æ¬¾ï¼ˆé‚®å¯„ï¼‰ï¼šç­‰å¾…å–å®¶å‘è´§
  - å·²å‘è´§ï¼šæŸ¥çœ‹ç‰©æµã€ç¡®è®¤æ”¶è´§
  - å¾…è‡ªæï¼šæŸ¥çœ‹è‡ªæåœ°ç‚¹ã€ç¡®è®¤æ”¶è´§
  - å·²å®Œæˆï¼šæŸ¥çœ‹è®¢å•è¯¦æƒ…ã€è¯„ä»·ï¼ˆå¯é€‰ï¼‰
  - å·²å–æ¶ˆï¼šæŸ¥çœ‹å–æ¶ˆåŸå› 
- **ä½œä¸ºå–å®¶ï¼š**
  - å¾…ä»˜æ¬¾ï¼šæ”¹ä»·ã€ç­‰å¾…ä¹°å®¶ä»˜æ¬¾
  - å·²ä»˜æ¬¾ï¼ˆé‚®å¯„ï¼‰ï¼šå‘è´§ï¼ˆå¡«å†™å¿«é€’å•å·ï¼‰
  - å·²å‘è´§ï¼šç­‰å¾…ä¹°å®¶ç¡®è®¤æ”¶è´§
  - å¾…è‡ªæï¼šç­‰å¾…ä¹°å®¶è‡ªæå¹¶ç¡®è®¤æ”¶è´§
  - å·²å®Œæˆï¼šæŸ¥çœ‹è®¢å•è¯¦æƒ…ã€è¯„ä»·ï¼ˆå¯é€‰ï¼‰
  - å·²å–æ¶ˆï¼šæŸ¥çœ‹å–æ¶ˆåŸå› 

**6. è®¢å•ç»Ÿè®¡ï¼š**
- æ˜¾ç¤ºè®¢å•æ•°é‡ç»Ÿè®¡ï¼ˆå„çŠ¶æ€è®¢å•æ•°é‡ï¼‰
- æ˜¾ç¤ºäº¤æ˜“é‡‘é¢ç»Ÿè®¡ï¼ˆæ€»äº¤æ˜“é¢ã€æœ¬æœˆäº¤æ˜“é¢ç­‰ï¼‰

**APIæ¥å£ï¼š**
```java
@RestController
@RequestMapping("/api/order")
public class OrderController {
    
    /**
     * è·å–æˆ‘çš„è®¢å•åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰
     * @param role è§’è‰²ï¼šBUYER-æˆ‘ä¹°åˆ°çš„ï¼ŒSELLER-æˆ‘å–å‡ºçš„ï¼ŒALL-å…¨éƒ¨
     * @param status è®¢å•çŠ¶æ€ç­›é€‰
     * @param tradeMethod äº¤æ˜“æ–¹å¼ç­›é€‰
     * @param startTime å¼€å§‹æ—¶é—´
     * @param endTime ç»“æŸæ—¶é—´
     * @param keyword å…³é”®è¯ï¼ˆè®¢å•å·ã€å•†å“æ ‡é¢˜ã€å¯¹æ–¹æ˜µç§°ï¼‰
     * @param pageNum é¡µç 
     * @param pageSize æ¯é¡µæ•°é‡
     */
    @GetMapping("/list")
    @PreAuthorize("hasAuthority('ROLE_USER') or hasAuthority('ROLE_ADMIN')")
    public Result<Page<Order>> getMyOrderList(
            @RequestParam(required = false, defaultValue = "ALL") String role,
            @RequestParam(required = false) String status,
            @RequestParam(required = false) String tradeMethod,
            @RequestParam(required = false) String startTime,
            @RequestParam(required = false) String endTime,
            @RequestParam(required = false) String keyword,
            @RequestParam(required = false, defaultValue = "1") Integer pageNum,
            @RequestParam(required = false, defaultValue = "10") Integer pageSize) {
        Long userId = SecurityUtils.getCurrentUserId();
        Page<Order> page = orderService.getMyOrderList(userId, role, status, tradeMethod, 
                startTime, endTime, keyword, pageNum, pageSize);
        return Result.success("æŸ¥è¯¢æˆåŠŸ", page);
    }
    
    /**
     * è·å–è®¢å•è¯¦æƒ…
     */
    @GetMapping("/{id}")
    @PreAuthorize("hasAuthority('ROLE_USER') or hasAuthority('ROLE_ADMIN')")
    public Result<OrderDetailVO> getOrderDetail(@PathVariable Long id) {
        Long userId = SecurityUtils.getCurrentUserId();
        OrderDetailVO detail = orderService.getOrderDetail(id, userId);
        return Result.success("æŸ¥è¯¢æˆåŠŸ", detail);
    }
    
    /**
     * è·å–è®¢å•ç»Ÿè®¡ä¿¡æ¯
     */
    @GetMapping("/statistics")
    @PreAuthorize("hasAuthority('ROLE_USER') or hasAuthority('ROLE_ADMIN')")
    public Result<OrderStatisticsVO> getOrderStatistics() {
        Long userId = SecurityUtils.getCurrentUserId();
        OrderStatisticsVO statistics = orderService.getOrderStatistics(userId);
        return Result.success("æŸ¥è¯¢æˆåŠŸ", statistics);
    }
}
```

**Serviceå®ç°ï¼š**
```java
@Service
public class OrderService {
    
    /**
     * è·å–æˆ‘çš„è®¢å•åˆ—è¡¨
     */
    public Page<Order> getMyOrderList(Long userId, String role, String status, 
            String tradeMethod, String startTime, String endTime, String keyword,
            Integer pageNum, Integer pageSize) {
        
        Page<Order> page = new Page<>(pageNum, pageSize);
        LambdaQueryWrapper<Order> wrapper = new LambdaQueryWrapper<>();
        
        // æ ¹æ®è§’è‰²ç­›é€‰
        if ("BUYER".equals(role)) {
            wrapper.eq(Order::getBuyerId, userId);
        } else if ("SELLER".equals(role)) {
            wrapper.eq(Order::getSellerId, userId);
        } else {
            // ALLï¼šæŸ¥è¯¢ä½œä¸ºä¹°å®¶æˆ–å–å®¶çš„è®¢å•
            wrapper.and(w -> w.eq(Order::getBuyerId, userId)
                             .or()
                             .eq(Order::getSellerId, userId));
        }
        
        // çŠ¶æ€ç­›é€‰
        if (StringUtils.hasText(status)) {
            wrapper.eq(Order::getStatus, status);
        }
        
        // äº¤æ˜“æ–¹å¼ç­›é€‰
        if (StringUtils.hasText(tradeMethod)) {
            wrapper.eq(Order::getTradeMethod, tradeMethod);
        }
        
        // æ—¶é—´èŒƒå›´ç­›é€‰
        if (StringUtils.hasText(startTime)) {
            wrapper.ge(Order::getCreateTime, LocalDateTime.parse(startTime));
        }
        if (StringUtils.hasText(endTime)) {
            wrapper.le(Order::getCreateTime, LocalDateTime.parse(endTime));
        }
        
        // å…³é”®è¯æœç´¢ï¼ˆè®¢å•å·ã€å•†å“æ ‡é¢˜ï¼‰
        if (StringUtils.hasText(keyword)) {
            wrapper.and(w -> w.like(Order::getOrderNo, keyword)
                             .or()
                             .exists("SELECT 1 FROM goods g WHERE g.id = order.goods_id AND g.title LIKE {0}", 
                                     "%" + keyword + "%"));
        }
        
        // é€»è¾‘åˆ é™¤è¿‡æ»¤
        wrapper.eq(Order::getDeleteFlag, 0);
        
        // æŒ‰åˆ›å»ºæ—¶é—´å€’åº
        wrapper.orderByDesc(Order::getCreateTime);
        
        return orderMapper.selectPage(page, wrapper);
    }
    
    /**
     * è·å–è®¢å•è¯¦æƒ…ï¼ˆåŒ…å«å•†å“ä¿¡æ¯å’Œå¯¹æ–¹ä¿¡æ¯ï¼‰
     */
    public OrderDetailVO getOrderDetail(Long orderId, Long userId) {
        Order order = orderMapper.selectById(orderId);
        if (order == null) {
            throw new BusinessException("è®¢å•ä¸å­˜åœ¨");
        }
        
        // éªŒè¯æƒé™ï¼ˆåªæœ‰ä¹°å®¶æˆ–å–å®¶å¯ä»¥æŸ¥çœ‹ï¼‰
        if (!order.getBuyerId().equals(userId) && !order.getSellerId().equals(userId)) {
            throw new BusinessException("æ— æƒæŸ¥çœ‹æ­¤è®¢å•");
        }
        
        // æŸ¥è¯¢å•†å“ä¿¡æ¯
        Goods goods = goodsMapper.selectById(order.getGoodsId());
        
        // æŸ¥è¯¢å¯¹æ–¹ä¿¡æ¯
        User otherUser = null;
        String userRole = null;
        if (order.getBuyerId().equals(userId)) {
            otherUser = userMapper.selectById(order.getSellerId());
            userRole = "SELLER";
        } else {
            otherUser = userMapper.selectById(order.getBuyerId());
            userRole = "BUYER";
        }
        
        // æ„å»ºè¯¦æƒ…VO
        OrderDetailVO detail = new OrderDetailVO();
        detail.setOrder(order);
        detail.setGoods(goods);
        detail.setOtherUser(otherUser);
        detail.setUserRole(userRole);
        
        return detail;
    }
    
    /**
     * è·å–è®¢å•ç»Ÿè®¡ä¿¡æ¯
     */
    public OrderStatisticsVO getOrderStatistics(Long userId) {
        OrderStatisticsVO statistics = new OrderStatisticsVO();
        
        // ä½œä¸ºä¹°å®¶çš„è®¢å•ç»Ÿè®¡
        statistics.setBuyerTotal(orderMapper.selectCount(
            new LambdaQueryWrapper<Order>()
                .eq(Order::getBuyerId, userId)
                .eq(Order::getDeleteFlag, 0)
        ));
        
        statistics.setBuyerPendingPayment(orderMapper.selectCount(
            new LambdaQueryWrapper<Order>()
                .eq(Order::getBuyerId, userId)
                .eq(Order::getStatus, "PENDING_PAYMENT")
                .eq(Order::getDeleteFlag, 0)
        ));
        
        statistics.setBuyerPendingReceipt(orderMapper.selectCount(
            new LambdaQueryWrapper<Order>()
                .eq(Order::getBuyerId, userId)
                .in(Order::getStatus, Arrays.asList("SHIPPED", "PENDING_PICKUP"))
                .eq(Order::getDeleteFlag, 0)
        ));
        
        // ä½œä¸ºå–å®¶çš„è®¢å•ç»Ÿè®¡
        statistics.setSellerTotal(orderMapper.selectCount(
            new LambdaQueryWrapper<Order>()
                .eq(Order::getSellerId, userId)
                .eq(Order::getDeleteFlag, 0)
        ));
        
        statistics.setSellerPendingShipment(orderMapper.selectCount(
            new LambdaQueryWrapper<Order>()
                .eq(Order::getSellerId, userId)
                .eq(Order::getStatus, "PAID")
                .eq(Order::getTradeMethod, "MAIL")
                .eq(Order::getDeleteFlag, 0)
        ));
        
        // äº¤æ˜“é‡‘é¢ç»Ÿè®¡ï¼ˆæœ¬æœˆï¼‰
        LocalDateTime startOfMonth = LocalDateTime.now().withDayOfMonth(1).withHour(0).withMinute(0).withSecond(0);
        List<Order> completedOrders = orderMapper.selectList(
            new LambdaQueryWrapper<Order>()
                .and(w -> w.eq(Order::getBuyerId, userId).or().eq(Order::getSellerId, userId))
                .eq(Order::getStatus, "COMPLETED")
                .ge(Order::getCreateTime, startOfMonth)
                .eq(Order::getDeleteFlag, 0)
        );
        
        BigDecimal monthlyAmount = completedOrders.stream()
            .map(Order::getTotalAmount)
            .reduce(BigDecimal.ZERO, BigDecimal::add);
        statistics.setMonthlyAmount(monthlyAmount);
        
        return statistics;
    }
}
```

**å‰ç«¯é¡µé¢ç»“æ„ï¼š**
```vue
<template>
  <div class="order-list-container">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <h1 class="page-title">æˆ‘çš„äº¤æ˜“</h1>
    
    <!-- è®¢å•ç»Ÿè®¡å¡ç‰‡ -->
    <div class="statistics-cards">
      <el-card v-for="stat in statistics" :key="stat.label">
        <div class="stat-item">
          <div class="stat-value">{{ stat.value }}</div>
          <div class="stat-label">{{ stat.label }}</div>
        </div>
      </el-card>
    </div>
    
    <!-- æ ‡ç­¾é¡µï¼šæˆ‘ä¹°åˆ°çš„ / æˆ‘å–å‡ºçš„ -->
    <el-tabs v-model="activeTab" @tab-change="handleTabChange">
      <el-tab-pane label="æˆ‘ä¹°åˆ°çš„" name="BUYER">
        <OrderList 
          :role="'BUYER'"
          :filters="filters"
          @order-click="handleOrderClick"
        />
      </el-tab-pane>
      <el-tab-pane label="æˆ‘å–å‡ºçš„" name="SELLER">
        <OrderList 
          :role="'SELLER'"
          :filters="filters"
          @order-click="handleOrderClick"
        />
      </el-tab-pane>
    </el-tabs>
  </div>
</template>
```

#### 2.3.6 èŠå¤©é¡µé¢é›†æˆè®¢å•åŠŸèƒ½

**æ–¹æ¡ˆé€‰æ‹©ï¼šå¤ç”¨ç°æœ‰èŠå¤©ç»„ä»¶**

**ç†ç”±ï¼š**
1. ç°æœ‰èŠå¤©ç»„ä»¶åŠŸèƒ½å®Œå–„ï¼ˆæ¶ˆæ¯å‘é€ã€å›¾ç‰‡ä¸Šä¼ ã€å·²è¯»çŠ¶æ€ç­‰ï¼‰
2. è®¢å•ç›¸å…³åŠŸèƒ½ä½œä¸ºèŠå¤©é¡µé¢çš„æ‰©å±•æ¨¡å—ï¼Œæ— éœ€é‡æ–°å¼€å‘
3. ç”¨æˆ·ä½“éªŒç»Ÿä¸€ï¼Œè®¢å•å’ŒèŠå¤©åœ¨åŒä¸€ç•Œé¢ï¼Œæ–¹ä¾¿æ²Ÿé€š

**å®ç°æ–¹æ¡ˆï¼š**

**1. èŠå¤©é¡µé¢è®¢å•å¡ç‰‡æ˜¾ç¤ºï¼š**
- å½“ä¼šè¯ç±»å‹ä¸º `GOODS` ä¸”å­˜åœ¨å…³è”è®¢å•æ—¶ï¼Œåœ¨èŠå¤©çª—å£é¡¶éƒ¨æ˜¾ç¤ºè®¢å•ä¿¡æ¯å¡ç‰‡
- è®¢å•å¡ç‰‡æ˜¾ç¤ºï¼š
  - **è®¢å•å·**ï¼ˆå”¯ä¸€æ ‡è¯†ï¼Œæ ¼å¼ï¼šGO+æ—¶é—´æˆ³13ä½+ç”¨æˆ·IDå2ä½ï¼Œç¤ºä¾‹ï¼šGO170406720000012ï¼‰
  - å•†å“ä¿¡æ¯ï¼ˆç¼©ç•¥å›¾ã€æ ‡é¢˜ã€ä»·æ ¼ã€æ•°é‡ï¼‰
  - è®¢å•çŠ¶æ€ï¼ˆå¸¦çŠ¶æ€æ ‡ç­¾ï¼‰
  - äº¤æ˜“æ–¹å¼ï¼ˆé‚®å¯„/è‡ªæï¼‰
  - é‚®å¯„ä¿¡æ¯ï¼ˆé‚®å¯„æ—¶æ˜¾ç¤ºï¼šæ”¶è´§åœ°å€ã€å¿«é€’å•å·ã€ç‰©æµå…¬å¸ï¼‰
  - è‡ªæä¿¡æ¯ï¼ˆè‡ªææ—¶æ˜¾ç¤ºï¼šè‡ªæåœ°ç‚¹ï¼‰
  - è®¢å•æ“ä½œæŒ‰é’®ï¼ˆæ ¹æ®è®¢å•çŠ¶æ€å’Œç”¨æˆ·è§’è‰²æ˜¾ç¤ºï¼‰
    - ä¹°å®¶ï¼šé€‰æ‹©æ”¶è´§åœ°å€ï¼ˆé‚®å¯„æ—¶ï¼‰ã€ä»˜æ¬¾ã€ç¡®è®¤æ”¶è´§ã€å–æ¶ˆè®¢å•
    - å–å®¶ï¼šæ”¹ä»·ã€å‘è´§ï¼ˆä»…é‚®å¯„æ—¶ï¼Œå¡«å†™å¿«é€’å•å·ï¼‰
    - **æ³¨æ„ï¼šè‡ªææ–¹å¼æ— éœ€å‘è´§æ“ä½œï¼Œä¹°å®¶ä»˜æ¬¾åè‡ªåŠ¨è¿›å…¥å¾…è‡ªæçŠ¶æ€**

**2. è®¢å•æ“ä½œé›†æˆï¼š**
- æ‰€æœ‰è®¢å•æ“ä½œï¼ˆæ”¹ä»·ã€ä»˜æ¬¾ã€å‘è´§ã€ç¡®è®¤æ”¶è´§ï¼‰åœ¨èŠå¤©é¡µé¢çš„è®¢å•å¡ç‰‡ä¸­å®Œæˆ
- æ“ä½œåå®æ—¶æ›´æ–°è®¢å•å¡ç‰‡çŠ¶æ€
- é‡è¦æ“ä½œï¼ˆå¦‚æ”¹ä»·ã€å‘è´§ï¼‰è‡ªåŠ¨å‘é€ç³»ç»Ÿæ¶ˆæ¯åˆ°èŠå¤©çª—å£

**3. å‰ç«¯å®ç°ï¼š**
```vue
<!-- Chat.vue ä¸­å¢åŠ è®¢å•å¡ç‰‡ç»„ä»¶ -->
<template>
  <div class="chat-window">
    <!-- è®¢å•ä¿¡æ¯å¡ç‰‡ï¼ˆä»…åœ¨GOODSç±»å‹ä¼šè¯ä¸”å­˜åœ¨è®¢å•æ—¶æ˜¾ç¤ºï¼‰ -->
    <div v-if="currentOrder" class="order-card">
      <OrderCard 
        :order="currentOrder" 
        :is-buyer="isBuyer"
        @update-order="handleOrderUpdate"
      />
    </div>
    
    <!-- åŸæœ‰çš„èŠå¤©æ¶ˆæ¯åˆ—è¡¨ -->
    <div class="messages-container">...</div>
    
    <!-- åŸæœ‰çš„è¾“å…¥æ¡† -->
    <div class="chat-input-area">...</div>
  </div>
</template>
```

**4. åç«¯æ”¯æŒï¼š**
- `ChatSession` å¢åŠ  `relatedId` å­—æ®µï¼ˆå…³è”å•†å“IDï¼‰
- `Order` è¡¨å¢åŠ  `sessionId` å­—æ®µï¼ˆå…³è”ä¼šè¯IDï¼‰
- åˆ›å»ºè®¢å•æ—¶ï¼Œè‡ªåŠ¨åˆ›å»ºæˆ–å…³è”èŠå¤©ä¼šè¯
- è®¢å•çŠ¶æ€å˜æ›´æ—¶ï¼Œé€šè¿‡WebSocketæ¨é€æ›´æ–°åˆ°èŠå¤©é¡µé¢

**è®¢å•åˆ›å»ºå®ç°ï¼ˆé˜²æ­¢è¶…å–ï¼‰ï¼š**
```java
@Service
public class OrderService {
    
    /**
     * åˆ›å»ºè®¢å•ï¼ˆä½¿ç”¨ä¹è§‚é”+åº“å­˜æ£€æŸ¥é˜²æ­¢è¶…å–ï¼‰
     */
    @Transactional(rollbackFor = Exception.class)
    public Long createOrder(OrderDTO dto, Long userId) {
        // 1. éªŒè¯å®åè®¤è¯
        User user = userMapper.selectById(userId);
        if (user.getIsVerified() != 1) {
            throw new BusinessException("è¯¥åŠŸèƒ½éœ€è¦å®åè®¤è¯ï¼Œè¯·å…ˆå®Œæˆå®åè®¤è¯");
        }
        
        // 2. éªŒè¯è´­ä¹°æ•°é‡
        if (dto.getQuantity() == null || dto.getQuantity() <= 0) {
            throw new BusinessException("è´­ä¹°æ•°é‡å¿…é¡»å¤§äº0");
        }
        
        // 3. æŸ¥è¯¢å•†å“ï¼ˆä½¿ç”¨æ‚²è§‚é”ï¼Œé˜²æ­¢å¹¶å‘ï¼‰
        Goods goods = goodsMapper.selectByIdForUpdate(dto.getGoodsId());
        if (goods == null) {
            throw new BusinessException("å•†å“ä¸å­˜åœ¨");
        }
        
        // 4. éªŒè¯å•†å“çŠ¶æ€
        if (!"ON_SALE".equals(goods.getStatus())) {
            throw new BusinessException("å•†å“å·²ä¸‹æ¶æˆ–å·²å”®å‡º");
        }
        
        // 5. ä¸èƒ½è´­ä¹°è‡ªå·±çš„å•†å“
        if (goods.getUserId().equals(userId)) {
            throw new BusinessException("ä¸èƒ½è´­ä¹°è‡ªå·±çš„å•†å“");
        }
        
        // 6. æ£€æŸ¥åº“å­˜ï¼ˆé˜²æ­¢è¶…å–ï¼‰
        if (goods.getStock() < dto.getQuantity()) {
            throw new BusinessException("åº“å­˜ä¸è¶³ï¼Œå½“å‰åº“å­˜ï¼š" + goods.getStock() + "ä»¶");
        }
        
        // 7. ä½¿ç”¨ä¹è§‚é”æ‰£å‡åº“å­˜
        int rows = goodsMapper.decreaseStockWithVersion(
            dto.getGoodsId(),
            dto.getQuantity(),
            goods.getVersion()
        );
        
        if (rows == 0) {
            throw new BusinessException("åº“å­˜ä¸è¶³æˆ–å•†å“å·²è¢«å…¶ä»–ä¹°å®¶è´­ä¹°ï¼Œè¯·åˆ·æ–°åé‡è¯•");
        }
        
        // 8. å¦‚æœåº“å­˜ä¸º0ï¼Œæ›´æ–°å•†å“çŠ¶æ€ä¸ºå·²å”®å®Œ
        Goods updatedGoods = goodsMapper.selectById(dto.getGoodsId());
        if (updatedGoods.getStock() == 0) {
            goodsMapper.updateStatus(dto.getGoodsId(), "SOLD_OUT");
        }
        
        // 9. ç”Ÿæˆå”¯ä¸€è®¢å•å·
        String orderNo = generateOrderNo();
        
        // 10. åˆ›å»ºè®¢å•
        Order order = new Order();
        order.setOrderNo(orderNo); // å”¯ä¸€è®¢å•å·
        order.setGoodsId(dto.getGoodsId());
        order.setBuyerId(userId);
        order.setSellerId(goods.getUserId());
        order.setQuantity(dto.getQuantity());
        order.setPrice(goods.getCurrentPrice());
        order.setTotalAmount(goods.getCurrentPrice().multiply(new BigDecimal(dto.getQuantity())));
        order.setTradeMethod(dto.getTradeMethod());
        
        // é‚®å¯„æ–¹å¼éœ€è¦é€‰æ‹©æ”¶è´§åœ°å€
        if ("MAIL".equals(dto.getTradeMethod())) {
            // éªŒè¯æ”¶è´§åœ°å€ID
            if (dto.getAddressId() == null) {
                throw new BusinessException("é‚®å¯„æ–¹å¼å¿…é¡»é€‰æ‹©æ”¶è´§åœ°å€");
            }
            
            // æŸ¥è¯¢æ”¶è´§åœ°å€
            Address address = addressMapper.selectById(dto.getAddressId());
            if (address == null || !address.getUserId().equals(userId)) {
                throw new BusinessException("æ”¶è´§åœ°å€ä¸å­˜åœ¨æˆ–æ— æƒä½¿ç”¨");
            }
            
            order.setReceiverName(address.getReceiverName());
            order.setReceiverPhone(address.getReceiverPhone());
            order.setReceiverAddress(address.getFullAddress());
            order.setShippingFee(goods.getShippingFee() != null ? goods.getShippingFee() : BigDecimal.ZERO);
        }
        
        // è‡ªææ–¹å¼ä½¿ç”¨å•†å“çš„è‡ªæåœ°ç‚¹
        if ("FACE_TO_FACE".equals(dto.getTradeMethod())) {
            order.setPickupLocation(goods.getTradeLocation());
        }
        
        // è®¾ç½®åˆå§‹è®¢å•çŠ¶æ€
        order.setStatus("PENDING_PAYMENT");
        order.setCreateTime(new Date());
        orderMapper.insert(order);
        
        // 11. åˆ›å»ºæˆ–è·å–ç§ä¿¡ä¼šè¯
        ChatSession session = chatSessionService.getOrCreateSession(
            userId, 
            goods.getUserId(), 
            "GOODS", 
            goods.getId()
        );
        
        // 12. å…³è”è®¢å•å’Œä¼šè¯
        order.setSessionId(session.getId());
        orderMapper.updateById(order);
        
        // 13. å‘é€é€šçŸ¥ç»™å–å®¶
        systemMessageService.sendMessage(
            goods.getUserId(),
            "ORDER_CREATED",
            "æ”¶åˆ°æ–°è®¢å•",
            "æ‚¨çš„å•†å“ã€Š" + goods.getTitle() + "ã€‹è¢«è´­ä¹°äº†ï¼Œè®¢å•å·ï¼š" + orderNo,
            "ORDER",
            order.getId()
        );
        
        return order.getId();
    }
    
    /**
     * ç”Ÿæˆå”¯ä¸€è®¢å•å·ï¼ˆä½¿ç”¨æ—¶é—´æˆ³ï¼‰
     * æ ¼å¼ï¼šGO + æ—¶é—´æˆ³ï¼ˆ13ä½æ¯«ç§’ï¼‰ + ç”¨æˆ·IDå2ä½
     * ç¤ºä¾‹ï¼šGO170406720000012ï¼ˆGO + 1704067200000 + 12ï¼‰
     * 
     * ä¼˜åŠ¿ï¼š
     * 1. æ—¶é—´æˆ³å¤©ç„¶å”¯ä¸€ï¼Œä¸éœ€è¦æ£€æŸ¥é‡å¤
     * 2. å¯ä»¥åæ˜ è®¢å•åˆ›å»ºæ—¶é—´
     * 3. ç®€æ´é«˜æ•ˆï¼Œæ— éœ€é‡è¯•æœºåˆ¶
     * 4. ç”¨æˆ·IDåç¼€ä¾¿äºè¯†åˆ«å’Œè°ƒè¯•
     */
    private String generateOrderNo() {
        // 1. è·å–å½“å‰æ—¶é—´æˆ³ï¼ˆ13ä½æ¯«ç§’æ—¶é—´æˆ³ï¼‰
        long timestamp = System.currentTimeMillis();
        
        // 2. è·å–å½“å‰ç”¨æˆ·IDçš„å2ä½ï¼ˆå¦‚æœç”¨æˆ·IDä¸è¶³2ä½ï¼Œå‰é¢è¡¥0ï¼‰
        Long userId = SecurityUtils.getCurrentUserId();
        String userIdSuffix = String.format("%02d", userId % 100);
        
        // 3. ç»„åˆè®¢å•å·ï¼šGO + æ—¶é—´æˆ³ + ç”¨æˆ·IDåç¼€
        String orderNo = "GO" + timestamp + userIdSuffix;
        
        // æ³¨æ„ï¼šæ—¶é—´æˆ³åœ¨æ¯«ç§’çº§æ˜¯å”¯ä¸€çš„ï¼Œç†è®ºä¸Šä¸éœ€è¦æ£€æŸ¥é‡å¤
        // ä½†åœ¨æç«¯é«˜å¹¶å‘æƒ…å†µä¸‹ï¼ˆåŒä¸€æ¯«ç§’å†…å¤šä¸ªè®¢å•ï¼‰ï¼Œå¯ä»¥æ·»åŠ åºåˆ—å·æˆ–ä½¿ç”¨åˆ†å¸ƒå¼IDç”Ÿæˆå™¨
        
        return orderNo;
    }
    
    /**
     * ç”Ÿæˆå”¯ä¸€è®¢å•å·ï¼ˆé«˜å¹¶å‘ä¼˜åŒ–ç‰ˆæœ¬ï¼Œä½¿ç”¨æ—¶é—´æˆ³ + åºåˆ—å·ï¼‰
     * æ ¼å¼ï¼šGO + æ—¶é—´æˆ³ï¼ˆ13ä½ï¼‰ + åºåˆ—å·ï¼ˆ3ä½ï¼‰ + ç”¨æˆ·IDå2ä½
     * é€‚ç”¨äºé«˜å¹¶å‘åœºæ™¯ï¼Œç¡®ä¿åŒä¸€æ¯«ç§’å†…ç”Ÿæˆçš„è®¢å•å·å”¯ä¸€
     */
    private String generateOrderNoWithSequence() {
        // 1. è·å–å½“å‰æ—¶é—´æˆ³ï¼ˆ13ä½æ¯«ç§’æ—¶é—´æˆ³ï¼‰
        long timestamp = System.currentTimeMillis();
        
        // 2. è·å–åºåˆ—å·ï¼ˆåŒä¸€æ¯«ç§’å†…çš„åºå·ï¼Œ0-999ï¼‰
        // å¯ä»¥ä½¿ç”¨Redisè‡ªå¢æˆ–æ•°æ®åº“åºåˆ—ï¼Œè¿™é‡Œä½¿ç”¨ç®€å•çš„æ—¶é—´æˆ³å3ä½ + éšæœºæ•°
        int sequence = (int) (timestamp % 1000);
        
        // 3. è·å–å½“å‰ç”¨æˆ·IDçš„å2ä½
        Long userId = SecurityUtils.getCurrentUserId();
        String userIdSuffix = String.format("%02d", userId % 100);
        
        // 4. ç»„åˆè®¢å•å·ï¼šGO + æ—¶é—´æˆ³ + åºåˆ—å· + ç”¨æˆ·IDåç¼€
        String orderNo = "GO" + timestamp + String.format("%03d", sequence) + userIdSuffix;
        
        return orderNo;
    }
}
```

**è®¢å•çŠ¶æ€ç®¡ç†å®ç°ï¼š**

```java
@Service
public class OrderService {
    
    /**
     * å–å®¶æ”¹ä»·
     */
    @Transactional(rollbackFor = Exception.class)
    public void updateOrderPrice(Long orderId, BigDecimal newPrice, Long sellerId) {
        Order order = orderMapper.selectById(orderId);
        if (order == null) {
            throw new BusinessException("è®¢å•ä¸å­˜åœ¨");
        }
        
        if (!order.getSellerId().equals(sellerId)) {
            throw new BusinessException("æ— æƒä¿®æ”¹æ­¤è®¢å•");
        }
        
        if (!"PENDING_PAYMENT".equals(order.getStatus())) {
            throw new BusinessException("åªæœ‰å¾…ä»˜æ¬¾è®¢å•æ‰èƒ½æ”¹ä»·");
        }
        
        if (newPrice.compareTo(BigDecimal.ZERO) <= 0) {
            throw new BusinessException("ä»·æ ¼å¿…é¡»å¤§äº0");
        }
        
        // æ›´æ–°è®¢å•ä»·æ ¼å’Œæ€»é‡‘é¢
        order.setPrice(newPrice);
        order.setTotalAmount(newPrice.multiply(new BigDecimal(order.getQuantity())));
        order.setUpdateTime(new Date());
        orderMapper.updateById(order);
        
        // å‘é€é€šçŸ¥ç»™ä¹°å®¶
        systemMessageService.sendMessage(
            order.getBuyerId(),
            "ORDER_PRICE_UPDATED",
            "è®¢å•ä»·æ ¼å·²ä¿®æ”¹",
            "è®¢å•å·ï¼š" + order.getOrderNo() + " çš„ä»·æ ¼å·²ä¿®æ”¹ä¸ºï¼š" + newPrice + "å…ƒ",
            "ORDER",
            orderId
        );
    }
    
    /**
     * ä¹°å®¶ä»˜æ¬¾
     */
    @Transactional(rollbackFor = Exception.class)
    public void payOrder(Long orderId, Long buyerId) {
        Order order = orderMapper.selectById(orderId);
        if (order == null) {
            throw new BusinessException("è®¢å•ä¸å­˜åœ¨");
        }
        
        if (!order.getBuyerId().equals(buyerId)) {
            throw new BusinessException("æ— æƒæ“ä½œæ­¤è®¢å•");
        }
        
        if (!"PENDING_PAYMENT".equals(order.getStatus())) {
            throw new BusinessException("è®¢å•çŠ¶æ€ä¸æ­£ç¡®ï¼Œæ— æ³•ä»˜æ¬¾");
        }
        
        // æ ¹æ®äº¤æ˜“æ–¹å¼è®¾ç½®è®¢å•çŠ¶æ€
        // é‚®å¯„æ–¹å¼ï¼šä»˜æ¬¾åè¿›å…¥"å·²ä»˜æ¬¾"çŠ¶æ€ï¼Œç­‰å¾…å–å®¶å‘è´§
        // è‡ªææ–¹å¼ï¼šä»˜æ¬¾åç›´æ¥è¿›å…¥"å¾…è‡ªæ"çŠ¶æ€ï¼Œæ— éœ€å‘è´§
        if ("MAIL".equals(order.getTradeMethod())) {
            order.setStatus("PAID");
            // å‘é€é€šçŸ¥ç»™å–å®¶ï¼ˆé‚®å¯„æ–¹å¼éœ€è¦å‘è´§ï¼‰
            systemMessageService.sendMessage(
                order.getSellerId(),
                "ORDER_PAID",
                "è®¢å•å·²ä»˜æ¬¾",
                "è®¢å•å·ï¼š" + order.getOrderNo() + " å·²ä»˜æ¬¾ï¼Œè¯·åŠæ—¶å‘è´§",
                "ORDER",
                orderId
            );
        } else if ("FACE_TO_FACE".equals(order.getTradeMethod())) {
            // è‡ªææ–¹å¼ï¼šä»˜æ¬¾åç›´æ¥è¿›å…¥å¾…è‡ªæçŠ¶æ€ï¼ˆæ— éœ€å‘è´§ï¼‰
            order.setStatus("PENDING_PICKUP");
            // å‘é€é€šçŸ¥ç»™å–å®¶ï¼ˆè‡ªææ–¹å¼æ— éœ€å‘è´§ï¼‰
            systemMessageService.sendMessage(
                order.getSellerId(),
                "ORDER_PAID",
                "è®¢å•å·²ä»˜æ¬¾",
                "è®¢å•å·ï¼š" + order.getOrderNo() + " å·²ä»˜æ¬¾ï¼ˆè‡ªææ–¹å¼ï¼Œæ— éœ€å‘è´§ï¼‰ï¼Œè¯·ç­‰å¾…ä¹°å®¶è‡ªæ",
                "ORDER",
                orderId
            );
        }
        
        order.setPayTime(new Date());
        order.setUpdateTime(new Date());
        orderMapper.updateById(order);
    }
    
    /**
     * å–å®¶å‘è´§ï¼ˆé‚®å¯„æ–¹å¼ï¼‰
     */
    @Transactional(rollbackFor = Exception.class)
    public void shipOrder(Long orderId, String trackingNumber, String logisticsCompany, Long sellerId) {
        Order order = orderMapper.selectById(orderId);
        if (order == null) {
            throw new BusinessException("è®¢å•ä¸å­˜åœ¨");
        }
        
        if (!order.getSellerId().equals(sellerId)) {
            throw new BusinessException("æ— æƒæ“ä½œæ­¤è®¢å•");
        }
        
        if (!"PAID".equals(order.getStatus())) {
            throw new BusinessException("è®¢å•çŠ¶æ€ä¸æ­£ç¡®ï¼Œæ— æ³•å‘è´§");
        }
        
        if (!"MAIL".equals(order.getTradeMethod())) {
            throw new BusinessException("è¯¥è®¢å•ä¸æ˜¯é‚®å¯„æ–¹å¼ï¼Œæ— æ³•å‘è´§");
        }
        
        // éªŒè¯å¿«é€’å•å·
        if (trackingNumber == null || trackingNumber.trim().isEmpty()) {
            throw new BusinessException("å¿«é€’å•å·ä¸èƒ½ä¸ºç©º");
        }
        
        // æ›´æ–°è®¢å•çŠ¶æ€å’Œç‰©æµä¿¡æ¯
        order.setStatus("SHIPPED");
        order.setTrackingNumber(trackingNumber.trim());
        order.setLogisticsCompany(logisticsCompany != null ? logisticsCompany.trim() : null);
        order.setShipTime(new Date());
        order.setUpdateTime(new Date());
        orderMapper.updateById(order);
        
        // å‘é€é€šçŸ¥ç»™ä¹°å®¶
        systemMessageService.sendMessage(
            order.getBuyerId(),
            "ORDER_SHIPPED",
            "è®¢å•å·²å‘è´§",
            "è®¢å•å·ï¼š" + order.getOrderNo() + " å·²å‘è´§ï¼Œå¿«é€’å•å·ï¼š" + trackingNumber,
            "ORDER",
            orderId
        );
    }
    
    /**
     * ä¹°å®¶ç¡®è®¤æ”¶è´§
     * æ”¯æŒé‚®å¯„å’Œè‡ªæä¸¤ç§æ–¹å¼
     */
    @Transactional(rollbackFor = Exception.class)
    public void confirmReceipt(Long orderId, Long buyerId) {
        Order order = orderMapper.selectById(orderId);
        if (order == null) {
            throw new BusinessException("è®¢å•ä¸å­˜åœ¨");
        }
        
        if (!order.getBuyerId().equals(buyerId)) {
            throw new BusinessException("æ— æƒæ“ä½œæ­¤è®¢å•");
        }
        
        // é‚®å¯„æ–¹å¼ï¼šéœ€è¦å·²å‘è´§çŠ¶æ€
        // è‡ªææ–¹å¼ï¼šéœ€è¦å¾…è‡ªæçŠ¶æ€ï¼ˆä»˜æ¬¾åè‡ªåŠ¨è¿›å…¥ï¼‰
        if ("MAIL".equals(order.getTradeMethod())) {
            if (!"SHIPPED".equals(order.getStatus())) {
                throw new BusinessException("è®¢å•çŠ¶æ€ä¸æ­£ç¡®ï¼Œæ— æ³•ç¡®è®¤æ”¶è´§ï¼ˆé‚®å¯„æ–¹å¼éœ€è¦å·²å‘è´§ï¼‰");
            }
        } else if ("FACE_TO_FACE".equals(order.getTradeMethod())) {
            if (!"PENDING_PICKUP".equals(order.getStatus())) {
                throw new BusinessException("è®¢å•çŠ¶æ€ä¸æ­£ç¡®ï¼Œæ— æ³•ç¡®è®¤æ”¶è´§ï¼ˆè‡ªææ–¹å¼éœ€è¦å¾…è‡ªæçŠ¶æ€ï¼‰");
            }
        } else {
            throw new BusinessException("è®¢å•äº¤æ˜“æ–¹å¼ä¸æ­£ç¡®");
        }
        
        // æ›´æ–°è®¢å•çŠ¶æ€
        order.setStatus("COMPLETED");
        order.setCompleteTime(new Date());
        order.setUpdateTime(new Date());
        orderMapper.updateById(order);
        
        // å‘é€é€šçŸ¥ç»™å–å®¶
        systemMessageService.sendMessage(
            order.getSellerId(),
            "ORDER_COMPLETED",
            "è®¢å•å·²å®Œæˆ",
            "è®¢å•å·ï¼š" + order.getOrderNo() + " ä¹°å®¶å·²ç¡®è®¤æ”¶è´§ï¼Œè®¢å•å®Œæˆ",
            "ORDER",
            orderId
        );
    }
    
    /**
     * å–æ¶ˆè®¢å•
     */
    @Transactional(rollbackFor = Exception.class)
    public void cancelOrder(Long orderId, Long userId, String reason) {
        Order order = orderMapper.selectById(orderId);
        if (order == null) {
            throw new BusinessException("è®¢å•ä¸å­˜åœ¨");
        }
        
        // åªæœ‰ä¹°å®¶æˆ–å–å®¶å¯ä»¥å–æ¶ˆè®¢å•
        if (!order.getBuyerId().equals(userId) && !order.getSellerId().equals(userId)) {
            throw new BusinessException("æ— æƒæ“ä½œæ­¤è®¢å•");
        }
        
        // åªæœ‰å¾…ä»˜æ¬¾è®¢å•å¯ä»¥å–æ¶ˆ
        if (!"PENDING_PAYMENT".equals(order.getStatus())) {
            throw new BusinessException("åªæœ‰å¾…ä»˜æ¬¾è®¢å•å¯ä»¥å–æ¶ˆ");
        }
        
        // æ¢å¤åº“å­˜
        Goods goods = goodsMapper.selectById(order.getGoodsId());
        goodsMapper.increaseStock(order.getGoodsId(), order.getQuantity());
        
        // å¦‚æœå•†å“çŠ¶æ€æ˜¯å·²å”®å®Œï¼Œæ¢å¤ä¸ºåœ¨å”®
        if ("SOLD_OUT".equals(goods.getStatus())) {
            goodsMapper.updateStatus(order.getGoodsId(), "ON_SALE");
        }
        
        // æ›´æ–°è®¢å•çŠ¶æ€
        order.setStatus("CANCELLED");
        order.setCancelReason(reason);
        order.setCancelTime(new Date());
        order.setUpdateTime(new Date());
        orderMapper.updateById(order);
        
        // å‘é€é€šçŸ¥ç»™å¯¹æ–¹
        Long otherUserId = order.getBuyerId().equals(userId) ? order.getSellerId() : order.getBuyerId();
        systemMessageService.sendMessage(
            otherUserId,
            "ORDER_CANCELLED",
            "è®¢å•å·²å–æ¶ˆ",
            "è®¢å•å·ï¼š" + order.getOrderNo() + " å·²å–æ¶ˆï¼ŒåŸå› ï¼š" + reason,
            "ORDER",
            orderId
        );
    }
}
```

**MyBatis Mapper æ–¹æ³•ï¼ˆé˜²æ­¢è¶…å–ï¼‰ï¼š**
```java
@Mapper
public interface GoodsMapper extends BaseMapper<Goods> {
    
    /**
     * ä½¿ç”¨æ‚²è§‚é”æŸ¥è¯¢å•†å“ï¼ˆé˜²æ­¢å¹¶å‘ï¼‰
     */
    @Select("SELECT * FROM goods WHERE id = #{id} FOR UPDATE")
    Goods selectByIdForUpdate(Long id);
    
    /**
     * ä½¿ç”¨ä¹è§‚é”æ‰£å‡åº“å­˜
     */
    @Update("UPDATE goods SET stock = stock - #{quantity}, version = version + 1 " +
            "WHERE id = #{goodsId} AND stock >= #{quantity} AND version = #{version}")
    int decreaseStockWithVersion(@Param("goodsId") Long goodsId, 
                                 @Param("quantity") Integer quantity, 
                                 @Param("version") Integer version);
    
    /**
     * å¢åŠ åº“å­˜ï¼ˆå–æ¶ˆè®¢å•æ—¶æ¢å¤åº“å­˜ï¼‰
     */
    @Update("UPDATE goods SET stock = stock + #{quantity} WHERE id = #{goodsId}")
    int increaseStock(@Param("goodsId") Long goodsId, @Param("quantity") Integer quantity);
    
    /**
     * æ›´æ–°å•†å“çŠ¶æ€
     */
    @Update("UPDATE goods SET status = #{status} WHERE id = #{id}")
    int updateStatus(@Param("id") Long id, @Param("status") String status);
}

@Mapper
public interface OrderMapper extends BaseMapper<Order> {
    
    /**
     * æ ¹æ®è®¢å•å·æŸ¥è¯¢è®¢å•
     */
    @Select("SELECT * FROM `order` WHERE order_no = #{orderNo} AND delete_flag = 0")
    Order selectByOrderNo(String orderNo);
}
```

---

### 2.4 è·‘è…¿æœåŠ¡æ¨¡å—

#### 2.4.1 ä»»åŠ¡å‘å¸ƒï¼ˆéœ€è¦å®åè®¤è¯ï¼‰

**æƒé™éªŒè¯ï¼š**
```java
@RestController
@RequestMapping("/api/task")
public class TaskController {
    
    /**
     * å‘å¸ƒä»»åŠ¡ï¼ˆéœ€è¦å®åè®¤è¯ï¼‰
     */
    @PostMapping("/publish")
    @RequireVerification // éªŒè¯å®åè®¤è¯
    public Result publishTask(@RequestBody @Validated TaskDTO dto) {
        Long userId = SecurityUtils.getCurrentUserId();
        Long taskId = taskService.publishTask(dto, userId);
        return Result.success(taskId);
    }
}
```

#### 2.4.2 æ¥å•æµç¨‹ï¼ˆéœ€è¦å®åè®¤è¯ï¼‰

**æ¥å•æµç¨‹ï¼š**
```
ç”¨æˆ·æµè§ˆä»»åŠ¡
    â†“
ç‚¹å‡»"æ¥å•"
    â†“
éªŒè¯å®åè®¤è¯ï¼ˆæœªè®¤è¯æç¤º"æ¥å•éœ€è¦å®åè®¤è¯"ï¼‰
    â†“
ç¡®è®¤æ¥å•
    â†“
ç³»ç»Ÿåˆ›å»ºç§ä¿¡ä¼šè¯
    â†“
åŒæ–¹æ²Ÿé€šä»»åŠ¡ç»†èŠ‚
    â†“
æ¥å•ç”¨æˆ·å¼€å§‹ä»»åŠ¡
    â†“
æ›´æ–°ä»»åŠ¡è¿›åº¦
    â†“
å®Œæˆä»»åŠ¡ï¼Œä¸Šä¼ å®Œæˆå‡­è¯
    â†“
å‘å¸ƒè€…ç¡®è®¤å®Œæˆ
    â†“
ç³»ç»Ÿå¤„ç†æŠ¥é…¬æ”¯ä»˜ï¼ˆæ¨¡æ‹Ÿï¼‰
    â†“
åŒæ–¹è¯„ä»·
```

**æ¥å•å®ç°ï¼š**
```java
@Service
public class TaskService {
    
    /**
     * æ¥å•
     */
    @Transactional
    public void acceptTask(Long taskId, Long userId) {
        // 1. éªŒè¯å®åè®¤è¯
        User user = userMapper.selectById(userId);
        if (user.getIsVerified() != 1) {
            throw new BusinessException("æ¥å•éœ€è¦å®åè®¤è¯ï¼Œè¯·å…ˆå®Œæˆå®åè®¤è¯");
        }
        
        // 2. æŸ¥è¯¢ä»»åŠ¡
        ErrandTask task = taskMapper.selectById(taskId);
        if (task == null) {
            throw new BusinessException("ä»»åŠ¡ä¸å­˜åœ¨");
        }
        
        // 3. éªŒè¯ä»»åŠ¡çŠ¶æ€
        if (!"PENDING_ACCEPT".equals(task.getStatus())) {
            throw new BusinessException("è¯¥ä»»åŠ¡å½“å‰ä¸å¯æ¥å•");
        }
        
        // 4. ä¸èƒ½æ¥è‡ªå·±çš„ä»»åŠ¡
        if (task.getUserId().equals(userId)) {
            throw new BusinessException("ä¸èƒ½æ¥è‡ªå·±å‘å¸ƒçš„ä»»åŠ¡");
        }
        
        // 5. ä½¿ç”¨ä¹è§‚é”æ›´æ–°ä»»åŠ¡çŠ¶æ€
        int rows = taskMapper.updateStatusWithVersion(
            taskId,
            "PENDING_ACCEPT",
            "ACCEPTED",
            task.getVersion()
        );
        
        if (rows == 0) {
            throw new BusinessException("æ¥å•å¤±è´¥ï¼Œä»»åŠ¡å·²è¢«å…¶ä»–äººæ¥å•");
        }
        
        // 6. æ›´æ–°ä»»åŠ¡ä¿¡æ¯
        task.setAccepterId(userId);
        task.setAcceptTime(new Date());
        taskMapper.updateById(task);
        
        // 7. åˆ›å»ºç§ä¿¡ä¼šè¯
        chatSessionService.createSession(userId, task.getUserId(), "TASK", taskId);
        
        // 8. å‘é€é€šçŸ¥ç»™å‘å¸ƒè€…
        notifyUser(task.getUserId(), "ä»»åŠ¡å·²è¢«æ¥å•", 
            "æ‚¨å‘å¸ƒçš„ä»»åŠ¡ã€Š" + task.getTitle() + "ã€‹å·²è¢«æ¥å•ï¼Œè¯·åŠæ—¶è”ç³»æ¥å•ç”¨æˆ·");
    }
}
```

---

### 2.5 æ¶ˆæ¯é€šçŸ¥æ¨¡å—

#### 2.5.1 ç§ä¿¡åŠŸèƒ½ï¼ˆè¯¦ç»†å®ç°ï¼‰

**ç§ä¿¡åˆ—è¡¨é¡µï¼š** `/message/chat`

**é¡µé¢å¸ƒå±€ï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ä¼šè¯åˆ—è¡¨     â”‚  â”‚ èŠå¤©å†…å®¹                    â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ [å¤´åƒ] ç”¨æˆ·A â”‚  â”‚ å¯¹æ–¹: ä½ å¥½                  â”‚ â”‚
â”‚  â”‚    æœ€åæ¶ˆæ¯  â”‚  â”‚ æˆ‘: ä½ å¥½ï¼Œè¯·é—®...          â”‚ â”‚
â”‚  â”‚    æ—¶é—´      â”‚  â”‚ å¯¹æ–¹: [å›¾ç‰‡]                â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚ ...                         â”‚ â”‚
â”‚  â”‚ [å¤´åƒ] ç”¨æˆ·B â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚    æœ€åæ¶ˆæ¯  â”‚  â”‚ [è¾“å…¥æ¡†]                    â”‚ â”‚
â”‚  â”‚    æ—¶é—´      â”‚  â”‚ [å›¾ç‰‡] [å‘é€]               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è‡ªåŠ¨åˆ›å»ºç§ä¿¡ä¼šè¯ï¼š**
```java
@Service
public class ChatSessionService {
    
    /**
     * åˆ›å»ºä¼šè¯ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
     */
    @Transactional
    public Long createSession(Long userId1, Long userId2, String relatedType, Long relatedId) {
        // 1. æŸ¥è¯¢æ˜¯å¦å·²å­˜åœ¨ä¼šè¯
        QueryWrapper<ChatSession> wrapper = new QueryWrapper<>();
        wrapper.and(w -> w.eq("user1_id", userId1).eq("user2_id", userId2)
                       .or()
                       .eq("user1_id", userId2).eq("user2_id", userId1));
        wrapper.eq("related_type", relatedType);
        wrapper.eq("related_id", relatedId);
        
        ChatSession session = sessionMapper.selectOne(wrapper);
        
        if (session != null) {
            return session.getId();
        }
        
        // 2. åˆ›å»ºæ–°ä¼šè¯
        session = new ChatSession();
        session.setUser1Id(userId1);
        session.setUser2Id(userId2);
        session.setRelatedType(relatedType);
        session.setRelatedId(relatedId);
        session.setCreateTime(new Date());
        sessionMapper.insert(session);
        
        return session.getId();
    }
    
    /**
     * å‘é€æ¶ˆæ¯
     */
    @Transactional
    public void sendMessage(SendMessageDTO dto, Long senderId) {
        // 1. éªŒè¯ä¼šè¯æ˜¯å¦å­˜åœ¨
        ChatSession session = sessionMapper.selectById(dto.getSessionId());
        if (session == null) {
            throw new BusinessException("ä¼šè¯ä¸å­˜åœ¨");
        }
        
        // 2. éªŒè¯å‘é€è€…æ˜¯ä¼šè¯å‚ä¸è€…
        if (!session.getUser1Id().equals(senderId) && !session.getUser2Id().equals(senderId)) {
            throw new BusinessException("æ— æƒå‘é€æ¶ˆæ¯");
        }
        
        // 3. ç¡®å®šæ¥æ”¶è€…
        Long receiverId = session.getUser1Id().equals(senderId) ? session.getUser2Id() : session.getUser1Id();
        
        // 4. æ•æ„Ÿè¯æ£€æµ‹ï¼ˆå¦‚æœæ˜¯æ–‡å­—æ¶ˆæ¯ï¼‰
        if ("TEXT".equals(dto.getMessageType())) {
            SensitiveWordCheckResult checkResult = sensitiveWordService.check(dto.getContent());
            if (!checkResult.isPass()) {
                throw new BusinessException("æ¶ˆæ¯åŒ…å«æ•æ„Ÿè¯ï¼Œè¯·ä¿®æ”¹åå‘é€");
            }
        }
        
        // 5. åˆ›å»ºæ¶ˆæ¯
        ChatMessage message = new ChatMessage();
        message.setSessionId(dto.getSessionId());
        message.setSenderId(senderId);
        message.setReceiverId(receiverId);
        message.setMessageType(dto.getMessageType());
        message.setContent(dto.getContent());
        message.setImages(JSON.toJSONString(dto.getImages()));
        message.setIsRead(0);
        message.setCreateTime(new Date());
        messageMapper.insert(message);
        
        // 6. æ›´æ–°ä¼šè¯çš„æœ€åæ¶ˆæ¯æ—¶é—´
        session.setLastMessageTime(new Date());
        session.setLastMessageContent(dto.getContent());
        sessionMapper.updateById(session);
        
        // 7. WebSocket å®æ—¶æ¨é€ç»™æ¥æ”¶è€…
        webSocketService.sendMessageToUser(receiverId, message);
    }
}
```

#### 2.5.2 WebSocket å®æ—¶æ¨é€ï¼ˆè¯¦ç»†å®ç°ï¼‰

**åç«¯ WebSocket é…ç½®ï¼š**
```java
@Configuration
@EnableWebSocket
public class WebSocketConfig implements WebSocketConfigurer {
    
    @Autowired
    private WebSocketHandler webSocketHandler;
    
    @Override
    public void registerWebSocketHandlers(WebSocketHandlerRegistry registry) {
        registry.addHandler(webSocketHandler, "/ws")
                .setAllowedOrigins("*")
                .addInterceptors(new WebSocketInterceptor());
    }
}

@Component
public class WebSocketHandler extends TextWebSocketHandler {
    
    // å­˜å‚¨ç”¨æˆ·IDå’ŒWebSocketä¼šè¯çš„æ˜ å°„
    private static final Map<Long, WebSocketSession> USER_SESSIONS = new ConcurrentHashMap<>();
    
    @Override
    public void afterConnectionEstablished(WebSocketSession session) throws Exception {
        // ä»URLå‚æ•°è·å–token
        String token = getTokenFromSession(session);
        Long userId = jwtUtil.getUserIdFromToken(token);
        
        // ä¿å­˜ä¼šè¯
        USER_SESSIONS.put(userId, session);
        
        System.out.println("ç”¨æˆ· " + userId + " WebSocketè¿æ¥æˆåŠŸ");
    }
    
    @Override
    public void afterConnectionClosed(WebSocketSession session, CloseStatus status) throws Exception {
        // ç§»é™¤ä¼šè¯
        Long userId = getUserIdFromSession(session);
        USER_SESSIONS.remove(userId);
        
        System.out.println("ç”¨æˆ· " + userId + " WebSocketè¿æ¥å…³é—­");
    }
    
    @Override
    protected void handleTextMessage(WebSocketSession session, TextMessage message) throws Exception {
        // å¤„ç†å®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯ï¼ˆå¿ƒè·³ç­‰ï¼‰
        String payload = message.getPayload();
        if ("ping".equals(payload)) {
            session.sendMessage(new TextMessage("pong"));
        }
    }
    
    /**
     * å‘é€æ¶ˆæ¯ç»™æŒ‡å®šç”¨æˆ·
     */
    public void sendMessageToUser(Long userId, Object message) {
        WebSocketSession session = USER_SESSIONS.get(userId);
        if (session != null && session.isOpen()) {
            try {
                String json = JSON.toJSONString(message);
                session.sendMessage(new TextMessage(json));
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }
}
```

**å‰ç«¯ WebSocket è¿æ¥ï¼š**
```javascript
// WebSocket è¿æ¥ç®¡ç†
class WebSocketManager {
  constructor() {
    this.ws = null
    this.reconnectTimer = null
    this.heartbeatTimer = null
    this.messageHandlers = []
  }
  
  // è¿æ¥
  connect(token) {
    const wsUrl = `ws://localhost:8080/ws?token=${token}`
    this.ws = new WebSocket(wsUrl)
    
    this.ws.onopen = () => {
      console.log('WebSocket è¿æ¥æˆåŠŸ')
      this.startHeartbeat()
    }
    
    this.ws.onmessage = (event) => {
      const message = JSON.parse(event.data)
      this.handleMessage(message)
    }
    
    this.ws.onerror = (error) => {
      console.error('WebSocket é”™è¯¯:', error)
    }
    
    this.ws.onclose = () => {
      console.log('WebSocket è¿æ¥å…³é—­')
      this.stopHeartbeat()
      this.reconnect(token)
    }
  }
  
  // æ–­çº¿é‡è¿
  reconnect(token) {
    if (this.reconnectTimer) return
    
    this.reconnectTimer = setTimeout(() => {
      console.log('å°è¯•é‡æ–°è¿æ¥ WebSocket...')
      this.connect(token)
      this.reconnectTimer = null
    }, 3000)
  }
  
  // å¿ƒè·³
  startHeartbeat() {
    this.heartbeatTimer = setInterval(() => {
      if (this.ws && this.ws.readyState === WebSocket.OPEN) {
        this.ws.send('ping')
      }
    }, 30000) // 30ç§’ä¸€æ¬¡å¿ƒè·³
  }
  
  stopHeartbeat() {
    if (this.heartbeatTimer) {
      clearInterval(this.heartbeatTimer)
      this.heartbeatTimer = null
    }
  }
  
  // å¤„ç†æ¶ˆæ¯
  handleMessage(message) {
    this.messageHandlers.forEach(handler => {
      handler(message)
    })
  }
  
  // æ·»åŠ æ¶ˆæ¯å¤„ç†å™¨
  addMessageHandler(handler) {
    this.messageHandlers.push(handler)
  }
  
  // å…³é—­è¿æ¥
  close() {
    this.stopHeartbeat()
    if (this.reconnectTimer) {
      clearTimeout(this.reconnectTimer)
      this.reconnectTimer = null
    }
    if (this.ws) {
      this.ws.close()
      this.ws = null
    }
  }
}

// ä½¿ç”¨
const wsManager = new WebSocketManager()

// ç™»å½•æˆåŠŸåè¿æ¥
wsManager.connect(token)

// æ·»åŠ æ¶ˆæ¯å¤„ç†å™¨
wsManager.addMessageHandler((message) => {
  if (message.type === 'CHAT') {
    // å¤„ç†ç§ä¿¡æ¶ˆæ¯
    handleChatMessage(message)
  } else if (message.type === 'SYSTEM') {
    // å¤„ç†ç³»ç»Ÿæ¶ˆæ¯
    handleSystemMessage(message)
  }
})
```

---

### 2.7 æ™ºèƒ½å®¡æ ¸æœºåˆ¶ï¼ˆè¯¦ç»†å®ç°ï¼‰

#### 2.7.1 æ•æ„Ÿè¯æ£€æµ‹ï¼ˆACè‡ªåŠ¨æœºç®—æ³•ï¼‰

**ACè‡ªåŠ¨æœºå®ç°ï¼š**
```java
/**
 * ACè‡ªåŠ¨æœºèŠ‚ç‚¹
 */
class TrieNode {
    Map<Character, TrieNode> children = new HashMap<>();
    TrieNode fail; // å¤±è´¥æŒ‡é’ˆ
    boolean isEnd; // æ˜¯å¦æ˜¯æ•æ„Ÿè¯ç»“å°¾
    String word; // æ•æ„Ÿè¯
}

/**
 * ACè‡ªåŠ¨æœº
 */
public class AhoCorasick {
    private TrieNode root = new TrieNode();
    
    /**
     * æ„å»ºACè‡ªåŠ¨æœº
     */
    public void build(List<String> words) {
        // 1. æ„å»ºTrieæ ‘
        for (String word : words) {
            TrieNode node = root;
            for (char c : word.toCharArray()) {
                node = node.children.computeIfAbsent(c, k -> new TrieNode());
            }
            node.isEnd = true;
            node.word = word;
        }
        
        // 2. æ„å»ºå¤±è´¥æŒ‡é’ˆï¼ˆBFSï¼‰
        Queue<TrieNode> queue = new LinkedList<>();
        root.fail = root;
        
        for (TrieNode child : root.children.values()) {
            child.fail = root;
            queue.offer(child);
        }
        
        while (!queue.isEmpty()) {
            TrieNode node = queue.poll();
            
            for (Map.Entry<Character, TrieNode> entry : node.children.entrySet()) {
                char c = entry.getKey();
                TrieNode child = entry.getValue();
                queue.offer(child);
                
                TrieNode failNode = node.fail;
                while (failNode != root && !failNode.children.containsKey(c)) {
                    failNode = failNode.fail;
                }
                
                child.fail = failNode.children.getOrDefault(c, root);
            }
        }
    }
    
    /**
     * æ£€æµ‹æ–‡æœ¬ä¸­çš„æ•æ„Ÿè¯
     */
    public List<String> search(String text) {
        List<String> result = new ArrayList<>();
        TrieNode node = root;
        
        for (int i = 0; i < text.length(); i++) {
            char c = text.charAt(i);
            
            // è½¬å°å†™
            c = Character.toLowerCase(c);
            
            // è·³è¿‡ç©ºæ ¼ç­‰ç‰¹æ®Šå­—ç¬¦
            if (!Character.isLetterOrDigit(c) && !isChinese(c)) {
                continue;
            }
            
            while (node != root && !node.children.containsKey(c)) {
                node = node.fail;
            }
            
            node = node.children.getOrDefault(c, root);
            
            // æ£€æŸ¥æ‰€æœ‰åŒ¹é…çš„æ•æ„Ÿè¯
            TrieNode temp = node;
            while (temp != root) {
                if (temp.isEnd) {
                    result.add(temp.word);
                }
                temp = temp.fail;
            }
        }
        
        return result;
    }
    
    private boolean isChinese(char c) {
        return c >= 0x4E00 && c <= 0x9FA5;
    }
}

/**
 * æ•æ„Ÿè¯æœåŠ¡
 */
@Service
public class SensitiveWordService {
    
    private AhoCorasick ahoCorasick = new AhoCorasick();
    
    @Autowired
    private SensitiveWordMapper sensitiveWordMapper;
    
    @PostConstruct
    public void init() {
        // ä»æ•°æ®åº“åŠ è½½æ•æ„Ÿè¯
        List<SensitiveWord> words = sensitiveWordMapper.selectList(null);
        List<String> wordList = words.stream()
            .map(SensitiveWord::getWord)
            .collect(Collectors.toList());
        
        // æ„å»ºACè‡ªåŠ¨æœº
        ahoCorasick.build(wordList);
        
        System.out.println("æ•æ„Ÿè¯åº“åŠ è½½å®Œæˆï¼Œå…± " + words.size() + " ä¸ªæ•æ„Ÿè¯");
    }
    
    /**
     * æ£€æµ‹æ–‡æœ¬
     */
    public SensitiveWordCheckResult check(String text) {
        List<String> foundWords = ahoCorasick.search(text);
        
        if (foundWords.isEmpty()) {
            return SensitiveWordCheckResult.pass();
        }
        
        // æ£€æŸ¥æ•æ„Ÿè¯ä¸¥é‡ç¨‹åº¦
        for (String word : foundWords) {
            SensitiveWord sw = sensitiveWordMapper.selectByWord(word);
            if (sw != null && "SEVERE".equals(sw.getLevel())) {
                return SensitiveWordCheckResult.reject("åŒ…å«ä¸¥é‡æ•æ„Ÿè¯ï¼š" + word);
            }
        }
        
        return SensitiveWordCheckResult.needManualReview("åŒ…å«æ•æ„Ÿè¯ï¼š" + String.join("ã€", foundWords));
    }
}
```

---

### 2.8 ç®¡ç†å‘˜åŠŸèƒ½ï¼ˆè¯¦ç»†å®ç°ï¼‰

#### 2.8.1 å†…å®¹ç®¡ç†

**å†…å®¹åˆ—è¡¨é¡µï¼š** `/admin/content/list`

**åŠŸèƒ½ï¼š**
- æŸ¥çœ‹æ‰€æœ‰å·²å‘å¸ƒçš„å†…å®¹ï¼ˆå¤±ç‰©ã€å•†å“ã€ä»»åŠ¡ï¼‰
- æŒ‰ç±»å‹ç­›é€‰ã€æŒ‰çŠ¶æ€ç­›é€‰ã€æœç´¢
- ä¸‹æ¶è¿è§„å†…å®¹
- åˆ é™¤ä¸å½“å†…å®¹

**ä¸‹æ¶åŠŸèƒ½å®ç°ï¼š**
```java
@Service
public class ContentManageService {
    
    /**
     * ä¸‹æ¶å†…å®¹
     */
    @Transactional
    public void offshelfContent(String contentType, Long contentId, OffshelfDTO dto, Long adminId) {
        if ("LOST_FOUND".equals(contentType)) {
            // ä¸‹æ¶å¤±ç‰©
            LostFound lostFound = lostFoundMapper.selectById(contentId);
            if (lostFound == null) {
                throw new BusinessException("å†…å®¹ä¸å­˜åœ¨");
            }
            
            lostFound.setStatus("ADMIN_OFFSHELF");
            lostFound.setOffshelfType("ADMIN");
            lostFound.setOffshelfReason(dto.getReason());
            lostFound.setOffshelfTime(new Date());
            lostFound.setOffshelfAdminId(adminId);
            lostFoundMapper.updateById(lostFound);
            
            // å‘é€é€šçŸ¥ç»™å‘å¸ƒè€…
            notifyUser(lostFound.getUserId(), "å†…å®¹è¢«ä¸‹æ¶", 
                "æ‚¨å‘å¸ƒçš„å¤±ç‰©ã€Š" + lostFound.getTitle() + "ã€‹å› è¿è§„è¢«ä¸‹æ¶ã€‚åŸå› ï¼š" + dto.getReason() + "ã€‚æ‚¨å¯ä»¥ä¿®æ”¹åé‡æ–°æäº¤ã€‚");
                
        } else if ("GOODS".equals(contentType)) {
            // ä¸‹æ¶å•†å“ï¼ˆç±»ä¼¼ï¼‰
            // ...
        } else if ("TASK".equals(contentType)) {
            // ä¸‹æ¶ä»»åŠ¡ï¼ˆç±»ä¼¼ï¼‰
            // ...
        }
    }
}
```

#### 2.8.2 ç”¨æˆ·ç®¡ç†

**å°ç¦åŠŸèƒ½å®ç°ï¼š**
```java
@Service
public class UserManageService {
    
    /**
     * å°ç¦ç”¨æˆ·
     */
    @Transactional
    public void banUser(Long userId, BanDTO dto, Long adminId) {
        // 1. æŸ¥è¯¢ç”¨æˆ·
        User user = userMapper.selectById(userId);
        if (user == null) {
            throw new BusinessException("ç”¨æˆ·ä¸å­˜åœ¨");
        }
        
        // 2. ä¸èƒ½å°ç¦ç®¡ç†å‘˜
        if ("ADMIN".equals(user.getRole())) {
            throw new BusinessException("ä¸èƒ½å°ç¦ç®¡ç†å‘˜");
        }
        
        // 3. æ›´æ–°ç”¨æˆ·çŠ¶æ€
        user.setStatus(2); // å·²å°ç¦
        user.setBanType(dto.getBanType());
        user.setBanReason(dto.getReason());
        user.setBanTime(new Date());
        user.setBanAdminId(adminId);
        
        if ("TEMPORARY".equals(dto.getBanType())) {
            user.setBanDays(dto.getBanDays());
            // è®¡ç®—è§£å°æ—¶é—´
            Calendar calendar = Calendar.getInstance();
            calendar.add(Calendar.DAY_OF_MONTH, dto.getBanDays());
            user.setUnbanTime(calendar.getTime());
        }
        
        userMapper.updateById(user);
        
        // 4. ä¿å­˜å°ç¦è®°å½•
        UserBanRecord record = new UserBanRecord();
        record.setUserId(userId);
        record.setBanType(dto.getBanType());
        record.setBanReason(dto.getReason());
        record.setBanDays(dto.getBanDays());
        record.setBanTime(new Date());
        record.setUnbanTime(user.getUnbanTime());
        record.setBanAdminId(adminId);
        banRecordMapper.insert(record);
        
        // 5. è¸¢å‡ºå½“å‰ç™»å½•
        String key = "token:" + userId;
        redisTemplate.delete(key);
        
        // 6. å‘é€å°ç¦é€šçŸ¥ï¼ˆé‚®ä»¶ï¼‰
        sendEmailNotification(user.getEmail(), "è´¦å·å°ç¦é€šçŸ¥", 
            "æ‚¨çš„è´¦å·å› è¿è§„è¢«å°ç¦ã€‚\n" +
            "å°ç¦ç±»å‹ï¼š" + (dto.getBanType().equals("PERMANENT") ? "æ°¸ä¹…å°ç¦" : "ä¸´æ—¶å°ç¦" + dto.getBanDays() + "å¤©") + "\n" +
            "å°ç¦åŸå› ï¼š" + dto.getReason() + "\n" +
            "å¦‚æœ‰ç–‘é—®ï¼Œè¯·è”ç³»ç®¡ç†å‘˜ã€‚");
    }
}
```

---

## ä¸‰ã€æ•°æ®åº“è®¾è®¡

### 3.1 æ•°æ®åº“è®¾è®¡è¯´æ˜

**è®¾è®¡åŸåˆ™ï¼š**
1. éµå¾ªç¬¬ä¸‰èŒƒå¼ï¼ˆ3NFï¼‰ï¼Œå‡å°‘æ•°æ®å†—ä½™
2. åˆç†ä½¿ç”¨ç´¢å¼•ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½
3. ä½¿ç”¨ä¹è§‚é”ï¼ˆversionå­—æ®µï¼‰å¤„ç†å¹¶å‘é—®é¢˜
4. æ‰€æœ‰è¡¨ä½¿ç”¨é€»è¾‘åˆ é™¤ï¼ˆdelete_flagå­—æ®µï¼‰
5. ç»Ÿä¸€æ—¶é—´å­—æ®µï¼ˆcreate_timeã€update_timeï¼‰

**å…³é”®å­—æ®µè¯´æ˜ï¼š**
- **view_count**ï¼šæµè§ˆæ¬¡æ•°ï¼Œç”¨äºçƒ­åº¦æ’åºå’Œç»Ÿè®¡
- **version**ï¼šä¹è§‚é”ç‰ˆæœ¬å·ï¼Œç”¨äºå¹¶å‘æ§åˆ¶
- **audit_trigger_reason**ï¼šè§¦å‘äººå·¥å®¡æ ¸çš„åŸå› ï¼Œç”¨äºå®¡æ ¸ä¼˜åŒ–

**æ³¨æ„ï¼š** å¤±ç‰©æ‹›é¢†æ¨¡å—ä¸åŒ…å«æ”¶è—å’Œè¯„è®ºåŠŸèƒ½ï¼Œå› æ­¤ä¸åŒ…å« `favorite_count` å’Œ `comment_count` å­—æ®µã€‚å…¶ä»–æ¨¡å—ï¼ˆé—²ç½®äº¤æ˜“ã€è·‘è…¿æœåŠ¡ï¼‰å¯èƒ½åŒ…å«è¿™äº›å­—æ®µã€‚

### 3.2 ç”¨æˆ·è¡¨ï¼ˆuserï¼‰

```sql
CREATE TABLE `user` (
  `id` BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT 'ç”¨æˆ·ID',
  `email` VARCHAR(100) NOT NULL COMMENT 'é‚®ç®±ï¼ˆç”¨äºç™»å½•ï¼‰',
  `password` VARCHAR(255) NOT NULL COMMENT 'å¯†ç ï¼ˆåŠ å¯†å­˜å‚¨ï¼‰',
  `nickname` VARCHAR(50) NOT NULL COMMENT 'æ˜µç§°',
  `avatar` VARCHAR(255) DEFAULT NULL COMMENT 'å¤´åƒURL',
  `gender` TINYINT(1) DEFAULT NULL COMMENT 'æ€§åˆ«ï¼š0-å¥³ï¼Œ1-ç”·',
  `grade` VARCHAR(20) DEFAULT NULL COMMENT 'å¹´çº§',
  `major` VARCHAR(100) DEFAULT NULL COMMENT 'ä¸“ä¸š',
  `phone` VARCHAR(20) DEFAULT NULL COMMENT 'æ‰‹æœºå·',
  
  -- å®åè®¤è¯å­—æ®µ
  `real_name` VARCHAR(50) DEFAULT NULL COMMENT 'çœŸå®å§“åï¼ˆå®åè®¤è¯ï¼‰',
  `id_card` VARCHAR(18) DEFAULT NULL COMMENT 'èº«ä»½è¯å·ï¼ˆå®åè®¤è¯ï¼‰',
  `student_id` VARCHAR(50) DEFAULT NULL COMMENT 'å­¦å·ï¼ˆå®åè®¤è¯ï¼‰',
  `user_type` VARCHAR(20) DEFAULT 'å­¦ç”Ÿ' COMMENT 'ç”¨æˆ·ç±»å‹ï¼šå­¦ç”Ÿã€æ•™å¸ˆ',
  `is_verified` TINYINT(1) DEFAULT 0 COMMENT 'æ˜¯å¦å®åè®¤è¯ï¼š0-æœªè®¤è¯ï¼Œ1-å·²è®¤è¯',
  `verification_status` VARCHAR(20) DEFAULT 'NOT_VERIFIED' COMMENT 'è®¤è¯çŠ¶æ€ï¼šNOT_VERIFIEDã€PENDINGã€VERIFIEDã€REJECTED',
  `verification_proof` TEXT DEFAULT NULL COMMENT 'è®¤è¯è¯æ˜æ–‡ä»¶ï¼ˆJSONæ•°ç»„ï¼‰',
  `verification_submit_time` DATETIME DEFAULT NULL COMMENT 'è®¤è¯æäº¤æ—¶é—´',
  `verification_audit_time` DATETIME DEFAULT NULL COMMENT 'è®¤è¯å®¡æ ¸æ—¶é—´',
  `verification_audit_reason` VARCHAR(500) DEFAULT NULL COMMENT 'è®¤è¯æ‹’ç»åŸå› ',
  `verification_audit_admin_id` BIGINT(20) DEFAULT NULL COMMENT 'å®¡æ ¸ç®¡ç†å‘˜ID',
  
  -- ç”¨æˆ·è§’è‰²å’ŒçŠ¶æ€
  `role` VARCHAR(20) DEFAULT 'USER' COMMENT 'ç”¨æˆ·è§’è‰²ï¼šUSER-æ™®é€šç”¨æˆ·ï¼ŒADMIN-ç®¡ç†å‘˜',
  `status` TINYINT(1) DEFAULT 1 COMMENT 'è´¦å·çŠ¶æ€ï¼š1-æ­£å¸¸ï¼Œ2-å·²å°ç¦',
  `ban_type` VARCHAR(20) DEFAULT NULL COMMENT 'å°ç¦ç±»å‹ï¼šTEMPORARY-ä¸´æ—¶ï¼ŒPERMANENT-æ°¸ä¹…',
  `ban_reason` VARCHAR(500) DEFAULT NULL COMMENT 'å°ç¦åŸå› ',
  `ban_days` INT(11) DEFAULT NULL COMMENT 'å°ç¦å¤©æ•°',
  `ban_time` DATETIME DEFAULT NULL COMMENT 'å°ç¦æ—¶é—´',
  `unban_time` DATETIME DEFAULT NULL COMMENT 'è§£å°æ—¶é—´',
  `ban_admin_id` BIGINT(20) DEFAULT NULL COMMENT 'å°ç¦æ“ä½œç®¡ç†å‘˜ID',
  
  -- ç³»ç»Ÿå­—æ®µ
  `delete_flag` TINYINT(1) DEFAULT 0 COMMENT 'é€»è¾‘åˆ é™¤ï¼š0-æœªåˆ é™¤ï¼Œ1-å·²åˆ é™¤',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'æ³¨å†Œæ—¶é—´',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_email` (`email`),
  KEY `idx_is_verified` (`is_verified`),
  KEY `idx_role` (`role`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç”¨æˆ·è¡¨';
```

### 3.3 å¤±ç‰©æ‹›é¢†è¡¨ï¼ˆlost_foundï¼‰

```sql
CREATE TABLE `lost_found` (
  `id` BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT 'å¤±ç‰©ID',
  `user_id` BIGINT(20) NOT NULL COMMENT 'å‘å¸ƒè€…ID',
  `title` VARCHAR(200) NOT NULL COMMENT 'ç‰©å“åç§°',
  `category` VARCHAR(50) NOT NULL COMMENT 'ç‰©å“åˆ†ç±»ï¼šè¯ä»¶ç±»ã€ç”µå­äº§å“ã€ç”Ÿæ´»ç”¨å“ã€ä¹¦ç±ã€å…¶ä»–',
  `description` TEXT NOT NULL COMMENT 'ç‰©å“æè¿°',
  `type` VARCHAR(20) NOT NULL COMMENT 'ç±»å‹ï¼šLOST-å¤±ç‰©ï¼ŒFOUND-æ‹›é¢†',
  `lost_time` DATETIME NOT NULL COMMENT 'ä¸¢å¤±/æ‹¾å–æ—¶é—´',
  `lost_location` VARCHAR(200) NOT NULL COMMENT 'ä¸¢å¤±/æ‹¾å–åœ°ç‚¹',
  `contact_info` VARCHAR(200) DEFAULT NULL COMMENT 'è”ç³»æ–¹å¼',
  `images` TEXT DEFAULT NULL COMMENT 'ç‰©å“å›¾ç‰‡ï¼ˆJSONæ•°ç»„ï¼‰',
  `reward` DECIMAL(10, 2) DEFAULT 0.00 COMMENT 'æ‚¬èµé‡‘é¢',
  
  -- çŠ¶æ€å­—æ®µ
  `status` VARCHAR(20) DEFAULT 'PENDING_REVIEW' COMMENT 'çŠ¶æ€ï¼šPENDING_REVIEW-å¾…å®¡æ ¸ï¼ŒPENDING_CLAIM-å¾…è®¤é¢†ï¼ŒCLAIMING-è®¤é¢†ä¸­ï¼ŒCLAIMED-å·²è®¤é¢†ï¼ŒCLOSED-å·²å…³é—­ï¼ŒREJECTED-å·²æ‹’ç»ï¼ŒADMIN_OFFSHELF-å·²ä¸‹æ¶',
  
  -- å®¡æ ¸å­—æ®µ
  `audit_status` VARCHAR(20) DEFAULT 'PENDING' COMMENT 'å®¡æ ¸çŠ¶æ€ï¼šPENDING-å¾…å®¡æ ¸ï¼ŒAPPROVED-å·²é€šè¿‡ï¼ŒREJECTED-å·²æ‹’ç»',
  `audit_reason` VARCHAR(500) DEFAULT NULL COMMENT 'å®¡æ ¸æ‹’ç»åŸå› ',
  `audit_time` DATETIME DEFAULT NULL COMMENT 'å®¡æ ¸æ—¶é—´',
  `audit_admin_id` BIGINT(20) DEFAULT NULL COMMENT 'å®¡æ ¸ç®¡ç†å‘˜ID',
  `audit_trigger_reason` VARCHAR(500) DEFAULT NULL COMMENT 'è§¦å‘äººå·¥å®¡æ ¸åŸå› ï¼ˆæ•æ„Ÿè¯ã€å‘å¸ƒé¢‘ç¹ç­‰ï¼‰',
  
  -- ä¸‹æ¶å­—æ®µ
  `offshelf_type` VARCHAR(20) DEFAULT NULL COMMENT 'ä¸‹æ¶ç±»å‹ï¼šUSER-ç”¨æˆ·è‡ªè¡Œä¸‹æ¶ï¼ŒADMIN-ç®¡ç†å‘˜ä¸‹æ¶',
  `offshelf_reason` VARCHAR(500) DEFAULT NULL COMMENT 'ä¸‹æ¶åŸå› ',
  `offshelf_time` DATETIME DEFAULT NULL COMMENT 'ä¸‹æ¶æ—¶é—´',
  `offshelf_admin_id` BIGINT(20) DEFAULT NULL COMMENT 'ä¸‹æ¶ç®¡ç†å‘˜ID',
  
  -- ç»Ÿè®¡å­—æ®µ
  `view_count` INT(11) DEFAULT 0 COMMENT 'æµè§ˆæ¬¡æ•°',
  
  -- å¹¶å‘æ§åˆ¶
  `version` INT(11) DEFAULT 0 COMMENT 'ä¹è§‚é”ç‰ˆæœ¬å·',
  
  -- ç³»ç»Ÿå­—æ®µ
  `delete_flag` TINYINT(1) DEFAULT 0 COMMENT 'é€»è¾‘åˆ é™¤ï¼š0-æœªåˆ é™¤ï¼Œ1-å·²åˆ é™¤',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'å‘å¸ƒæ—¶é—´',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_category` (`category`),
  KEY `idx_type` (`type`),
  KEY `idx_status` (`status`),
  KEY `idx_audit_status` (`audit_status`),
  KEY `idx_status_type_create_time` (`status`, `type`, `create_time` DESC),
  KEY `idx_create_time` (`create_time`),
  CONSTRAINT `fk_lost_found_user` FOREIGN KEY (`user_id`) REFERENCES `user` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='å¤±ç‰©æ‹›é¢†è¡¨';
```

### 3.4 å•†å“è¡¨ï¼ˆgoodsï¼‰

```sql
CREATE TABLE `goods` (
  `id` BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT 'å•†å“ID',
  `user_id` BIGINT(20) NOT NULL COMMENT 'å–å®¶ID',
  `title` VARCHAR(200) NOT NULL COMMENT 'å•†å“æ ‡é¢˜',
  `category` VARCHAR(50) NOT NULL COMMENT 'å•†å“åˆ†ç±»ï¼šæ•°ç äº§å“ã€å›¾ä¹¦æ•™æã€æœè£…é‹åŒ…ã€ç”Ÿæ´»ç”¨å“ã€è¿åŠ¨å¥èº«ã€ä¹å™¨ã€æ–‡åˆ›ç”¨å“ã€å…¶ä»–',
  `description` TEXT NOT NULL COMMENT 'å•†å“æè¿°',
  `original_price` DECIMAL(10, 2) NOT NULL COMMENT 'åŸä»·',
  `current_price` DECIMAL(10, 2) NOT NULL COMMENT 'ç°ä»·',
  `condition` VARCHAR(50) DEFAULT NULL COMMENT 'å•†å“æˆè‰²ï¼šå…¨æ–°ã€å‡ ä¹å…¨æ–°ã€è½»å¾®ä½¿ç”¨ç—•è¿¹ã€æ˜æ˜¾ä½¿ç”¨ç—•è¿¹',
  `images` TEXT DEFAULT NULL COMMENT 'å•†å“å›¾ç‰‡ï¼ˆJSONæ•°ç»„ï¼Œ1-9å¼ ï¼‰',
  `trade_method` VARCHAR(50) DEFAULT NULL COMMENT 'äº¤æ˜“æ–¹å¼ï¼šFACE_TO_FACE-è‡ªæï¼ŒMAIL-é‚®å¯„',
  `trade_location` VARCHAR(200) DEFAULT NULL COMMENT 'è‡ªæåœ°ç‚¹ï¼ˆè‡ªææ—¶å¿…å¡«ï¼‰',
  `shipping_fee` DECIMAL(10, 2) DEFAULT 0.00 COMMENT 'é‚®å¯„è´¹ç”¨ï¼ˆé‚®å¯„æ—¶å¯é€‰ï¼‰',
  
  -- åº“å­˜å­—æ®µ
  `stock` INT(11) NOT NULL DEFAULT 1 COMMENT 'åº“å­˜æ•°é‡ï¼ˆæœ€å°‘1ä»¶ï¼‰',
  
  -- çŠ¶æ€å­—æ®µ
  `status` VARCHAR(20) DEFAULT 'PENDING_REVIEW' COMMENT 'çŠ¶æ€ï¼šPENDING_REVIEW-å¾…å®¡æ ¸ï¼ŒON_SALE-åœ¨å”®ï¼ŒSOLD_OUT-å·²å”®å®Œï¼ŒCLOSED-å·²å…³é—­ï¼ŒREJECTED-å·²æ‹’ç»ï¼ŒADMIN_OFFSHELF-å·²ä¸‹æ¶',
  
  -- å®¡æ ¸å­—æ®µ
  `audit_status` VARCHAR(20) DEFAULT 'PENDING' COMMENT 'å®¡æ ¸çŠ¶æ€',
  `audit_reason` VARCHAR(500) DEFAULT NULL COMMENT 'å®¡æ ¸æ‹’ç»åŸå› ',
  `audit_time` DATETIME DEFAULT NULL COMMENT 'å®¡æ ¸æ—¶é—´',
  `audit_admin_id` BIGINT(20) DEFAULT NULL COMMENT 'å®¡æ ¸ç®¡ç†å‘˜ID',
  `audit_trigger_reason` VARCHAR(500) DEFAULT NULL COMMENT 'è§¦å‘äººå·¥å®¡æ ¸åŸå› ',
  
  -- ä¸‹æ¶å­—æ®µ
  `offshelf_type` VARCHAR(20) DEFAULT NULL COMMENT 'ä¸‹æ¶ç±»å‹',
  `offshelf_reason` VARCHAR(500) DEFAULT NULL COMMENT 'ä¸‹æ¶åŸå› ',
  `offshelf_time` DATETIME DEFAULT NULL COMMENT 'ä¸‹æ¶æ—¶é—´',
  `offshelf_admin_id` BIGINT(20) DEFAULT NULL COMMENT 'ä¸‹æ¶ç®¡ç†å‘˜ID',
  
  -- ç»Ÿè®¡å­—æ®µ
  `view_count` INT(11) DEFAULT 0 COMMENT 'æµè§ˆæ¬¡æ•°',
  
  -- å¹¶å‘æ§åˆ¶
  `version` INT(11) DEFAULT 0 COMMENT 'ä¹è§‚é”ç‰ˆæœ¬å·ï¼ˆç”¨äºé˜²æ­¢è¶…å–ï¼‰',
  
  -- ç³»ç»Ÿå­—æ®µ
  `delete_flag` TINYINT(1) DEFAULT 0 COMMENT 'é€»è¾‘åˆ é™¤',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'å‘å¸ƒæ—¶é—´',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_category` (`category`),
  KEY `idx_status` (`status`),
  KEY `idx_audit_status` (`audit_status`),
  KEY `idx_current_price` (`current_price`),
  KEY `idx_stock` (`stock`),
  KEY `idx_view_count` (`view_count`),
  KEY `idx_status_create_time` (`status`, `create_time` DESC),
  KEY `idx_status_view_count` (`status`, `view_count` DESC),
  KEY `idx_create_time` (`create_time`),
  CONSTRAINT `fk_goods_user` FOREIGN KEY (`user_id`) REFERENCES `user` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='å•†å“è¡¨';
```

### 3.4 è®¢å•è¡¨ï¼ˆorderï¼‰

```sql
CREATE TABLE `order` (
  `id` BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT 'è®¢å•ID',
  `order_no` VARCHAR(50) NOT NULL UNIQUE COMMENT 'å”¯ä¸€è®¢å•å·ï¼ˆæ ¼å¼ï¼šGO+æ—¶é—´æˆ³13ä½+ç”¨æˆ·IDå2ä½ï¼Œç¤ºä¾‹ï¼šGO170406720000012ï¼‰',
  `goods_id` BIGINT(20) NOT NULL COMMENT 'å•†å“ID',
  `session_id` BIGINT(20) DEFAULT NULL COMMENT 'å…³è”èŠå¤©ä¼šè¯ID',
  `buyer_id` BIGINT(20) NOT NULL COMMENT 'ä¹°å®¶ID',
  `seller_id` BIGINT(20) NOT NULL COMMENT 'å–å®¶ID',
  
  -- è®¢å•å•†å“ä¿¡æ¯
  `quantity` INT(11) NOT NULL DEFAULT 1 COMMENT 'è´­ä¹°æ•°é‡',
  `price` DECIMAL(10, 2) NOT NULL COMMENT 'å•ä»·',
  `total_amount` DECIMAL(10, 2) NOT NULL COMMENT 'è®¢å•æ€»é‡‘é¢ï¼ˆå•ä»·Ã—æ•°é‡ï¼‰',
  `shipping_fee` DECIMAL(10, 2) DEFAULT 0.00 COMMENT 'é‚®å¯„è´¹ç”¨ï¼ˆé‚®å¯„æ—¶ï¼‰',
  
  -- äº¤æ˜“æ–¹å¼
  `trade_method` VARCHAR(50) NOT NULL COMMENT 'äº¤æ˜“æ–¹å¼ï¼šFACE_TO_FACE-è‡ªæï¼ŒMAIL-é‚®å¯„',
  
  -- é‚®å¯„ä¿¡æ¯ï¼ˆé‚®å¯„æ—¶å¿…å¡«ï¼‰
  `receiver_name` VARCHAR(50) DEFAULT NULL COMMENT 'æ”¶è´§äººå§“å',
  `receiver_phone` VARCHAR(20) DEFAULT NULL COMMENT 'æ”¶è´§äººç”µè¯',
  `receiver_address` VARCHAR(500) DEFAULT NULL COMMENT 'æ”¶è´§åœ°å€',
  
  -- è‡ªæä¿¡æ¯ï¼ˆè‡ªææ—¶ï¼‰
  `pickup_location` VARCHAR(200) DEFAULT NULL COMMENT 'è‡ªæåœ°ç‚¹ï¼ˆè‡ªææ–¹å¼æ—¶ä½¿ç”¨ï¼‰',
  
  -- ç‰©æµä¿¡æ¯ï¼ˆé‚®å¯„æ—¶ï¼‰
  `tracking_number` VARCHAR(100) DEFAULT NULL COMMENT 'ç‰©æµå•å·',
  `logistics_company` VARCHAR(100) DEFAULT NULL COMMENT 'ç‰©æµå…¬å¸',
  `ship_time` DATETIME DEFAULT NULL COMMENT 'å‘è´§æ—¶é—´',
  
  -- è®¢å•çŠ¶æ€
  `status` VARCHAR(20) NOT NULL DEFAULT 'PENDING_PAYMENT' COMMENT 'è®¢å•çŠ¶æ€ï¼šPENDING_PAYMENT-å¾…ä»˜æ¬¾ï¼ŒPAID-å·²ä»˜æ¬¾ï¼ˆä»…é‚®å¯„æ–¹å¼ï¼Œç­‰å¾…å‘è´§ï¼‰ï¼ŒSHIPPED-å·²å‘è´§ï¼ˆä»…é‚®å¯„æ–¹å¼ï¼‰ï¼ŒPENDING_PICKUP-å¾…è‡ªæï¼ˆä»…è‡ªææ–¹å¼ï¼Œä»˜æ¬¾åè‡ªåŠ¨è¿›å…¥ï¼Œæ— éœ€å‘è´§ï¼‰ï¼ŒCOMPLETED-å·²å®Œæˆï¼ŒCANCELLED-å·²å–æ¶ˆï¼ŒREFUNDED-å·²é€€æ¬¾',
  
  -- è®¢å•æ—¶é—´
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `pay_time` DATETIME DEFAULT NULL COMMENT 'ä»˜æ¬¾æ—¶é—´',
  `complete_time` DATETIME DEFAULT NULL COMMENT 'å®Œæˆæ—¶é—´',
  `cancel_time` DATETIME DEFAULT NULL COMMENT 'å–æ¶ˆæ—¶é—´',
  `cancel_reason` VARCHAR(500) DEFAULT NULL COMMENT 'å–æ¶ˆåŸå› ',
  
  -- ç³»ç»Ÿå­—æ®µ
  `delete_flag` TINYINT(1) DEFAULT 0 COMMENT 'é€»è¾‘åˆ é™¤',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_order_no` (`order_no`),
  KEY `idx_goods_id` (`goods_id`),
  KEY `idx_session_id` (`session_id`),
  KEY `idx_buyer_id` (`buyer_id`),
  KEY `idx_seller_id` (`seller_id`),
  KEY `idx_status` (`status`),
  KEY `idx_create_time` (`create_time`),
  KEY `idx_buyer_status` (`buyer_id`, `status`),
  KEY `idx_seller_status` (`seller_id`, `status`),
  CONSTRAINT `fk_order_goods` FOREIGN KEY (`goods_id`) REFERENCES `goods` (`id`),
  CONSTRAINT `fk_order_session` FOREIGN KEY (`session_id`) REFERENCES `chat_session` (`id`),
  CONSTRAINT `fk_order_buyer` FOREIGN KEY (`buyer_id`) REFERENCES `user` (`id`),
  CONSTRAINT `fk_order_seller` FOREIGN KEY (`seller_id`) REFERENCES `user` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='è®¢å•è¡¨';
```

### 3.5 æ”¶è´§åœ°å€è¡¨ï¼ˆaddressï¼‰

```sql
CREATE TABLE `address` (
  `id` BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT 'åœ°å€ID',
  `user_id` BIGINT(20) NOT NULL COMMENT 'ç”¨æˆ·ID',
  `receiver_name` VARCHAR(50) NOT NULL COMMENT 'æ”¶è´§äººå§“å',
  `receiver_phone` VARCHAR(20) NOT NULL COMMENT 'æ”¶è´§äººç”µè¯',
  `province` VARCHAR(50) NOT NULL COMMENT 'çœä»½',
  `city` VARCHAR(50) NOT NULL COMMENT 'åŸå¸‚',
  `district` VARCHAR(50) NOT NULL COMMENT 'åŒºå¿',
  `detail_address` VARCHAR(200) NOT NULL COMMENT 'è¯¦ç»†åœ°å€',
  `full_address` VARCHAR(500) NOT NULL COMMENT 'å®Œæ•´åœ°å€ï¼ˆçœ+å¸‚+åŒº+è¯¦ç»†åœ°å€ï¼Œç”¨äºè®¢å•æ˜¾ç¤ºï¼‰',
  `postal_code` VARCHAR(10) DEFAULT NULL COMMENT 'é‚®æ”¿ç¼–ç ',
  `is_default` TINYINT(1) DEFAULT 0 COMMENT 'æ˜¯å¦é»˜è®¤åœ°å€ï¼š0-å¦ï¼Œ1-æ˜¯',
  
  -- ç³»ç»Ÿå­—æ®µ
  `delete_flag` TINYINT(1) DEFAULT 0 COMMENT 'é€»è¾‘åˆ é™¤',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_user_default` (`user_id`, `is_default`),
  CONSTRAINT `fk_address_user` FOREIGN KEY (`user_id`) REFERENCES `user` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æ”¶è´§åœ°å€è¡¨';
```

### 3.5 è·‘è…¿ä»»åŠ¡è¡¨ï¼ˆerrand_taskï¼‰

```sql
CREATE TABLE `errand_task` (
  `id` BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT 'ä»»åŠ¡ID',
  `user_id` BIGINT(20) NOT NULL COMMENT 'å‘å¸ƒè€…ID',
  `title` VARCHAR(200) NOT NULL COMMENT 'ä»»åŠ¡æ ‡é¢˜',
  `type` VARCHAR(50) NOT NULL COMMENT 'ä»»åŠ¡ç±»å‹ï¼šä»£å–å¿«é€’ã€ä»£ä¹°ç‰©å“ã€ä»£é€ç‰©å“ã€ä»£æ’é˜Ÿã€å…¶ä»–',
  `description` TEXT NOT NULL COMMENT 'ä»»åŠ¡æè¿°',
  `start_location` VARCHAR(200) NOT NULL COMMENT 'èµ·å§‹åœ°ç‚¹',
  `end_location` VARCHAR(200) NOT NULL COMMENT 'ç›®çš„åœ°',
  `expected_time` DATETIME DEFAULT NULL COMMENT 'æœŸæœ›å®Œæˆæ—¶é—´',
  `reward` DECIMAL(10, 2) NOT NULL COMMENT 'æŠ¥é…¬',
  `images` TEXT DEFAULT NULL COMMENT 'ä»»åŠ¡å›¾ç‰‡ï¼ˆJSONæ•°ç»„ï¼Œæœ€å¤š3å¼ ï¼‰',
  
  -- çŠ¶æ€å­—æ®µ
  `status` VARCHAR(20) DEFAULT 'PENDING_REVIEW' COMMENT 'çŠ¶æ€ï¼šPENDING_REVIEW-å¾…å®¡æ ¸ï¼ŒPENDING_ACCEPT-å¾…æ¥å•ï¼ŒACCEPTED-å·²æ¥å•ï¼ŒIN_PROGRESS-è¿›è¡Œä¸­ï¼ŒPENDING_CONFIRM-å¾…ç¡®è®¤ï¼ŒCOMPLETED-å·²å®Œæˆï¼ŒCANCELLED-å·²å–æ¶ˆï¼ŒREJECTED-å·²æ‹’ç»ï¼ŒADMIN_OFFSHELF-å·²ä¸‹æ¶',
  
  -- å®¡æ ¸å­—æ®µ
  `audit_status` VARCHAR(20) DEFAULT 'PENDING' COMMENT 'å®¡æ ¸çŠ¶æ€',
  `audit_reason` VARCHAR(500) DEFAULT NULL COMMENT 'å®¡æ ¸æ‹’ç»åŸå› ',
  `audit_time` DATETIME DEFAULT NULL COMMENT 'å®¡æ ¸æ—¶é—´',
  `audit_admin_id` BIGINT(20) DEFAULT NULL COMMENT 'å®¡æ ¸ç®¡ç†å‘˜ID',
  `audit_trigger_reason` VARCHAR(500) DEFAULT NULL COMMENT 'è§¦å‘äººå·¥å®¡æ ¸åŸå› ',
  
  -- ä¸‹æ¶å­—æ®µ
  `offshelf_type` VARCHAR(20) DEFAULT NULL COMMENT 'ä¸‹æ¶ç±»å‹',
  `offshelf_reason` VARCHAR(500) DEFAULT NULL COMMENT 'ä¸‹æ¶åŸå› ',
  `offshelf_time` DATETIME DEFAULT NULL COMMENT 'ä¸‹æ¶æ—¶é—´',
  `offshelf_admin_id` BIGINT(20) DEFAULT NULL COMMENT 'ä¸‹æ¶ç®¡ç†å‘˜ID',
  
  -- æ¥å•ä¿¡æ¯
  `accepter_id` BIGINT(20) DEFAULT NULL COMMENT 'æ¥å•ç”¨æˆ·ID',
  `accept_time` DATETIME DEFAULT NULL COMMENT 'æ¥å•æ—¶é—´',
  `complete_time` DATETIME DEFAULT NULL COMMENT 'å®Œæˆæ—¶é—´',
  `completion_proof` TEXT DEFAULT NULL COMMENT 'å®Œæˆå‡­è¯ï¼ˆå›¾ç‰‡JSONæ•°ç»„ï¼‰',
  
  -- ç»Ÿè®¡å­—æ®µ
  `view_count` INT(11) DEFAULT 0 COMMENT 'æµè§ˆæ¬¡æ•°',
  `favorite_count` INT(11) DEFAULT 0 COMMENT 'æ”¶è—æ¬¡æ•°',
  `comment_count` INT(11) DEFAULT 0 COMMENT 'è¯„è®ºæ¬¡æ•°',
  
  -- å¹¶å‘æ§åˆ¶
  `version` INT(11) DEFAULT 0 COMMENT 'ä¹è§‚é”ç‰ˆæœ¬å·',
  
  -- ç³»ç»Ÿå­—æ®µ
  `delete_flag` TINYINT(1) DEFAULT 0 COMMENT 'é€»è¾‘åˆ é™¤',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'å‘å¸ƒæ—¶é—´',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_type` (`type`),
  KEY `idx_status` (`status`),
  KEY `idx_audit_status` (`audit_status`),
  KEY `idx_accepter_id` (`accepter_id`),
  KEY `idx_reward` (`reward`),
  KEY `idx_view_count` (`view_count`),
  KEY `idx_status_reward` (`status`, `reward` DESC),
  KEY `idx_status_create_time` (`status`, `create_time` DESC),
  KEY `idx_create_time` (`create_time`),
  CONSTRAINT `fk_errand_task_user` FOREIGN KEY (`user_id`) REFERENCES `user` (`id`),
  CONSTRAINT `fk_errand_task_accepter` FOREIGN KEY (`accepter_id`) REFERENCES `user` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='è·‘è…¿ä»»åŠ¡è¡¨';
```

### 3.6 å…¶ä»–æ ¸å¿ƒè¡¨

**ï¼ˆå®Œæ•´çš„æ•°æ®åº“è®¾è®¡åŒ…å«ä»¥ä¸‹è¡¨ï¼Œå…·ä½“SQLè§æ•°æ®åº“æ“ä½œæ–‡æ¡£ï¼‰**

- **è®¢å•è¡¨ï¼ˆorderï¼‰**ï¼šç®¡ç†é—²ç½®äº¤æ˜“è®¢å•ï¼ˆè¯¦è§3.4èŠ‚ï¼‰
- **è®¤é¢†è®°å½•è¡¨ï¼ˆclaim_recordï¼‰**ï¼šç®¡ç†å¤±ç‰©è®¤é¢†ç”³è¯·
- **ç§ä¿¡ä¼šè¯è¡¨ï¼ˆchat_sessionï¼‰**ï¼šç§ä¿¡ä¼šè¯ç®¡ç†ï¼ˆéœ€å¢åŠ  `related_id` å­—æ®µå…³è”å•†å“/ä»»åŠ¡IDï¼‰
- **ç§ä¿¡æ¶ˆæ¯è¡¨ï¼ˆchat_messageï¼‰**ï¼šç§ä¿¡æ¶ˆæ¯è®°å½•
- **ç³»ç»Ÿæ¶ˆæ¯è¡¨ï¼ˆsystem_messageï¼‰**ï¼šç³»ç»Ÿé€šçŸ¥
- **æ•æ„Ÿè¯è¡¨ï¼ˆsensitive_wordï¼‰**ï¼šæ•æ„Ÿè¯åº“
- **æœç´¢å†å²è¡¨ï¼ˆsearch_historyï¼‰**ï¼šæœç´¢å†å²è®°å½•

### 3.7 æ•°æ®åº“è®¾è®¡äº®ç‚¹

1. **ç»Ÿè®¡å­—æ®µ**ï¼šview_countæ”¯æŒæ•°æ®å±•ç¤ºå’Œæ’åºï¼ˆå¤±ç‰©æ‹›é¢†æ¨¡å—ä¸åŒ…å«æ”¶è—å’Œè¯„è®ºç»Ÿè®¡ï¼‰
2. **å®Œå–„çš„å®¡æ ¸æœºåˆ¶**ï¼šaudit_statusã€audit_trigger_reasonæ”¯æŒæ™ºèƒ½å®¡æ ¸
3. **çµæ´»çš„ä¸‹æ¶ç®¡ç†**ï¼šoffshelf_typeåŒºåˆ†ç”¨æˆ·è‡ªè¡Œä¸‹æ¶å’Œç®¡ç†å‘˜ä¸‹æ¶
4. **å¹¶å‘æ§åˆ¶**ï¼šversionå­—æ®µæ”¯æŒä¹è§‚é”ï¼Œé¿å…å¹¶å‘é—®é¢˜
5. **æ€§èƒ½ä¼˜åŒ–**ï¼šåˆç†çš„ç´¢å¼•è®¾è®¡ï¼Œæ”¯æŒå¤šç»´åº¦æŸ¥è¯¢

### 3.8 MainLayout.vue æ•°æ®æ”¯æŒåˆ†æ

**æ•°æ®å®Œæ•´æ€§æ£€æŸ¥ï¼š**

| æ¨¡å— | æ‰€éœ€å­—æ®µ | æ•°æ®åº“æ”¯æŒ | çŠ¶æ€ |
|------|---------|-----------|------|
| **å¤±ç‰©æ‹›é¢†** | id, title, description, image, type, location, time, userAvatar, userName | âœ… å…¨éƒ¨æ”¯æŒ | âœ… |
| **é—²ç½®äº¤æ˜“** | id, title, price, views, image, userAvatar, userName, time, badge | âœ… å…¨éƒ¨æ”¯æŒï¼ˆviews=view_countï¼‰ | âœ… |
| **è·‘è…¿æœåŠ¡** | id, title, description, route, deadline, reward, userAvatar, userName | âœ… å…¨éƒ¨æ”¯æŒ | âœ… |
| **æ•°æ®ç»Ÿè®¡** | æ€»æ•°ã€æ´»è·ƒç”¨æˆ·ã€è¶‹åŠ¿å›¾ | âœ… å¯å®æ—¶æŸ¥è¯¢ | âœ… |

**ç»“è®ºï¼š** âœ… æ•°æ®åº“è®¾è®¡å®Œå…¨æ”¯æŒ MainLayout.vue çš„æ‰€æœ‰æ•°æ®å±•ç¤ºéœ€æ±‚ï¼

---

## å››ã€å¼€å‘è®¡åˆ’

**ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€æ¡†æ¶æ­å»ºï¼ˆ1å‘¨ï¼‰**
- åç«¯ï¼šSpring Boot é¡¹ç›®åˆå§‹åŒ–ï¼Œé…ç½® MyBatis-Plusã€Redisã€MySQL
- å‰ç«¯ï¼šVue é¡¹ç›®åˆå§‹åŒ–ï¼Œé…ç½® Element Plusã€Piniaã€Vue Router
- æ•°æ®åº“è®¾è®¡å’Œåˆ›å»º

**ç¬¬äºŒé˜¶æ®µï¼šç”¨æˆ·ç®¡ç†æ¨¡å—ï¼ˆ1å‘¨ï¼‰**
- ç”¨æˆ·æ³¨å†Œç™»å½•ï¼ˆé‚®ç®±éªŒè¯ç ï¼‰
- ç”¨æˆ·ä¿¡æ¯ç®¡ç†
- å®åè®¤è¯åŠŸèƒ½ï¼ˆè¡¨å•ã€å®¡æ ¸ï¼‰
- æƒé™éªŒè¯

**ç¬¬ä¸‰é˜¶æ®µï¼šå¤±ç‰©æ‹›é¢†æ¨¡å—ï¼ˆ1å‘¨ï¼‰**
- å¤±ç‰©å‘å¸ƒï¼ˆæ™ºèƒ½å®¡æ ¸ï¼‰
- å¤±ç‰©æµè§ˆæœç´¢
- è®¤é¢†åŠŸèƒ½ï¼ˆç§ä¿¡æ²Ÿé€šï¼‰

**ç¬¬å››é˜¶æ®µï¼šé—²ç½®äº¤æ˜“æ¨¡å—ï¼ˆ1.5å‘¨ï¼‰**
- å•†å“å‘å¸ƒï¼ˆéœ€å®åè®¤è¯ï¼Œæ”¯æŒåº“å­˜ã€å‘è´§æ–¹å¼é€‰æ‹©ï¼‰
- å•†å“æµè§ˆæœç´¢ï¼ˆå…³é”®è¯æœç´¢ã€æœç´¢å†å²ï¼‰
- è®¢å•ç®¡ç†ï¼ˆé˜²æ­¢è¶…å–ã€è®¢å•çŠ¶æ€æµè½¬ã€å–å®¶æ”¹ä»·ã€ä¹°å®¶ä»˜æ¬¾ã€å‘è´§ã€ç¡®è®¤æ”¶è´§ï¼‰
- äº¤æ˜“æµç¨‹ï¼ˆé‚®å¯„/è‡ªæï¼‰
- èŠå¤©é¡µé¢é›†æˆè®¢å•åŠŸèƒ½ï¼ˆè®¢å•å¡ç‰‡ã€è®¢å•æ“ä½œï¼‰

**ç¬¬äº”é˜¶æ®µï¼šè·‘è…¿æœåŠ¡æ¨¡å—ï¼ˆ1.5å‘¨ï¼‰**
- ä»»åŠ¡å‘å¸ƒï¼ˆéœ€å®åè®¤è¯ï¼‰
- ä»»åŠ¡æµè§ˆæœç´¢
- æ¥å•åŠŸèƒ½ï¼ˆæƒé™éªŒè¯ï¼‰
- ä»»åŠ¡ç®¡ç†

**ç¬¬å…­é˜¶æ®µï¼šæ¶ˆæ¯é€šçŸ¥æ¨¡å—ï¼ˆ1å‘¨ï¼‰**
- ç§ä¿¡åŠŸèƒ½ï¼ˆè‡ªåŠ¨åˆ›å»ºä¼šè¯ï¼‰
- ç³»ç»Ÿæ¶ˆæ¯
- WebSocket å®æ—¶æ¨é€

**ç¬¬ä¸ƒé˜¶æ®µï¼šå®¡æ ¸å’Œç®¡ç†æ¨¡å—ï¼ˆ1å‘¨ï¼‰**
- æ™ºèƒ½å®¡æ ¸æœºåˆ¶ï¼ˆACè‡ªåŠ¨æœºï¼‰
- ç®¡ç†å‘˜åå°
- å†…å®¹ç®¡ç†ï¼ˆä¸‹æ¶åŠŸèƒ½ï¼‰
- ç”¨æˆ·ç®¡ç†ï¼ˆå°ç¦åŠŸèƒ½ï¼‰

**ç¬¬å…«é˜¶æ®µï¼šæœç´¢åŠŸèƒ½ä¼˜åŒ–ï¼ˆ0.5å‘¨ï¼‰**
- å…³é”®è¯æœç´¢åŠŸèƒ½
- æœç´¢å†å²åŠŸèƒ½

**ç¬¬ä¹é˜¶æ®µï¼šæ•°æ®ç»Ÿè®¡ï¼ˆ0.5å‘¨ï¼‰**
- æ•°æ®ç»Ÿè®¡é¡µé¢
- ECharts å›¾è¡¨

**ç¬¬åé˜¶æ®µï¼šæµ‹è¯•å’Œä¼˜åŒ–ï¼ˆ1å‘¨ï¼‰**
- åŠŸèƒ½æµ‹è¯•
- æ€§èƒ½ä¼˜åŒ–
- Bug ä¿®å¤

**æ€»è®¡ï¼šçº¦10å‘¨**

---

## äº”ã€æ€»ç»“

æœ¬æ–‡æ¡£å®šä¹‰äº†æ ¡å›­äº’åŠ©ç³»ç»Ÿçš„æ ¸å¿ƒåŠŸèƒ½å’Œè¯¦ç»†å®ç°æ–¹æ¡ˆï¼š

**æ ¸å¿ƒç‰¹ç‚¹ï¼š**
1. **åŠŸèƒ½èšç„¦**ï¼šå¤±ç‰©æ‹›é¢†ã€é—²ç½®äº¤æ˜“ã€è·‘è…¿æœåŠ¡ä¸‰å¤§æ ¸å¿ƒåŠŸèƒ½
2. **æƒé™æ¸…æ™°**ï¼š
   - å¤±ç‰©æ‹›é¢†ï¼šæ‰€æœ‰ç”¨æˆ·å¯ç”¨
   - é—²ç½®äº¤æ˜“å’Œè·‘è…¿ï¼šéœ€è¦å®åè®¤è¯
3. **æ™ºèƒ½å®¡æ ¸**ï¼šè‡ªåŠ¨å®¡æ ¸ + äººå·¥å®¡æ ¸ï¼Œå‡è½»ç®¡ç†è´Ÿæ‹…
4. **ç®€æ´æ˜“ç”¨**ï¼šç•Œé¢ç®€æ´ï¼Œæ“ä½œä¾¿æ·
5. **æŠ€æœ¯æˆç†Ÿ**ï¼šSpring Boot + Vue + MySQLï¼Œå¼€å‘éš¾åº¦å¯æ§

**å®åè®¤è¯æƒé™æ§åˆ¶ï¼š**
- âš ï¸ æœªè®¤è¯ç”¨æˆ·ï¼šåªèƒ½ä½¿ç”¨å¤±ç‰©æ‹›é¢†
- âœ… å·²è®¤è¯ç”¨æˆ·ï¼šå¯ä½¿ç”¨æ‰€æœ‰åŠŸèƒ½ï¼ˆé—²ç½®äº¤æ˜“ã€è·‘è…¿æœåŠ¡ï¼‰

**ä¸‹ä¸€æ­¥å·¥ä½œï¼š**
1. åˆ›å»ºæ•°æ®åº“å’Œè¡¨
2. æ­å»ºåç«¯é¡¹ç›®
3. æ­å»ºå‰ç«¯é¡¹ç›®
4. æŒ‰é˜¶æ®µé€æ­¥å¼€å‘

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v2.1  
**åˆ›å»ºæ—¥æœŸï¼š** 2024-01-01  
**æœ€è¿‘æ›´æ–°ï¼š** 2024-01-02  
**æ–‡æ¡£ç»´æŠ¤ï¼š** å¼€å‘å›¢é˜Ÿ