# 校园帮系统数据库说明文档

## 数据库信息

- **数据库名称**: `campus_help`
- **字符集**: `utf8mb4`
- **排序规则**: `utf8mb4_general_ci`
- **存储引擎**: `InnoDB`

## 数据表列表

系统共包含 **7** 张核心数据表：

1. `user` - 用户表
2. `lost_found` - 失物招领表
3. `chat_session` - 聊天会话表
4. `chat_message` - 聊天消息表
5. `system_message` - 系统消息表
6. `claim_record` - 认领记录表
7. `sensitive_word` - 敏感词表

## 数据表详细说明

### 1. user（用户表）

**表说明**: 存储用户基本信息、认证信息、权限信息等

**字段列表**:

| 字段名 | 类型 | 说明 | 备注 |
|--------|------|------|------|
| id | bigint | 用户ID（主键） | 自增 |
| password | varchar(255) | 密码（BCrypt加密） | 非空 |
| nickname | varchar(50) | 昵称 | 可空 |
| avatar | varchar(255) | 头像URL | 可空 |
| email | varchar(100) | 邮箱（唯一） | 非空，唯一索引 |
| phone | varchar(20) | 手机号 | 可空 |
| gender | tinyint(1) | 性别：0-未知，1-男，2-女 | 默认0 |
| grade | varchar(20) | 年级 | 可空 |
| major | varchar(100) | 专业 | 可空 |
| real_name | varchar(50) | 真实姓名 | 可空 |
| id_card | varchar(18) | 身份证号 | 可空 |
| student_id | varchar(50) | 学号 | 可空 |
| user_type | varchar(20) | 用户类型：学生、教师 | 默认"学生" |
| is_verified | tinyint(1) | 是否实名认证：0-未认证，1-已认证 | 默认0，索引 |
| verification_status | varchar(20) | 认证状态：NOT_VERIFIED、PENDING、VERIFIED、REJECTED | 默认NOT_VERIFIED |
| verification_proof | text | 认证证明文件（JSON数组） | 可空 |
| verification_submit_time | datetime | 认证提交时间 | 可空 |
| verification_audit_time | datetime | 认证审核时间 | 可空 |
| verification_audit_reason | varchar(500) | 认证拒绝原因 | 可空 |
| verification_audit_admin_id | bigint | 审核管理员ID | 可空 |
| can_accept_task | tinyint(1) | 是否可以接单跑腿：0-不可接单，1-可接单 | 默认0 |
| role | varchar(20) | 角色：USER-普通用户，ADMIN-管理员 | 默认USER，索引 |
| status | tinyint(1) | 账户状态：1-正常，2-已封禁 | 默认1，索引 |
| ban_type | varchar(20) | 封禁类型：TEMPORARY-临时，PERMANENT-永久 | 可空 |
| ban_reason | varchar(500) | 封禁原因 | 可空 |
| ban_days | int | 封禁天数 | 可空 |
| ban_time | datetime | 封禁时间 | 可空 |
| unban_time | datetime | 解封时间 | 可空 |
| ban_admin_id | bigint | 封禁管理员ID | 可空 |
| last_login_time | datetime | 最后登录时间 | 可空 |
| create_time | datetime | 创建时间 | 非空，默认当前时间，索引 |
| update_time | datetime | 更新时间 | 非空，自动更新 |
| delete_flag | tinyint(1) | 逻辑删除标志：0-未删除，1-已删除 | 默认0 |

**索引**:
- PRIMARY KEY (`id`)
- UNIQUE KEY `uk_email` (`email`)
- KEY `idx_is_verified` (`is_verified`)
- KEY `idx_role` (`role`)
- KEY `idx_status` (`status`)
- KEY `idx_create_time` (`create_time`)

---

### 2. lost_found（失物招领表）

**表说明**: 存储失物招领信息，包括失物信息、发布者信息、审核状态等

**字段列表**:

| 字段名 | 类型 | 说明 | 备注 |
|--------|------|------|------|
| id | bigint | 失物ID（主键） | 自增 |
| user_id | bigint | 发布者ID（外键） | 非空，索引 |
| title | varchar(200) | 标题 | 非空 |
| category | varchar(50) | 分类 | 非空，索引 |
| description | text | 描述 | 非空 |
| type | varchar(20) | 类型：LOST-失物，FOUND-招领 | 非空，索引 |
| lost_time | datetime | 丢失/拾获时间 | 非空 |
| lost_location | varchar(200) | 丢失/拾获地点 | 非空 |
| contact_info | varchar(200) | 联系方式 | 可空 |
| images | text | 图片URL列表（JSON格式） | 可空 |
| reward | decimal(10,2) | 悬赏金额 | 默认0.00 |
| status | varchar(20) | 状态：PENDING_REVIEW、APPROVED、REJECTED、CLOSED | 默认PENDING_REVIEW，索引 |
| audit_status | varchar(20) | 审核状态：PENDING、APPROVED、REJECTED | 默认PENDING，索引 |
| audit_reason | varchar(500) | 审核原因 | 可空 |
| audit_time | datetime | 审核时间 | 可空 |
| audit_admin_id | bigint | 审核管理员ID | 可空 |
| audit_trigger_reason | varchar(500) | 触发人工审核原因 | 可空 |
| offshelf_type | varchar(20) | 下架类型 | 可空 |
| offshelf_reason | varchar(500) | 下架原因 | 可空 |
| offshelf_time | datetime | 下架时间 | 可空 |
| offshelf_admin_id | bigint | 下架管理员ID | 可空 |
| view_count | int | 浏览次数 | 默认0 |
| favorite_count | int | 收藏次数 | 默认0 |
| comment_count | int | 评论次数 | 默认0 |
| version | int | 版本号（乐观锁） | 默认0 |
| delete_flag | tinyint(1) | 逻辑删除标志 | 默认0 |
| create_time | datetime | 创建时间 | 非空，默认当前时间，索引 |
| update_time | datetime | 更新时间 | 非空，自动更新 |

**索引**:
- PRIMARY KEY (`id`)
- KEY `idx_user_id` (`user_id`)
- KEY `idx_category` (`category`)
- KEY `idx_type` (`type`)
- KEY `idx_status` (`status`)
- KEY `idx_audit_status` (`audit_status`)
- KEY `idx_create_time` (`create_time`)

---

### 3. chat_session（聊天会话表）

**表说明**: 存储用户之间的聊天会话信息

**字段列表**:

| 字段名 | 类型 | 说明 | 备注 |
|--------|------|------|------|
| id | bigint | 会话ID（主键） | 自增 |
| user1_id | bigint | 用户1 ID（外键） | 非空，索引 |
| user2_id | bigint | 用户2 ID（外键） | 非空，索引 |
| related_type | varchar(50) | 关联类型：LOST_FOUND、GOODS、TASK | 可空，索引 |
| related_id | bigint | 关联ID（失物ID、商品ID、任务ID等） | 可空 |
| last_message_time | datetime | 最后消息时间 | 可空，索引 |
| last_message_content | varchar(500) | 最后消息内容 | 可空 |
| delete_flag | tinyint(1) | 逻辑删除标志 | 默认0 |
| create_time | datetime | 创建时间 | 非空，默认当前时间 |
| update_time | datetime | 更新时间 | 非空，自动更新 |

**索引**:
- PRIMARY KEY (`id`)
- KEY `idx_user1_id` (`user1_id`)
- KEY `idx_user2_id` (`user2_id`)
- KEY `idx_related_type` (`related_type`)
- KEY `idx_last_message_time` (`last_message_time`)

---

### 4. chat_message（聊天消息表）

**表说明**: 存储聊天消息内容，包括文字消息和图片消息

**字段列表**:

| 字段名 | 类型 | 说明 | 备注 |
|--------|------|------|------|
| id | bigint | 消息ID（主键） | 自增 |
| session_id | bigint | 会话ID（外键） | 非空，索引 |
| sender_id | bigint | 发送者ID（外键） | 非空，索引 |
| receiver_id | bigint | 接收者ID（外键） | 非空，索引 |
| message_type | varchar(20) | 消息类型：TEXT-文字，IMAGE-图片 | 非空 |
| content | text | 消息内容（文字消息的内容） | 可空 |
| images | text | 图片URL列表（JSON格式，存储多张图片） | 可空 |
| is_read | tinyint(1) | 是否已读：0-未读，1-已读 | 默认0，索引 |
| delete_flag | tinyint(1) | 逻辑删除标志 | 默认0 |
| create_time | datetime | 创建时间（消息发送时间） | 非空，默认当前时间，索引 |
| update_time | datetime | 更新时间 | 非空，自动更新 |

**索引**:
- PRIMARY KEY (`id`)
- KEY `idx_session_id` (`session_id`)
- KEY `idx_sender_id` (`sender_id`)
- KEY `idx_receiver_id` (`receiver_id`)
- KEY `idx_is_read` (`is_read`)
- KEY `idx_create_time` (`create_time`)

**注意**: 此表已清空所有聊天记录（2025-12-04）

---

### 5. system_message（系统消息表）

**表说明**: 存储系统发送给用户的通知消息

**字段列表**:

| 字段名 | 类型 | 说明 | 备注 |
|--------|------|------|------|
| id | bigint | 消息ID（主键） | 自增 |
| user_id | bigint | 用户ID（外键） | 非空，索引 |
| type | varchar(50) | 消息类型：VERIFICATION_APPROVED、VERIFICATION_REJECTED、ORDER_STATUS、TASK_STATUS、ANNOUNCEMENT | 非空，索引 |
| title | varchar(200) | 消息标题 | 非空 |
| content | text | 消息内容 | 非空 |
| is_read | tinyint(1) | 是否已读：0-未读，1-已读 | 默认0，索引 |
| related_type | varchar(50) | 关联类型：CHAT、LOST_FOUND等 | 可空 |
| related_id | bigint | 关联ID（会话ID、失物ID等） | 可空 |
| delete_flag | tinyint(1) | 逻辑删除标志 | 默认0 |
| create_time | datetime | 创建时间 | 非空，默认当前时间，索引 |
| update_time | datetime | 更新时间 | 非空，自动更新 |

**索引**:
- PRIMARY KEY (`id`)
- KEY `idx_user_id` (`user_id`)
- KEY `idx_type` (`type`)
- KEY `idx_is_read` (`is_read`)
- KEY `idx_create_time` (`create_time`)

---

### 6. claim_record（认领记录表）

**表说明**: 存储失物认领申请记录

**字段列表**:

| 字段名 | 类型 | 说明 | 备注 |
|--------|------|------|------|
| id | bigint | 认领记录ID（主键） | 自增 |
| lost_found_id | bigint | 失物ID（外键） | 非空，索引 |
| claimer_id | bigint | 认领者ID（外键） | 非空，索引 |
| description | text | 认领描述 | 可空 |
| lost_time | datetime | 丢失时间（认领者提供） | 可空 |
| other_info | varchar(500) | 其他信息 | 可空 |
| proof_images | text | 证明图片URL列表（JSON格式） | 可空 |
| status | varchar(20) | 状态：PENDING-待处理，CONFIRMED-已确认，REJECTED-已拒绝 | 默认PENDING，索引 |
| confirm_time | datetime | 确认时间 | 可空 |
| reject_reason | varchar(500) | 拒绝原因 | 可空 |
| reject_time | datetime | 拒绝时间 | 可空 |
| delete_flag | tinyint(1) | 逻辑删除标志 | 默认0 |
| create_time | datetime | 创建时间 | 非空，默认当前时间，索引 |
| update_time | datetime | 更新时间 | 非空，自动更新 |

**索引**:
- PRIMARY KEY (`id`)
- KEY `idx_lost_found_id` (`lost_found_id`)
- KEY `idx_claimer_id` (`claimer_id`)
- KEY `idx_status` (`status`)
- KEY `idx_create_time` (`create_time`)

---

### 7. sensitive_word（敏感词表）

**表说明**: 存储敏感词库，用于内容审核

**字段列表**:

| 字段名 | 类型 | 说明 | 备注 |
|--------|------|------|------|
| id | bigint | 敏感词ID（主键） | 自增 |
| word | varchar(100) | 敏感词 | 非空，唯一索引 |
| level | varchar(20) | 敏感级别：NORMAL-普通，HIGH-高级 | 默认NORMAL，索引 |
| create_time | datetime | 创建时间 | 非空，默认当前时间，索引 |
| update_time | datetime | 更新时间 | 非空，自动更新 |
| delete_flag | tinyint(1) | 逻辑删除标志 | 默认0 |

**索引**:
- PRIMARY KEY (`id`)
- UNIQUE KEY `uk_word` (`word`)
- KEY `idx_level` (`level`)
- KEY `idx_create_time` (`create_time`)

---

## 表关系说明

### 用户相关关系
- `user` 表是核心用户表，其他表通过 `user_id`、`sender_id`、`receiver_id`、`claimer_id` 等字段关联

### 失物招领相关关系
- `lost_found.user_id` → `user.id` (发布者)
- `claim_record.lost_found_id` → `lost_found.id` (认领的失物)
- `claim_record.claimer_id` → `user.id` (认领者)

### 聊天相关关系
- `chat_session.user1_id` → `user.id` (会话用户1)
- `chat_session.user2_id` → `user.id` (会话用户2)
- `chat_message.session_id` → `chat_session.id` (所属会话)
- `chat_message.sender_id` → `user.id` (发送者)
- `chat_message.receiver_id` → `user.id` (接收者)

### 系统消息关系
- `system_message.user_id` → `user.id` (接收消息的用户)

---

## 数据字典

### 用户状态 (user.status)
- `1` - 正常
- `2` - 已封禁

### 用户角色 (user.role)
- `USER` - 普通用户
- `ADMIN` - 管理员

### 认证状态 (user.verification_status)
- `NOT_VERIFIED` - 未认证
- `PENDING` - 待审核
- `VERIFIED` - 已认证
- `REJECTED` - 已拒绝

### 失物类型 (lost_found.type)
- `LOST` - 失物
- `FOUND` - 招领

### 失物状态 (lost_found.status)
- `PENDING_REVIEW` - 待审核
- `APPROVED` - 已通过
- `REJECTED` - 已拒绝
- `CLOSED` - 已关闭

### 审核状态 (lost_found.audit_status)
- `PENDING` - 待审核
- `APPROVED` - 已通过
- `REJECTED` - 已拒绝

### 认领状态 (claim_record.status)
- `PENDING` - 待处理
- `CONFIRMED` - 已确认
- `REJECTED` - 已拒绝

### 消息类型 (chat_message.message_type)
- `TEXT` - 文字消息
- `IMAGE` - 图片消息

### 系统消息类型 (system_message.type)
- `VERIFICATION_APPROVED` - 实名认证通过
- `VERIFICATION_REJECTED` - 实名认证拒绝
- `ORDER_STATUS` - 订单状态
- `TASK_STATUS` - 任务状态
- `ANNOUNCEMENT` - 系统公告

### 关联类型 (chat_session.related_type, system_message.related_type)
- `LOST_FOUND` - 失物招领
- `GOODS` - 商品
- `TASK` - 跑腿任务
- `CHAT` - 聊天

---

## 数据库操作规范

### 逻辑删除
- 所有表统一使用 `delete_flag` 字段进行逻辑删除
- `0` - 未删除
- `1` - 已删除
- 查询时自动过滤 `delete_flag = 0` 的数据

### 时间字段
- `create_time` - 创建时间，使用 `DEFAULT CURRENT_TIMESTAMP`
- `update_time` - 更新时间，使用 `DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP`

### 外键约束
- 建议在应用层维护数据完整性
- 数据库层面可根据需要添加外键约束

### 索引使用
- 主键自动创建索引
- 外键字段建议创建索引
- 经常用于查询条件的字段创建索引
- 唯一字段创建唯一索引

---

## 数据统计

### 当前数据量（示例查询）

```sql
-- 用户总数
SELECT COUNT(*) FROM user WHERE delete_flag = 0;

-- 失物招领总数
SELECT COUNT(*) FROM lost_found WHERE delete_flag = 0;

-- 聊天会话总数
SELECT COUNT(*) FROM chat_session WHERE delete_flag = 0;

-- 聊天消息总数（已清空）
SELECT COUNT(*) FROM chat_message WHERE delete_flag = 0;

-- 系统消息总数
SELECT COUNT(*) FROM system_message WHERE delete_flag = 0;

-- 认领记录总数
SELECT COUNT(*) FROM claim_record WHERE delete_flag = 0;
```

---

## 数据库维护

### 备份
```bash
mysqldump -u root -p campus_help > campus_help_backup.sql
```

### 恢复
```bash
mysql -u root -p campus_help < campus_help_backup.sql
```

### 清理聊天记录
```sql
-- 逻辑删除所有聊天消息
UPDATE chat_message SET delete_flag = 1, update_time = NOW();

-- 物理删除所有聊天消息（谨慎使用）
TRUNCATE TABLE chat_message;
```

---

## 注意事项

1. **字符集**: 统一使用 `utf8mb4`，支持 emoji 等特殊字符
2. **存储引擎**: 统一使用 `InnoDB`，支持事务和外键
3. **逻辑删除**: 所有删除操作使用逻辑删除，保证数据可追溯
4. **时间字段**: 使用 `DATETIME` 类型，自动管理创建和更新时间
5. **JSON字段**: 使用 `TEXT` 类型存储 JSON 数据，在应用层解析
6. **索引优化**: 根据实际查询场景优化索引，避免过多索引影响写入性能

---

## 更新记录

- **2025-12-04**: 清空 `chat_message` 表所有聊天记录
- **2025-12-04**: 生成数据库说明文档

