# 跑腿模块功能设计文档

**文档版本：** v1.0  
**创建日期：** 2024-12-05  
**文档维护：** 开发团队

---

## 一、模块概述

### 1.1 功能定位

跑腿模块是校园互助系统的核心功能之一，参考**美团跑腿**的业务模式，为校园用户提供便捷的跑腿服务。用户可以通过平台发布跑腿任务（代取快递、代买物品、代送物品等），其他用户可以选择接单完成任务并获得报酬。

### 1.2 核心特性

- ✅ **任务发布**：用户可发布各类跑腿任务，设置报酬、地点、时间等
- ✅ **任务接单**：实名认证用户可接单，使用乐观锁防止并发冲突
- ✅ **状态流转**：完整的任务状态管理（待审核→待接单→已接单→进行中→待确认→已完成）
- ✅ **聊天集成**：任务接单后自动创建聊天会话，支持实时沟通
- ✅ **任务卡片**：在聊天页面显示任务信息卡片，方便查看和操作
- ✅ **完成凭证**：接单用户可上传完成凭证（图片），发布者确认完成
- ✅ **智能审核**：发布任务时自动进行敏感词检测和智能审核

---

## 二、功能详细设计

### 2.1 任务类型

**支持的任务类型：**

| 类型代码 | 类型名称 | 说明 | 示例 |
|---------|---------|------|------|
| `PICKUP_EXPRESS` | 代取快递 | 代取快递包裹 | 代取顺丰快递到宿舍 |
| `BUY_ITEM` | 代买物品 | 代买指定物品 | 代买一杯奶茶到图书馆 |
| `DELIVER_ITEM` | 代送物品 | 代送物品到指定地点 | 代送文件到行政楼 |
| `QUEUE` | 代排队 | 代排队办事 | 代排队取号 |
| `OTHER` | 其他 | 其他跑腿需求 | 其他自定义需求 |

### 2.2 任务状态流转

**完整的状态流转图：**

```
发布任务
    ↓
PENDING_REVIEW (待审核)
    ↓ (审核通过)
PENDING_ACCEPT (待接单)
    ↓ (用户接单)
ACCEPTED (已接单)
    ↓ (接单用户开始任务)
IN_PROGRESS (进行中)
    ↓ (接单用户上传完成凭证)
PENDING_CONFIRM (待确认)
    ↓ (发布者确认完成)
COMPLETED (已完成)
```

**状态说明：**

| 状态代码 | 状态名称 | 说明 | 可执行操作 |
|---------|---------|------|-----------|
| `PENDING_REVIEW` | 待审核 | 任务发布后等待管理员审核 | 管理员审核、用户取消 |
| `PENDING_ACCEPT` | 待接单 | 审核通过，等待用户接单 | 用户接单、发布者取消 |
| `ACCEPTED` | 已接单 | 已有用户接单，等待开始 | 接单用户开始任务、双方取消 |
| `IN_PROGRESS` | 进行中 | 接单用户正在执行任务 | 接单用户上传完成凭证 |
| `PENDING_CONFIRM` | 待确认 | 接单用户已上传完成凭证，等待发布者确认 | 发布者确认完成、发布者拒绝 |
| `COMPLETED` | 已完成 | 任务已完成，报酬已支付 | 双方评价（可选） |
| `CANCELLED` | 已取消 | 任务被取消 | 无 |
| `REJECTED` | 已拒绝 | 审核被拒绝 | 无 |
| `ADMIN_OFFSHELF` | 已下架 | 管理员下架 | 无 |

**状态流转规则：**

1. **发布任务** → `PENDING_REVIEW`
   - 发布任务后自动进入待审核状态
   - 触发智能审核（敏感词检测、发布频率检测、新用户检测）

2. **审核通过** → `PENDING_ACCEPT`
   - 管理员审核通过或自动审核通过
   - 任务对外可见，可被接单

3. **用户接单** → `ACCEPTED`
   - 使用乐观锁防止并发接单
   - 自动创建聊天会话（`relatedType: "TASK"`, `relatedId: taskId`）
   - 发送系统消息通知发布者

4. **开始任务** → `IN_PROGRESS`
   - 接单用户点击"开始任务"按钮
   - 更新任务状态为进行中
   - 发送系统消息通知发布者

5. **上传完成凭证** → `PENDING_CONFIRM`
   - 接单用户上传完成凭证（图片，最多3张）
   - 更新任务状态为待确认
   - 发送系统消息通知发布者

6. **确认完成** → `COMPLETED`
   - 发布者确认任务完成
   - 系统处理报酬支付（模拟，实际可对接支付系统）
   - 发送系统消息通知接单用户
   - 任务状态更新为已完成

7. **取消任务**
   - 发布者可在 `PENDING_ACCEPT` 状态取消
   - 双方可在 `ACCEPTED` 或 `IN_PROGRESS` 状态取消（需对方同意或系统判定）
   - 取消后状态变为 `CANCELLED`

### 2.3 任务发布功能

#### 2.3.1 发布页面

**路由：** `/task/publish`

**页面布局：**
```
┌─────────────────────────────────────┐
│  发布跑腿任务                        │
├─────────────────────────────────────┤
│  任务类型： [下拉选择]               │
│  任务标题： [输入框]                 │
│  任务描述： [多行文本]               │
│  起始地点： [输入框]                 │
│  目的地：   [输入框]                 │
│  期望完成时间： [日期时间选择器]     │
│  报酬：     [数字输入框] 元          │
│  任务图片： [图片上传，最多3张]      │
│                                    │
│  [发布任务] 按钮                    │
└─────────────────────────────────────┘
```

**表单验证：**
- 任务类型：必填
- 任务标题：必填，长度1-200字符
- 任务描述：必填，长度10-2000字符
- 起始地点：必填，长度1-200字符
- 目的地：必填，长度1-200字符
- 期望完成时间：可选，必须晚于当前时间
- 报酬：必填，范围0.01-9999.99元
- 任务图片：可选，最多3张

**权限验证：**
- 必须完成实名认证
- 未认证用户点击发布按钮，提示"发布跑腿任务需要实名认证"，跳转到实名认证页面

#### 2.3.2 后端接口

**接口：** `POST /api/task/publish`

**请求体：**
```json
{
  "type": "PICKUP_EXPRESS",
  "title": "代取顺丰快递到宿舍",
  "description": "代取顺丰快递，快递单号：SF1234567890，送到3号宿舍楼",
  "startLocation": "顺丰快递点（校门口）",
  "endLocation": "3号宿舍楼",
  "expectedTime": "2024-12-05 18:00:00",
  "reward": 5.00,
  "images": ["image1.jpg", "image2.jpg"]
}
```

**响应：**
```json
{
  "code": 200,
  "message": "发布成功",
  "data": 12345
}
```

**业务逻辑：**
1. 验证用户实名认证状态
2. 验证表单数据
3. 敏感词检测（使用AC自动机）
4. 发布频率检测（同一用户1小时内最多发布3条）
5. 新用户检测（注册7天内为新用户）
6. 智能审核判定：
   - 包含严重敏感词 → 自动拒绝（`REJECTED`）
   - 通过检测且非新用户 → 自动通过（`PENDING_ACCEPT`）
   - 其他情况 → 转人工审核（`PENDING_REVIEW`）
7. 保存任务到数据库
8. 如需人工审核，发送系统消息给所有管理员
9. 返回任务ID

### 2.4 任务列表功能

#### 2.4.1 列表页面

**路由：** `/task/list`

**页面布局：**
```
┌─────────────────────────────────────┐
│  跑腿服务                            │
├─────────────────────────────────────┤
│  [筛选栏]                            │
│  类型：[全部/代取快递/代买物品/...]   │
│  状态：[全部/待接单/进行中/...]      │
│  报酬：[最低-最高]                   │
│  关键词：[搜索框]                    │
│                                    │
│  [任务卡片列表]                     │
│  ┌─────────┐ ┌─────────┐          │
│  │ 任务卡片 │ │ 任务卡片 │          │
│  └─────────┘ └─────────┘          │
│                                    │
│  [分页组件]                         │
└─────────────────────────────────────┘
```

**任务卡片显示内容：**
- 任务类型标签
- 任务标题
- 起始地点 → 目的地（带箭头）
- 期望完成时间
- 报酬金额（突出显示）
- 任务状态标签
- 发布者头像和昵称
- 发布时间
- 操作按钮（查看详情、接单等）

**筛选功能：**
- 按任务类型筛选
- 按任务状态筛选（默认只显示 `PENDING_ACCEPT` 状态）
- 按报酬范围筛选
- 关键词搜索（标题、描述、地点）

**排序功能：**
- 默认：按发布时间倒序
- 按报酬从高到低
- 按期望完成时间（紧急优先）

#### 2.4.2 后端接口

**接口：** `GET /api/task/list`

**查询参数：**
```
type: 任务类型（可选）
status: 任务状态（可选，默认PENDING_ACCEPT）
minReward: 最低报酬（可选）
maxReward: 最高报酬（可选）
keyword: 关键词（可选）
pageNum: 页码（默认1）
pageSize: 每页数量（默认10）
sortBy: 排序方式（latest/reward/urgent）
```

**响应：**
```json
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "records": [
      {
        "id": 12345,
        "type": "PICKUP_EXPRESS",
        "title": "代取顺丰快递到宿舍",
        "startLocation": "顺丰快递点（校门口）",
        "endLocation": "3号宿舍楼",
        "expectedTime": "2024-12-05 18:00:00",
        "reward": 5.00,
        "status": "PENDING_ACCEPT",
        "user": {
          "id": 1001,
          "nickname": "张三",
          "avatar": "avatar.jpg"
        },
        "createTime": "2024-12-05 10:00:00",
        "viewCount": 10
      }
    ],
    "total": 100,
    "current": 1,
    "size": 10
  }
}
```

### 2.5 任务详情功能

#### 2.5.1 详情页面

**路由：** `/task/detail/:id`

**页面布局：**
```
┌─────────────────────────────────────┐
│  [返回] 任务详情                     │
├─────────────────────────────────────┤
│  [任务图片轮播]                     │
│                                    │
│  任务类型：[标签]                   │
│  任务标题：代取顺丰快递到宿舍        │
│  任务状态：[状态标签]               │
│                                    │
│  起始地点：顺丰快递点（校门口）      │
│  目的地：  3号宿舍楼                │
│  期望完成时间：2024-12-05 18:00     │
│  报酬：    ¥5.00                   │
│                                    │
│  任务描述：                         │
│  代取顺丰快递，快递单号：...        │
│                                    │
│  发布者信息：                       │
│  [头像] 张三                        │
│                                    │
│  [操作按钮区域]                     │
│  - 接单（待接单状态，需实名认证）   │
│  - 开始任务（已接单状态，仅接单用户）│
│  - 上传完成凭证（进行中状态，仅接单用户）│
│  - 确认完成（待确认状态，仅发布者） │
│  - 取消任务（双方可取消）           │
└─────────────────────────────────────┘
```

**权限控制：**
- 所有用户可查看任务详情（审核通过的任务）
- 发布者可查看自己发布的任务（包括待审核、已拒绝状态）
- 管理员可查看所有任务

**操作按钮显示规则：**
- **待接单状态（PENDING_ACCEPT）**：
  - 发布者：显示"取消任务"
  - 其他用户（已实名认证）：显示"接单"按钮
  - 其他用户（未实名认证）：显示"接单需要实名认证"提示
- **已接单状态（ACCEPTED）**：
  - 接单用户：显示"开始任务"按钮
  - 发布者：显示"取消任务"按钮
- **进行中状态（IN_PROGRESS）**：
  - 接单用户：显示"上传完成凭证"按钮
  - 发布者：显示"取消任务"按钮
- **待确认状态（PENDING_CONFIRM）**：
  - 发布者：显示"确认完成"和"拒绝完成"按钮
  - 接单用户：显示任务完成凭证预览
- **已完成状态（COMPLETED）**：
  - 双方：显示"查看评价"按钮（如果已评价）

#### 2.5.2 后端接口

**接口：** `GET /api/task/detail/:id`

**响应：**
```json
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "id": 12345,
    "type": "PICKUP_EXPRESS",
    "title": "代取顺丰快递到宿舍",
    "description": "代取顺丰快递，快递单号：SF1234567890，送到3号宿舍楼",
    "startLocation": "顺丰快递点（校门口）",
    "endLocation": "3号宿舍楼",
    "expectedTime": "2024-12-05 18:00:00",
    "reward": 5.00,
    "images": ["image1.jpg", "image2.jpg"],
    "status": "PENDING_ACCEPT",
    "accepterId": null,
    "acceptTime": null,
    "completeTime": null,
    "completionProof": null,
    "user": {
      "id": 1001,
      "nickname": "张三",
      "avatar": "avatar.jpg"
    },
    "accepter": null,
    "createTime": "2024-12-05 10:00:00",
    "viewCount": 10
  }
}
```

**业务逻辑：**
1. 查询任务信息
2. 权限验证（发布者、管理员可查看所有状态，其他用户只能查看审核通过的任务）
3. 增加浏览量（仅审核通过的任务）
4. 填充用户信息（发布者、接单用户）
5. 返回任务详情

### 2.6 接单功能

#### 2.6.1 接单流程

**接单按钮点击流程：**
```
用户点击"接单"按钮
    ↓
验证实名认证（未认证提示并跳转）
    ↓
确认接单对话框
    ↓
提交接单请求
    ↓
使用乐观锁更新任务状态
    ↓
创建聊天会话（relatedType: "TASK", relatedId: taskId）
    ↓
发送系统消息通知发布者
    ↓
跳转到聊天页面（自动打开任务会话）
```

#### 2.6.2 后端接口

**接口：** `POST /api/task/:id/accept`

**响应：**
```json
{
  "code": 200,
  "message": "接单成功",
  "data": {
    "taskId": 12345,
    "sessionId": 67890
  }
}
```

**业务逻辑：**
1. 验证用户实名认证状态
2. 查询任务信息
3. 验证任务状态（必须是 `PENDING_ACCEPT`）
4. 验证不能接自己的任务
5. 使用乐观锁更新任务状态（防止并发接单）
6. 更新任务信息（`accepterId`、`acceptTime`）
7. 创建或获取聊天会话（`ChatSessionService.createSession`）
8. 发送系统消息通知发布者
9. 返回任务ID和会话ID

**乐观锁实现：**
```java
@Update("UPDATE errand_task SET status = #{newStatus}, accepter_id = #{accepterId}, " +
        "accept_time = NOW(), version = version + 1 " +
        "WHERE id = #{taskId} AND status = #{oldStatus} AND version = #{version}")
int updateStatusWithVersion(@Param("taskId") Long taskId, 
                           @Param("oldStatus") String oldStatus,
                           @Param("newStatus") String newStatus,
                           @Param("accepterId") Long accepterId,
                           @Param("version") Integer version);
```

### 2.7 任务状态操作

#### 2.7.1 开始任务

**接口：** `POST /api/task/:id/start`

**权限：** 仅接单用户可操作

**业务逻辑：**
1. 验证用户是接单用户
2. 验证任务状态（必须是 `ACCEPTED`）
3. 更新任务状态为 `IN_PROGRESS`
4. 发送系统消息通知发布者

#### 2.7.2 上传完成凭证

**接口：** `POST /api/task/:id/complete`

**请求体：**
```json
{
  "completionProof": ["proof1.jpg", "proof2.jpg"]
}
```

**权限：** 仅接单用户可操作

**业务逻辑：**
1. 验证用户是接单用户
2. 验证任务状态（必须是 `IN_PROGRESS`）
3. 验证完成凭证（至少1张图片，最多3张）
4. 更新任务状态为 `PENDING_CONFIRM`
5. 保存完成凭证
6. 发送系统消息通知发布者

#### 2.7.3 确认完成

**接口：** `POST /api/task/:id/confirm`

**权限：** 仅发布者可操作

**业务逻辑：**
1. 验证用户是发布者
2. 验证任务状态（必须是 `PENDING_CONFIRM`）
3. 更新任务状态为 `COMPLETED`
4. 记录完成时间
5. 处理报酬支付（模拟，实际可对接支付系统）
6. 发送系统消息通知接单用户

#### 2.7.4 拒绝完成

**接口：** `POST /api/task/:id/reject-completion`

**请求体：**
```json
{
  "reason": "完成凭证不符合要求"
}
```

**权限：** 仅发布者可操作

**业务逻辑：**
1. 验证用户是发布者
2. 验证任务状态（必须是 `PENDING_CONFIRM`）
3. 更新任务状态为 `IN_PROGRESS`（退回进行中状态）
4. 清空完成凭证
5. 发送系统消息通知接单用户（包含拒绝原因）

#### 2.7.5 取消任务

**接口：** `POST /api/task/:id/cancel`

**请求体：**
```json
{
  "reason": "取消原因（可选）"
}
```

**权限：** 发布者或接单用户可操作

**业务逻辑：**
1. 验证用户是发布者或接单用户
2. 验证任务状态（`PENDING_ACCEPT`、`ACCEPTED`、`IN_PROGRESS` 可取消）
3. 更新任务状态为 `CANCELLED`
4. 发送系统消息通知对方用户
5. 如果已接单，可能需要处理违约金（可选功能）

### 2.8 聊天页面集成

#### 2.8.1 任务卡片组件

**组件位置：** `campus-help-web/src/views/chat/components/TaskCard.vue`

**显示时机：**
- 当聊天会话的 `relatedType` 为 `"TASK"` 时
- 且存在关联的任务ID（`relatedId`）

**卡片布局：**
```
┌─────────────────────────────────────┐
│  跑腿任务                            │
├─────────────────────────────────────┤
│  任务类型：[标签]                   │
│  任务标题：代取顺丰快递到宿舍        │
│                                    │
│  起始地点：顺丰快递点（校门口）      │
│  目的地：  3号宿舍楼                │
│  期望完成时间：2024-12-05 18:00     │
│  报酬：    ¥5.00                   │
│                                    │
│  任务状态：[状态标签]               │
│                                    │
│  [操作按钮区域]                     │
│  - 开始任务（已接单状态，仅接单用户）│
│  - 上传完成凭证（进行中状态，仅接单用户）│
│  - 确认完成（待确认状态，仅发布者） │
│  - 拒绝完成（待确认状态，仅发布者） │
│  - 查看详情（跳转到任务详情页）     │
└─────────────────────────────────────┘
```

**操作按钮显示规则：**
- **已接单状态（ACCEPTED）**：
  - 接单用户：显示"开始任务"按钮
  - 发布者：显示任务信息（只读）
- **进行中状态（IN_PROGRESS）**：
  - 接单用户：显示"上传完成凭证"按钮
  - 发布者：显示任务信息（只读）
- **待确认状态（PENDING_CONFIRM）**：
  - 发布者：显示"确认完成"和"拒绝完成"按钮，显示完成凭证预览
  - 接单用户：显示任务信息和完成凭证（只读）
- **已完成状态（COMPLETED）**：
  - 双方：显示任务信息（只读），显示"查看详情"按钮

#### 2.8.2 聊天页面集成

**修改文件：** `campus-help-web/src/views/chat/Chat.vue`

**集成方式：**
```vue
<template>
  <div class="chat-window">
    <!-- 聊天窗口头部 -->
    <div class="chat-header">...</div>

    <!-- 任务卡片（仅在TASK类型会话且存在任务时显示） -->
    <div v-if="currentTask" class="task-card-wrapper">
      <TaskCard 
        :task="currentTask" 
        :is-publisher="isPublisher"
        :is-accepter="isAccepter"
        @update-task="handleTaskUpdate"
      />
    </div>

    <!-- 消息列表 -->
    <div class="messages-container">...</div>
    
    <!-- 输入框 -->
    <div class="chat-input-area">...</div>
  </div>
</template>

<script setup>
import TaskCard from './components/TaskCard.vue'
import { taskApi } from '@/api'

// 当前任务
const currentTask = ref(null)

// 判断用户角色
const isPublisher = computed(() => {
  if (!currentTask.value || !userStore.userInfo) return false
  return currentTask.value.userId === userStore.userInfo.id
})

const isAccepter = computed(() => {
  if (!currentTask.value || !userStore.userInfo) return false
  return currentTask.value.accepterId === userStore.userInfo.id
})

// 根据会话ID获取任务信息
const fetchTaskBySessionId = async (sessionId) => {
  if (!sessionId) {
    currentTask.value = null
    return
  }
  
  try {
    const response = await taskApi.getBySessionId(sessionId)
    if (response.code === 200 && response.data) {
      currentTask.value = response.data
    } else {
      currentTask.value = null
    }
  } catch (error) {
    currentTask.value = null
  }
}

// 处理任务更新
const handleTaskUpdate = () => {
  if (currentSessionId.value) {
    fetchTaskBySessionId(currentSessionId.value)
  }
}

// 监听会话变化
watch(currentSessionId, (newId, oldId) => {
  if (newId && newId !== oldId) {
    const session = sessions.value.find(s => s.id === newId)
    if (session && session.relatedType === 'TASK') {
      fetchTaskBySessionId(newId)
    } else {
      currentTask.value = null
    }
  }
})
</script>
```

#### 2.8.3 后端接口

**接口：** `GET /api/task/session/:sessionId`

**功能：** 根据会话ID获取关联的任务信息

**响应：**
```json
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "id": 12345,
    "type": "PICKUP_EXPRESS",
    "title": "代取顺丰快递到宿舍",
    "description": "代取顺丰快递，快递单号：SF1234567890",
    "startLocation": "顺丰快递点（校门口）",
    "endLocation": "3号宿舍楼",
    "expectedTime": "2024-12-05 18:00:00",
    "reward": 5.00,
    "images": ["image1.jpg"],
    "status": "IN_PROGRESS",
    "userId": 1001,
    "accepterId": 1002,
    "acceptTime": "2024-12-05 11:00:00",
    "completionProof": null,
    "user": {
      "id": 1001,
      "nickname": "张三",
      "avatar": "avatar.jpg"
    },
    "accepter": {
      "id": 1002,
      "nickname": "李四",
      "avatar": "avatar2.jpg"
    }
  }
}
```

**业务逻辑：**
1. 根据会话ID查询会话信息
2. 验证会话的 `relatedType` 为 `"TASK"`
3. 根据 `relatedId` 查询任务信息
4. 权限验证（只有会话的双方用户可查看）
5. 填充用户信息（发布者、接单用户）
6. 返回任务信息

### 2.9 我的发布/我的接单

#### 2.9.1 我的发布

**路由：** `/user/tasks/published`

**功能：** 显示当前用户发布的所有任务

**筛选：** 按任务状态筛选（全部/待审核/待接单/进行中/已完成/已取消）

#### 2.9.2 我的接单

**路由：** `/user/tasks/accepted`

**功能：** 显示当前用户接单的所有任务

**筛选：** 按任务状态筛选（全部/已接单/进行中/待确认/已完成/已取消）

#### 2.9.3 后端接口

**接口：** `GET /api/task/my/published` 和 `GET /api/task/my/accepted`

**查询参数：**
```
status: 任务状态（可选）
pageNum: 页码
pageSize: 每页数量
```

---

## 三、数据库设计

### 3.1 跑腿任务表（errand_task）

**表结构：**
```sql
CREATE TABLE `errand_task` (
  `id` BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT '任务ID',
  `user_id` BIGINT(20) NOT NULL COMMENT '发布者ID',
  `title` VARCHAR(200) NOT NULL COMMENT '任务标题',
  `type` VARCHAR(50) NOT NULL COMMENT '任务类型：PICKUP_EXPRESS-代取快递，BUY_ITEM-代买物品，DELIVER_ITEM-代送物品，QUEUE-代排队，OTHER-其他',
  `description` TEXT NOT NULL COMMENT '任务描述',
  `start_location` VARCHAR(200) NOT NULL COMMENT '起始地点',
  `end_location` VARCHAR(200) NOT NULL COMMENT '目的地',
  `expected_time` DATETIME DEFAULT NULL COMMENT '期望完成时间',
  `reward` DECIMAL(10, 2) NOT NULL COMMENT '报酬',
  `images` TEXT DEFAULT NULL COMMENT '任务图片（JSON数组，最多3张）',
  
  -- 状态字段
  `status` VARCHAR(20) DEFAULT 'PENDING_REVIEW' COMMENT '状态：PENDING_REVIEW-待审核，PENDING_ACCEPT-待接单，ACCEPTED-已接单，IN_PROGRESS-进行中，PENDING_CONFIRM-待确认，COMPLETED-已完成，CANCELLED-已取消，REJECTED-已拒绝，ADMIN_OFFSHELF-已下架',
  
  -- 审核字段
  `audit_status` VARCHAR(20) DEFAULT 'PENDING' COMMENT '审核状态：PENDING-待审核，APPROVED-已通过，REJECTED-已拒绝',
  `audit_reason` VARCHAR(500) DEFAULT NULL COMMENT '审核拒绝原因',
  `audit_time` DATETIME DEFAULT NULL COMMENT '审核时间',
  `audit_admin_id` BIGINT(20) DEFAULT NULL COMMENT '审核管理员ID',
  `audit_trigger_reason` VARCHAR(500) DEFAULT NULL COMMENT '触发人工审核原因',
  
  -- 下架字段
  `offshelf_type` VARCHAR(20) DEFAULT NULL COMMENT '下架类型',
  `offshelf_reason` VARCHAR(500) DEFAULT NULL COMMENT '下架原因',
  `offshelf_time` DATETIME DEFAULT NULL COMMENT '下架时间',
  `offshelf_admin_id` BIGINT(20) DEFAULT NULL COMMENT '下架管理员ID',
  
  -- 接单信息
  `accepter_id` BIGINT(20) DEFAULT NULL COMMENT '接单用户ID',
  `accept_time` DATETIME DEFAULT NULL COMMENT '接单时间',
  `complete_time` DATETIME DEFAULT NULL COMMENT '完成时间',
  `completion_proof` TEXT DEFAULT NULL COMMENT '完成凭证（图片JSON数组，最多3张）',
  
  -- 统计字段
  `view_count` INT(11) DEFAULT 0 COMMENT '浏览次数',
  `favorite_count` INT(11) DEFAULT 0 COMMENT '收藏次数',
  `comment_count` INT(11) DEFAULT 0 COMMENT '评论次数',
  
  -- 并发控制
  `version` INT(11) DEFAULT 0 COMMENT '乐观锁版本号',
  
  -- 系统字段
  `delete_flag` TINYINT(1) DEFAULT 0 COMMENT '逻辑删除：0-未删除，1-已删除',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '发布时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_type` (`type`),
  KEY `idx_status` (`status`),
  KEY `idx_audit_status` (`audit_status`),
  KEY `idx_accepter_id` (`accepter_id`),
  KEY `idx_reward` (`reward`),
  KEY `idx_view_count` (`view_count`),
  KEY `idx_status_reward` (`status`, `reward` DESC),
  KEY `idx_status_create_time` (`status`, `create_time` DESC),
  KEY `idx_create_time` (`create_time`),
  CONSTRAINT `fk_errand_task_user` FOREIGN KEY (`user_id`) REFERENCES `user` (`id`),
  CONSTRAINT `fk_errand_task_accepter` FOREIGN KEY (`accepter_id`) REFERENCES `user` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='跑腿任务表';
```

### 3.2 聊天会话表扩展

**需要确保 `chat_session` 表包含以下字段：**
- `related_type`：关联类型（`GOODS`、`TASK`、`LOST_FOUND` 等）
- `related_id`：关联ID（商品ID、任务ID等）

---

## 四、状态流转详细说明

### 4.1 状态流转图

```
                   发布任务
                      ↓
            ┌─────────────────┐
            │  PENDING_REVIEW │ 待审核
            └────────┬────────┘
                     │
         ┌───────────┴───────────┐
         │                       │
   审核通过                  审核拒绝
         │                       │
         ↓                       ↓
┌─────────────────┐    ┌─────────────────┐
│ PENDING_ACCEPT  │    │    REJECTED     │ 已拒绝
│   待接单        │    └─────────────────┘
└────────┬────────┘
         │
    用户接单
         │
         ↓
┌─────────────────┐
│    ACCEPTED     │ 已接单
│                 │
└────────┬────────┘
         │
   开始任务
         │
         ↓
┌─────────────────┐
│  IN_PROGRESS    │ 进行中
│                 │
└────────┬────────┘
         │
  上传完成凭证
         │
         ↓
┌─────────────────┐
│ PENDING_CONFIRM │ 待确认
│                 │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
确认完成   拒绝完成
    │         │
    ↓         ↓
┌─────────┐ ┌─────────┐
│COMPLETED│ │IN_PROGRESS│ 退回进行中
│已完成   │ └─────────┘
└─────────┘
```

### 4.2 状态操作权限表

| 状态 | 发布者可操作 | 接单用户可操作 | 管理员可操作 |
|------|------------|--------------|------------|
| `PENDING_REVIEW` | 取消任务 | - | 审核通过/拒绝 |
| `PENDING_ACCEPT` | 取消任务 | 接单 | 下架 |
| `ACCEPTED` | 取消任务 | 开始任务、取消任务 | 下架 |
| `IN_PROGRESS` | 取消任务 | 上传完成凭证、取消任务 | 下架 |
| `PENDING_CONFIRM` | 确认完成、拒绝完成 | 查看完成凭证 | 下架 |
| `COMPLETED` | 查看详情 | 查看详情 | 查看详情 |
| `CANCELLED` | 查看详情 | 查看详情 | 查看详情 |
| `REJECTED` | 查看详情、重新发布 | - | 查看详情 |
| `ADMIN_OFFSHELF` | 查看详情 | 查看详情 | 查看详情 |

### 4.3 状态变更触发事件

| 状态变更 | 触发事件 | 接收者 |
|---------|---------|--------|
| `PENDING_REVIEW` → `PENDING_ACCEPT` | 审核通过 | 发布者 |
| `PENDING_REVIEW` → `REJECTED` | 审核拒绝 | 发布者 |
| `PENDING_ACCEPT` → `ACCEPTED` | 任务被接单 | 发布者 |
| `ACCEPTED` → `IN_PROGRESS` | 任务开始 | 发布者 |
| `IN_PROGRESS` → `PENDING_CONFIRM` | 完成凭证已上传 | 发布者 |
| `PENDING_CONFIRM` → `COMPLETED` | 任务已完成 | 接单用户 |
| `PENDING_CONFIRM` → `IN_PROGRESS` | 完成被拒绝 | 接单用户 |
| 任何状态 → `CANCELLED` | 任务被取消 | 对方用户 |

---

## 五、API接口清单

### 5.1 任务管理接口

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 发布任务 | POST | `/api/task/publish` | 发布跑腿任务（需实名认证） |
| 任务列表 | GET | `/api/task/list` | 获取任务列表（支持筛选、排序、分页） |
| 任务详情 | GET | `/api/task/detail/:id` | 获取任务详情 |
| 接单 | POST | `/api/task/:id/accept` | 接单（需实名认证，使用乐观锁） |
| 开始任务 | POST | `/api/task/:id/start` | 开始任务（仅接单用户） |
| 上传完成凭证 | POST | `/api/task/:id/complete` | 上传完成凭证（仅接单用户） |
| 确认完成 | POST | `/api/task/:id/confirm` | 确认完成（仅发布者） |
| 拒绝完成 | POST | `/api/task/:id/reject-completion` | 拒绝完成（仅发布者） |
| 取消任务 | POST | `/api/task/:id/cancel` | 取消任务（发布者或接单用户） |
| 我的发布 | GET | `/api/task/my/published` | 获取我发布的任务列表 |
| 我的接单 | GET | `/api/task/my/accepted` | 获取我接单的任务列表 |
| 根据会话ID获取任务 | GET | `/api/task/session/:sessionId` | 根据聊天会话ID获取关联任务 |

### 5.2 管理员接口

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 待审核任务列表 | GET | `/api/admin/task/pending` | 获取待审核任务列表 |
| 审核任务 | POST | `/api/admin/task/:id/audit` | 审核任务（通过/拒绝） |

---

## 六、前端页面清单

### 6.1 用户页面

| 页面 | 路由 | 说明 |
|------|------|------|
| 任务列表 | `/task/list` | 浏览和搜索任务 |
| 任务详情 | `/task/detail/:id` | 查看任务详情 |
| 发布任务 | `/task/publish` | 发布新任务 |
| 编辑任务 | `/task/edit/:id` | 编辑任务（仅发布者，仅待审核/已拒绝状态） |
| 我的发布 | `/user/tasks/published` | 我发布的任务 |
| 我的接单 | `/user/tasks/accepted` | 我接单的任务 |

### 6.2 聊天页面集成

| 组件 | 位置 | 说明 |
|------|------|------|
| TaskCard | `views/chat/components/TaskCard.vue` | 任务信息卡片组件 |
| Chat页面修改 | `views/chat/Chat.vue` | 集成任务卡片显示和操作 |

### 6.3 管理员页面

| 页面 | 路由 | 说明 |
|------|------|------|
| 任务审核 | `/admin/task-audit` | 审核跑腿任务 |

---

## 七、开发注意事项

### 7.1 并发控制

- **接单操作**：必须使用乐观锁（`version` 字段）防止并发接单
- **状态更新**：所有状态变更操作都应验证当前状态，防止状态错乱

### 7.2 权限验证

- **发布任务**：必须完成实名认证
- **接单**：必须完成实名认证
- **任务操作**：验证用户身份（发布者或接单用户）
- **查看详情**：发布者可查看自己的所有任务，其他用户只能查看审核通过的任务

### 7.3 聊天集成

- **自动创建会话**：接单成功后自动创建聊天会话
- **任务卡片显示**：在聊天页面根据会话的 `relatedType` 和 `relatedId` 显示任务卡片
- **实时更新**：任务状态变更时，通过WebSocket推送更新到聊天页面

### 7.4 智能审核

- **敏感词检测**：使用AC自动机进行敏感词检测
- **发布频率限制**：同一用户1小时内最多发布3条任务
- **新用户检测**：注册7天内为新用户，需要人工审核
- **自动审核规则**：
  - 包含严重敏感词 → 自动拒绝
  - 通过检测且非新用户 → 自动通过
  - 其他情况 → 转人工审核

### 7.5 系统消息

- **接单通知**：任务被接单时通知发布者
- **状态变更通知**：任务状态变更时通知相关用户
- **完成通知**：任务完成时通知接单用户

---

## 八、后续整合说明

本文档设计完成后，将整合到 `功能开发需求文档.md` 的 **2.4 跑腿服务模块** 章节，替换原有的简化版需求，提供更详细的功能设计和实现指导。

**整合位置：** `doc/功能开发需求文档.md` 第 3058 行开始

**整合方式：**
1. 保留原有的数据库表设计（3.5节）
2. 替换 2.4 节的功能设计内容
3. 补充状态流转图和详细说明
4. 补充聊天页面集成方案

---

**文档结束**

